# Milestone Context

**Generated:** 2026-01-09
**Status:** Ready for /gsd:new-milestone

<features>
## Features to Build

- **WebSocket Client Refactor**: Frontend connects as WebSocket CLIENT to backend (ws://localhost:8765) instead of running its own server. Remove any server code, implement client connection.

- **Data Feed Implementation**: Frontend sends market data feeds to backend:
  - `market_data_feed` — TokenMarketData from existing NATS subscriptions
  - `ohlcv_update` — OHLCV data when available
  - `trade_feed` — Trade data from NATS
  - `cvd_update` — CVD data (already computed for Vz indicator)

- **Full Command Suite**: All commands sent to backend:
  - Source toggles: `toggle_sources`, `toggle_trending`, `toggle_whales`, `toggle_filter`
  - Trading: `set_mode`, `set_position_size`, `close_position`, `close_all_positions`
  - Strategy: `get_strategies`, `toggle_strategy`
  - Config: `get_config`, `refresh_sources`

- **Event Handling**: Backend events update UI via direct store updates (current pattern, extract handlers for testability):
  - `signal` — Rule signals, magic buy/exit, dump exit
  - `position_update` — Open positions
  - `market_status` — SOL dump protection state
  - `stats_update` — Trading statistics
  - `scan_tick` — Heartbeat/liveness
  - `token_list` — Watched tokens by source
  - `config` — Current configuration
  - `strategies` — Available/active strategies
  - `last_analysis` — Most recent token analysis result

- **Auto-Start Preservation**: Keep Vite plugin that auto-starts CLI backend with dev server

</features>

<scope>
## Scope

**Suggested name:** v2.0 Backend Integration
**Estimated phases:** 3-4
**Focus:** Reverse WebSocket architecture — frontend becomes client, sends data feeds, receives events

</scope>

<phase_mapping>
## Phase Mapping

- Phase 23: WebSocket Client Refactor — Remove server code, implement client connection to ws://localhost:8765
- Phase 24: Data Feed Implementation — Forward market_data, ohlcv, trade, cvd from NATS/Discovery to backend
- Phase 25: Command & Event Protocol — Full command suite + event handlers extracted for testability
- Phase 26: Integration Testing — End-to-end validation with CLI backend

</phase_mapping>

<constraints>
## Constraints

- Backend CLI started separately with `npm run cli run` OR auto-started via Vite plugin
- Use direct store updates pattern (not adapter layer) — extract handlers into functions
- CVD data already computed (Vz indicator) — forward existing calculations
- Market data sources: NATS for prices, Discovery WebSocket for trending/whales

</constraints>

<notes>
## Additional Context

**Architecture Change:**
The token-analysis-autopilot backend now runs its own WebSocket server on port 8765 for signal broadcasting. The frontend transitions from being a WebSocket server to being a WebSocket client.

**Data Flow:**
```
Frontend NATS/Discovery subscriptions
         ↓
    Transform/Forward
         ↓
  Backend CLI (ws://localhost:8765)
         ↓
     Signal Processing
         ↓
  Events back to Frontend
         ↓
    Direct Store Updates
```

**Event Handler Pattern (to implement):**
```typescript
// handlers/autopilot-event-handlers.ts
export const handlePositionUpdate = (store, positions) => { ... }
export const handleSignal = (store, signal) => { ... }
export const handleMarketStatus = (store, status) => { ... }
// Called from switch statement in connection handler
```

</notes>

---

*This file is temporary. It will be deleted after /gsd:new-milestone creates the milestone.*
