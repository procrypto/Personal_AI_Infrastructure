/**
 * API Client for web-terminal data
 *
 * Supports both:
 * - Local API (localhost:8787) - for development with prod ClickHouse data
 * - Beta Data API (beta-data.bonkbot.io) - for beta environment
 */

import type { TokenMarketData, OHLCV, Trade, Resolution, DiscoveryTrendingItem, WhaleMovesItem, WhaleMovesResponse } from './types.js';

export interface ApiClientConfig {
  baseUrl: string;
  timeout?: number;
}

export class ApiClient {
  private baseUrl: string;
  private timeout: number;

  constructor(config: ApiClientConfig) {
    this.baseUrl = config.baseUrl.replace(/\/$/, '');
    this.timeout = config.timeout ?? 30000;
  }

  private async fetch<T>(path: string, options?: RequestInit): Promise<T> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), this.timeout);

    try {
      const response = await fetch(`${this.baseUrl}${path}`, {
        ...options,
        signal: controller.signal,
        headers: {
          'Content-Type': 'application/json',
          ...options?.headers,
        },
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status} ${response.statusText}`);
      }

      return response.json() as Promise<T>;
    } finally {
      clearTimeout(timeoutId);
    }
  }

  /**
   * Get market data for a single token
   */
  async getMarketData(mint: string): Promise<TokenMarketData> {
    const response = await this.fetch<{ ok: boolean; token: TokenMarketData }>(`/local-api/market_data/${mint}`);
    return response.token;
  }

  /**
   * Get market data for multiple tokens
   */
  async getMarketDataBatch(mints: string[]): Promise<TokenMarketData[]> {
    const query = mints.map(m => `mint=${m}`).join('&');
    return this.fetch<TokenMarketData[]>(`/local-api/market_data_batch?${query}`);
  }

  /**
   * Get OHLCV candlestick data for a token
   */
  async getOHLCV(mint: string, resolution: Resolution, options?: {
    startDate?: number;
    countback?: number;
  }): Promise<OHLCV[]> {
    let path = `/local-api/ohlcv/token/${mint}/${resolution}`;
    const params = new URLSearchParams();

    if (options?.startDate) params.set('start_date', options.startDate.toString());
    if (options?.countback) params.set('countback', options.countback.toString());

    if (params.toString()) path += `?${params}`;

    return this.fetch<OHLCV[]>(path);
  }

  /**
   * Get recent trades for a token
   */
  async getTrades(mint: string, limit = 100): Promise<Trade[]> {
    return this.fetch<Trade[]>(`/local-api/trades/${mint}?limit=${limit}`);
  }

  /**
   * Get holder statistics for a token
   */
  async getHoldersStats(mint: string): Promise<any> {
    return this.fetch(`/local-api/holders_stats/${mint}`);
  }

  /**
   * Get whale moves - tokens being traded by whale wallets
   */
  async getWhaleMoves(): Promise<WhaleMovesItem[]> {
    const response = await this.fetch<WhaleMovesResponse>('/local-api/discovery/whale_moves');
    return response.data ?? [];
  }

  /**
   * Get trending tokens
   */
  async getTrending(limit = 20): Promise<DiscoveryTrendingItem[]> {
    return this.fetch<DiscoveryTrendingItem[]>(`/local-api/discovery/trending?limit=${limit}`);
  }

  /**
   * Search for tokens by text
   */
  async searchTokens(query: string): Promise<any[]> {
    return this.fetch(`/local-api/search?text=${encodeURIComponent(query)}`);
  }

  /**
   * Health check
   */
  async healthCheck(): Promise<{ ok: boolean }> {
    return this.fetch('/health');
  }
}

// Default client pointing to local-api
export const localApi = new ApiClient({
  baseUrl: 'http://localhost:8787',
});

// Beta data API client
export const betaApi = new ApiClient({
  baseUrl: 'https://beta-data.bonkbot.io/data',
});
