/**
 * Token Analysis Autopilot
 *
 * Configurable analysis rules that trigger automated trades via LOIS.
 *
 * Day 1: Foundation + AI Integration Proof
 * - Connect to trading terminal API
 * - Build first analysis rule (price pattern detection)
 * - Test: given token data, does analysis run correctly?
 */

import { localApi } from './api/client.js';
import { RuleEngine } from './rules/engine.js';
import { createPriceChangeRule } from './rules/price-change.js';
import { createVolumeSpikeRule } from './rules/volume-spike.js';

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘  TOKEN ANALYSIS AUTOPILOT                                    â•‘');
  console.log('â•‘  Day 1: Foundation + AI Integration Proof                    â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  // Step 1: Check API connectivity
  console.log('1. Checking API connectivity...');
  try {
    await localApi.healthCheck();
    console.log('   âœ“ Local API is healthy\n');
  } catch (error) {
    console.error('   âœ— Local API not available. Make sure to run: cd local-api && bun dev');
    console.log('   Trying beta API as fallback...\n');
  }

  // Step 2: Set up the rule engine with example rules
  console.log('2. Setting up rule engine...');
  const engine = new RuleEngine({ api: localApi });

  // Add price change rules
  engine.addRule(createPriceChangeRule('price-pump-5m', 'Price Pump (5m)', {
    timeframe: '5m',
    threshold: 5, // 5% change
    direction: 'up',
    type: 'buy',
  }));

  engine.addRule(createPriceChangeRule('price-dump-5m', 'Price Dump (5m)', {
    timeframe: '5m',
    threshold: 5,
    direction: 'down',
    type: 'sell',
  }));

  engine.addRule(createPriceChangeRule('price-pump-1h', 'Price Pump (1h)', {
    timeframe: '1h',
    threshold: 10, // 10% change in 1h
    direction: 'up',
    type: 'buy',
  }));

  // Add volume spike rules
  engine.addRule(createVolumeSpikeRule('volume-spike-5m', 'Volume Spike (5m)', {
    timeframe: '5m',
    multiplier: 3, // 3x average volume
    type: 'both',
  }));

  engine.addRule(createVolumeSpikeRule('volume-spike-1h', 'Volume Spike (1h)', {
    timeframe: '1h',
    multiplier: 2, // 2x average volume
    type: 'both',
  }));

  console.log(`   âœ“ Loaded ${engine.getRules().length} rules\n`);

  // Step 3: Test with a real token
  // Using a well-known Solana token for testing
  const testMint = process.argv[2] || 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263'; // BONK

  console.log(`3. Analyzing token: ${testMint}`);
  console.log('   Fetching market data, OHLCV, and trades...\n');

  try {
    const signals = await engine.analyzeToken(testMint);

    if (signals.length === 0) {
      console.log('   No signals triggered (conditions not met)\n');
    } else {
      console.log(`   ${signals.length} signal(s) triggered:\n`);

      for (const signal of signals) {
        const emoji = signal.type === 'buy' ? 'ğŸŸ¢' : signal.type === 'sell' ? 'ğŸ”´' : 'âšª';
        console.log(`   ${emoji} ${signal.ruleName}`);
        console.log(`      Type: ${signal.type.toUpperCase()}`);
        console.log(`      Strength: ${(signal.strength * 100).toFixed(0)}%`);
        console.log(`      Reason: ${signal.reason}`);
        console.log('');
      }

      // Aggregate signals
      const result = engine.aggregateSignals(signals, 'any');
      console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      console.log(`   Final Action: ${result.action.toUpperCase()}`);
      console.log(`   Confidence: ${(result.confidence * 100).toFixed(0)}%`);
    }
  } catch (error) {
    console.error('   âœ— Analysis failed:', error);
    console.log('\n   Make sure the local-api is running: cd local-api && bun dev\n');
  }

  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('Day 1 EOD Check: Can run a basic analysis on a token? âœ“');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
}

main().catch(console.error);
