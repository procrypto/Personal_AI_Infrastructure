/* eslint-disable lingui/no-unlocalized-strings */
import { useState, useEffect, useCallback, useRef } from "react";
import { FormattedNumber } from "@/components/formatted-number/formatted-number";
import { Bot, AlertTriangle, TrendingUp, TrendingDown, Activity, Zap, Target, ShieldAlert, Clock } from "lucide-react";
import { cn } from "@/lib/utils";

// Types matching the backend WebSocket events
interface PositionData {
  mint: string;
  symbol: string;
  action: "buy" | "sell";
  entryPriceSol: number;
  currentPriceSol: number;
  positionSizeSol: number;
  pnlPercent: number;
  pnlSol: number;
  entryTime: number;
}

interface SignalData {
  timestamp: number;
  mint: string;
  symbol: string;
  signalType: "magic_buy" | "magic_exit" | "dump_exit" | "rule_signal";
  action: "buy" | "sell" | "close";
  reason: string;
  pnlPercent?: number;
  entryType?: string;
}

interface MarketStatusData {
  state: "NORMAL" | "CAUTION" | "DUMP";
  solPriceChangePercent: number;
  blockEntries: boolean;
  exitAll: boolean;
}

interface StatsData {
  totalTrades: number;
  openTrades: number;
  closedTrades: number;
  wins: number;
  losses: number;
  winRate: number;
  totalPnlSol: number;
  totalPnlUsd: number;
  avgPnlPercent: number;
}

interface ScanTickData {
  timestamp: number;
  scanNumber: number;
  tokenCount: number;
  openPositions: number;
}

type AutopilotEvent =
  | { type: "position_update"; positions: PositionData[] }
  | { type: "signal"; signal: SignalData }
  | { type: "market_status"; status: MarketStatusData }
  | { type: "stats_update"; stats: StatsData }
  | { type: "scan_tick"; tick: ScanTickData };

// Determine WebSocket URL based on protocol (use proxy for HTTPS)
const getAutopilotWsUrl = () => {
  if (typeof window === "undefined") return "ws://localhost:8765";
  // Use vite proxy when on HTTPS to avoid mixed content
  if (window.location.protocol === "https:") {
    return `wss://${window.location.host}/autopilot-ws`;
  }
  return "ws://localhost:8765";
};

// WebSocket hook for autopilot backend
function useAutopilotWebSocket(wsUrl: string = getAutopilotWsUrl()) {
  const [positions, setPositions] = useState<PositionData[]>([]);
  const [signals, setSignals] = useState<SignalData[]>([]);
  const [marketStatus, setMarketStatus] = useState<MarketStatusData>({
    state: "NORMAL",
    solPriceChangePercent: 0,
    blockEntries: false,
    exitAll: false,
  });
  const [stats, setStats] = useState<StatsData>({
    totalTrades: 0,
    openTrades: 0,
    closedTrades: 0,
    wins: 0,
    losses: 0,
    winRate: 0,
    totalPnlSol: 0,
    totalPnlUsd: 0,
    avgPnlPercent: 0,
  });
  const [scanTick, setScanTick] = useState<ScanTickData | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);

  const connect = useCallback(() => {
    if (wsRef.current?.readyState === WebSocket.OPEN) return;

    try {
      const ws = new WebSocket(wsUrl);
      wsRef.current = ws;

      ws.onopen = () => {
        setIsConnected(true);
        console.log("[Autopilot] WebSocket connected");
      };

      ws.onclose = () => {
        setIsConnected(false);
        console.log("[Autopilot] WebSocket disconnected, reconnecting...");
        // Reconnect after 3 seconds
        reconnectTimeoutRef.current = setTimeout(connect, 3000);
      };

      ws.onerror = (err) => {
        console.error("[Autopilot] WebSocket error:", err);
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data) as AutopilotEvent;

          switch (data.type) {
            case "position_update":
              setPositions(data.positions);
              break;
            case "signal":
              setSignals((prev) => [data.signal, ...prev].slice(0, 50)); // Keep last 50 signals
              break;
            case "market_status":
              setMarketStatus(data.status);
              break;
            case "stats_update":
              setStats(data.stats);
              break;
            case "scan_tick":
              setScanTick(data.tick);
              break;
          }
        } catch (err) {
          console.error("[Autopilot] Failed to parse message:", err);
        }
      };
    } catch (err) {
      console.error("[Autopilot] Failed to connect:", err);
      reconnectTimeoutRef.current = setTimeout(connect, 3000);
    }
  }, [wsUrl]);

  useEffect(() => {
    connect();
    return () => {
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
      }
      wsRef.current?.close();
    };
  }, [connect]);

  return { positions, signals, marketStatus, stats, scanTick, isConnected };
}

// Market Status Badge Component
const MarketStatusBadge = ({ status }: { status: MarketStatusData }) => {
  const stateConfig = {
    NORMAL: { color: "bg-green-500/20 text-green-400 border-green-500/30", icon: Activity, label: "NORMAL" },
    CAUTION: { color: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30", icon: AlertTriangle, label: "CAUTION" },
    DUMP: { color: "bg-red-500/20 text-red-400 border-red-500/30", icon: ShieldAlert, label: "DUMP" },
  };

  const config = stateConfig[status.state];
  const Icon = config.icon;

  return (
    <div className={cn("flex items-center gap-2 rounded-lg border px-3 py-1.5", config.color)}>
      <Icon className="h-4 w-4" />
      <span className="text-xs font-semibold">{config.label}</span>
      <span className="text-xs opacity-75">
        SOL {status.solPriceChangePercent >= 0 ? "+" : ""}
        {status.solPriceChangePercent.toFixed(2)}%
      </span>
    </div>
  );
};

// Position Card Component
const PositionCard = ({ position }: { position: PositionData }) => {
  const isProfit = position.pnlPercent >= 0;
  const holdTime = Math.floor((Date.now() - position.entryTime) / 60000); // minutes

  return (
    <div className="border-border-primary bg-bg-tertiary/50 flex items-center justify-between rounded-lg border p-3">
      <div className="flex items-center gap-3">
        <div
          className={cn(
            "flex h-8 w-8 items-center justify-center rounded-lg text-xs font-bold",
            isProfit ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"
          )}
        >
          {isProfit ? <TrendingUp className="h-4 w-4" /> : <TrendingDown className="h-4 w-4" />}
        </div>
        <div>
          <span className="text-text-primary text-sm font-medium">${position.symbol}</span>
          <div className="text-text-secondary flex items-center gap-1 text-[10px]">
            <Clock className="h-3 w-3" />
            {holdTime}m
          </div>
        </div>
      </div>
      <div className="text-right">
        <div className={cn("text-sm font-semibold", isProfit ? "text-green-400" : "text-red-400")}>
          {isProfit ? "+" : ""}
          {position.pnlPercent.toFixed(2)}%
        </div>
        <div className="text-text-secondary text-[10px]">
          {position.positionSizeSol.toFixed(2)} SOL
        </div>
      </div>
    </div>
  );
};

// Signal Item Component
const SignalItem = ({ signal }: { signal: SignalData }) => {
  const signalConfig = {
    magic_buy: { color: "text-cyan-400", icon: Target, label: "BUY" },
    magic_exit: { color: "text-purple-400", icon: Zap, label: "EXIT" },
    dump_exit: { color: "text-red-400", icon: ShieldAlert, label: "DUMP" },
    rule_signal: { color: "text-blue-400", icon: Activity, label: "SIGNAL" },
  };

  const config = signalConfig[signal.signalType];
  const Icon = config.icon;
  const time = new Date(signal.timestamp).toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });

  return (
    <div className="border-border-primary/50 flex items-center gap-2 border-b py-2 last:border-0">
      <Icon className={cn("h-3.5 w-3.5", config.color)} />
      <span className="text-text-secondary text-[10px]">{time}</span>
      <span className={cn("text-xs font-medium", config.color)}>{config.label}</span>
      <span className="text-text-primary text-xs">${signal.symbol}</span>
      {signal.pnlPercent !== undefined && (
        <span className={cn("text-xs", signal.pnlPercent >= 0 ? "text-green-400" : "text-red-400")}>
          {signal.pnlPercent >= 0 ? "+" : ""}
          {signal.pnlPercent.toFixed(1)}%
        </span>
      )}
    </div>
  );
};

// Stats Panel Component
const StatsPanel = ({ stats }: { stats: StatsData }) => {
  const isProfit = stats.totalPnlSol >= 0;

  return (
    <div className="border-border-primary bg-bg-tertiary/30 grid grid-cols-4 gap-2 rounded-lg border p-3">
      <div className="text-center">
        <div className="text-text-primary text-lg font-bold">{stats.closedTrades}</div>
        <div className="text-text-secondary text-[10px]">Trades</div>
      </div>
      <div className="text-center">
        <div className={cn("text-lg font-bold", stats.winRate >= 0.5 ? "text-green-400" : "text-red-400")}>
          {(stats.winRate * 100).toFixed(0)}%
        </div>
        <div className="text-text-secondary text-[10px]">Win Rate</div>
      </div>
      <div className="text-center">
        <div className="text-text-primary text-lg font-bold">
          {stats.wins}W/{stats.losses}L
        </div>
        <div className="text-text-secondary text-[10px]">Record</div>
      </div>
      <div className="text-center">
        <div className={cn("text-lg font-bold", isProfit ? "text-green-400" : "text-red-400")}>
          {isProfit ? "+" : ""}
          <FormattedNumber value={stats.totalPnlSol} decimals={2} />
        </div>
        <div className="text-text-secondary text-[10px]">P&L (SOL)</div>
      </div>
    </div>
  );
};

// Main Autopilot Widget Component
export const AutopilotWidget = () => {
  const { positions, signals, marketStatus, stats, scanTick, isConnected } = useAutopilotWebSocket();

  return (
    <div className="flex h-full flex-col gap-3 overflow-hidden">
      {/* Header - Market Status */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Bot className={cn("h-5 w-5", isConnected ? "text-green-400" : "text-red-400")} />
          <span className="text-text-primary text-sm font-semibold">Token Autopilot</span>
          {scanTick && (
            <span className="text-text-secondary text-[10px]">
              #{scanTick.scanNumber} | {scanTick.tokenCount} tokens
            </span>
          )}
        </div>
        <MarketStatusBadge status={marketStatus} />
      </div>

      {/* Connection Status (shown when disconnected) */}
      {!isConnected && (
        <div className="bg-yellow-500/10 border-yellow-500/30 flex items-center gap-2 rounded-lg border px-3 py-2">
          <AlertTriangle className="h-4 w-4 text-yellow-400" />
          <span className="text-xs text-yellow-400">Connecting to autopilot backend...</span>
        </div>
      )}

      {/* Stats Panel */}
      <StatsPanel stats={stats} />

      {/* Open Positions */}
      <div className="flex-shrink-0">
        <div className="text-text-secondary mb-2 flex items-center gap-2 text-xs font-medium">
          <Target className="h-3.5 w-3.5" />
          Open Positions ({positions.length})
        </div>
        {positions.length === 0 ? (
          <div className="text-text-secondary border-border-primary/50 rounded-lg border border-dashed p-4 text-center text-xs">
            No open positions
          </div>
        ) : (
          <div className="max-h-40 space-y-2 overflow-auto">
            {positions.map((pos) => (
              <PositionCard key={pos.mint} position={pos} />
            ))}
          </div>
        )}
      </div>

      {/* Signal Feed */}
      <div className="flex min-h-0 flex-1 flex-col">
        <div className="text-text-secondary mb-2 flex items-center gap-2 text-xs font-medium">
          <Zap className="h-3.5 w-3.5" />
          Signal Feed
        </div>
        <div className="flex-1 overflow-auto">
          {signals.length === 0 ? (
            <div className="text-text-secondary border-border-primary/50 rounded-lg border border-dashed p-4 text-center text-xs">
              Waiting for signals...
            </div>
          ) : (
            <div className="space-y-0">
              {signals.slice(0, 10).map((signal, idx) => (
                <SignalItem key={`${signal.timestamp}-${idx}`} signal={signal} />
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default AutopilotWidget;
