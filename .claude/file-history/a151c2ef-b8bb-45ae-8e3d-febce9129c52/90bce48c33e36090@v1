# Milestone Context

**Generated:** 2026-01-08
**Status:** Ready for /gsd:new-milestone

<features>
## Features to Build

- **P&L Calculation Tests**: Unit tests for `useAutopilotPositions` hook - validates price math, handles null/missing market data, edge cases for zero entry prices
- **Store Slice Tests**: Unit tests for `autopilot-store.ts` - verifies state setters work correctly, reset clears all state, signal history respects MAX_SIGNALS limit
- **Message Parsing Tests**: Unit tests for `connectAutopilotWebsocket` message handler - validates all event types parse correctly, unknown events handled gracefully, type safety maintained

</features>

<scope>
## Scope

**Suggested name:** v1.1 Autopilot Unit Tests
**Estimated phases:** 1-2
**Focus:** Essential test coverage for the three highest-value testable areas - no mocking of WebSocket/NATS plumbing

</scope>

<phase_mapping>
## Phase Mapping

- Phase 5: Unit tests for P&L calculation, store slice, and message parsing (all in one phase since scope is focused)

Alternative if splitting:
- Phase 5: P&L calculation tests (highest value - financial correctness)
- Phase 6: Store + message parsing tests (state management + type safety)

</phase_mapping>

<constraints>
## Constraints

- Essential cases only (happy path + key edge cases)
- No mocking WebSocket connections or NATS subscriptions
- No end-to-end tests requiring running backends
- Tests should be fast and reliable

</constraints>

<notes>
## Additional Context

Test framework: Project uses Vitest (from vite.config.ts pattern)

Key test cases to cover:
1. **P&L Calculation:**
   - Normal case: entry price + current price â†’ correct percentage
   - No market data: returns null P&L
   - Zero entry price: handles divide-by-zero gracefully

2. **Store Slice:**
   - setPositions updates map correctly
   - addSignal prepends and respects MAX_SIGNALS (50)
   - reset clears all state to defaults

3. **Message Parsing:**
   - Each event type (position_update, signal, market_status, etc.) updates correct store slice
   - Unknown event type doesn't crash, logs warning
   - Malformed data doesn't throw

</notes>

---

*This file is temporary. It will be deleted after /gsd:new-milestone creates the milestone.*
