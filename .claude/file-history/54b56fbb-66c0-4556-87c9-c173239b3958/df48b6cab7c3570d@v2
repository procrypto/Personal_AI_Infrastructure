# GitHub Actions workflow for deploying to GCP Cloud Run
# Triggers on push to main branch for beta deployments

name: Deploy to Beta

on:
  push:
    branches: [main]

env:
  GCP_PROJECT_ID: bonkbotbeta
  GCP_REGION: europe-west3
  SERVICE_NAME: trenchbench-api
  ARTIFACT_REGISTRY: europe-west4-docker.pkg.dev
  ARTIFACT_REGISTRY_FULL_PATH: europe-west4-docker.pkg.dev/bonkbotbeta/trenchbench-api/server
  WIF_SERVICE_ACCOUNT: bonkbot-github-actions@bonkbotbeta.iam.gserviceaccount.com
  WIF_PROVIDER: projects/1034486134720/locations/global/workloadIdentityPools/github-actions-auth-pool/providers/github

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Build and push Docker image
        id: build
        run: |
          IMAGE="${{ env.ARTIFACT_REGISTRY_FULL_PATH }}:${{ github.sha }}"
          docker build -t $IMAGE .
          docker push $IMAGE
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --image=${{ steps.build.outputs.image }} \
            --region=${{ env.GCP_REGION }} \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --port=8080 \
            --allow-unauthenticated \
            --set-env-vars="APP_ENV=remote,ENVIRONMENT=beta" \
            --set-secrets="CLICKHOUSE_URL=clickhouse-beta-eu-ro-uri:latest,CLICKHOUSE_USER=clickhouse-beta-eu-ro-user:latest,CLICKHOUSE_PASSWORD=clickhouse-beta-eu-ro-password:latest,TWITTER_API_KEY=twitter-api-key:latest"

      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.GCP_REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Show deployment details
        run: |
          echo "Service deployed successfully!"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "URL: ${{ steps.get-url.outputs.url }}"

      - name: Verify deployment health
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 15
          HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
          echo "Checking health at $HEALTH_URL"
          curl -sf "$HEALTH_URL" | grep -q '"ok":true' && echo "Health check passed" || (echo "Health check failed" && exit 1)
