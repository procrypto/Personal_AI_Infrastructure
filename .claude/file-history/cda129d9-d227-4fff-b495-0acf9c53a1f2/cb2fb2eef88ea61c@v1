# Deployment Checklist

GCP Cloud Run deployment setup for trenchbench-api.

## Prerequisites

- [ ] GCP project access (admin or delegated to Arthur)
- [ ] GitHub repo OIDC setup permissions
- [ ] ClickHouse credentials for each environment

## GCP Setup Checklist

Repeat for each project (`bonkbotbeta` for beta, `data-backend-prod` for prod).

### 1. Workload Identity Federation

```bash
# Create Workload Identity Pool
gcloud iam workload-identity-pools create "github" \
  --project="PROJECT_ID" \
  --location="global" \
  --display-name="GitHub Actions"

# Create OIDC Provider
gcloud iam workload-identity-pools providers create-oidc "github" \
  --project="PROJECT_ID" \
  --location="global" \
  --workload-identity-pool="github" \
  --display-name="GitHub" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
  --issuer-uri="https://token.actions.githubusercontent.com"
```

### 2. Service Account

```bash
# Create service account
gcloud iam service-accounts create "github-actions" \
  --project="PROJECT_ID" \
  --display-name="GitHub Actions"

# Grant roles
gcloud projects add-iam-policy-binding "PROJECT_ID" \
  --member="serviceAccount:github-actions@PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding "PROJECT_ID" \
  --member="serviceAccount:github-actions@PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"

gcloud projects add-iam-policy-binding "PROJECT_ID" \
  --member="serviceAccount:github-actions@PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"

# Bind WIF pool to service account
gcloud iam service-accounts add-iam-policy-binding \
  "github-actions@PROJECT_ID.iam.gserviceaccount.com" \
  --project="PROJECT_ID" \
  --role="roles/iam.workloadIdentityUser" \
  --member="principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github/attribute.repository/YOUR_ORG/YOUR_REPO"
```

### 3. Artifact Registry

```bash
gcloud artifacts repositories create "trenchbench-api" \
  --project="PROJECT_ID" \
  --repository-format="docker" \
  --location="us-central1" \
  --description="TrenchBench API container images"
```

### 4. Secret Manager

```bash
# Create secrets
echo -n "YOUR_KEY_ID" | gcloud secrets create "CLICKHOUSE_KEY_ID" \
  --project="PROJECT_ID" \
  --data-file=-

echo -n "YOUR_KEY_SECRET" | gcloud secrets create "CLICKHOUSE_KEY_SECRET" \
  --project="PROJECT_ID" \
  --data-file=-

echo -n "YOUR_SERVICE_ID" | gcloud secrets create "CLICKHOUSE_SERVICE_ID" \
  --project="PROJECT_ID" \
  --data-file=-

# Grant Cloud Run default SA access to secrets
PROJECT_NUMBER=$(gcloud projects describe PROJECT_ID --format='value(projectNumber)')

gcloud secrets add-iam-policy-binding "CLICKHOUSE_KEY_ID" \
  --project="PROJECT_ID" \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding "CLICKHOUSE_KEY_SECRET" \
  --project="PROJECT_ID" \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding "CLICKHOUSE_SERVICE_ID" \
  --project="PROJECT_ID" \
  --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

## Workflow Configuration

Update TODOs in `.github/workflows/deploy.yml` and `.github/workflows/deploy-prod.yml`:

### workload_identity_provider

Format: `projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github/providers/github`

Get PROJECT_NUMBER:
```bash
gcloud projects describe PROJECT_ID --format='value(projectNumber)'
```

### service_account

Format: `github-actions@PROJECT_ID.iam.gserviceaccount.com`

## Verification

### Test WIF Auth Locally

```bash
# Generate credentials file
gcloud iam workload-identity-pools create-cred-config \
  "projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github/providers/github" \
  --service-account="github-actions@PROJECT_ID.iam.gserviceaccount.com" \
  --output-file="wif-creds.json"

# Authenticate
gcloud auth login --cred-file=wif-creds.json
```

### Trigger Test Deployment

- **Beta:** Push to main branch
- **Prod:** Create and push version tag (`git tag v1.0.0 && git push --tags`)

### Expected Cloud Run URLs

- Beta: `https://trenchbench-api-HASH-uc.a.run.app`
- Prod: `https://trenchbench-api-HASH-uc.a.run.app`

Check deployment:
```bash
gcloud run services describe trenchbench-api \
  --project="PROJECT_ID" \
  --region="us-central1" \
  --format="value(status.url)"
```

## Environment Summary

| Environment | Trigger | GCP Project | APP_ENV |
|-------------|---------|-------------|---------|
| Beta | Push to main | bonkbotbeta | remote |
| Production | Push v* tag | data-backend-prod | remote |

Both environments use `APP_ENV=remote`. The only difference is the GCP project and credentials injected by Secret Manager.
