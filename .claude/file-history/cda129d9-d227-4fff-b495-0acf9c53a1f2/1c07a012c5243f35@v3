/**
 * Configuration loaded from environment variables.
 *
 * ⚠️  These credentials connect to PRODUCTION ClickHouse.
 */

// Environment types: local (dev machine) or remote (deployed to GCP)
export type Environment = "local" | "remote";

const getEnvironment = (): Environment => {
    const env = process.env.APP_ENV;
    if (env === "remote") return "remote";
    return "local";
};

export const isLocal = (): boolean => getEnvironment() === "local";
export const isRemote = (): boolean => getEnvironment() === "remote";

/**
 * Get ClickHouse credentials.
 * Same env vars for both local and remote - simplifies configuration.
 */
const getClickHouseConfig = () => ({
    keyId: process.env.CLICKHOUSE_KEY_ID ?? "",
    keySecret: process.env.CLICKHOUSE_KEY_SECRET ?? "",
    serviceId: process.env.CLICKHOUSE_SERVICE_ID ?? "",
});

export const config = {
    environment: getEnvironment(),
    clickhouse: getClickHouseConfig(),
    port: Number(process.env.PORT) || 8787,
    twitterApiKey: process.env.TWITTER_API_KEY ?? "",
};

export const assertConfig = () => {
    const missing: string[] = [];

    if (!config.clickhouse.keyId) missing.push("CLICKHOUSE_KEY_ID");
    if (!config.clickhouse.keySecret) missing.push("CLICKHOUSE_KEY_SECRET");
    if (!config.clickhouse.serviceId) missing.push("CLICKHOUSE_SERVICE_ID");

    if (missing.length > 0) {
        const helpText = isLocal()
            ? `
To fix:
  1. Copy env.example to .env:  cp env.example .env
  2. Fill in your credentials
  3. Restart the server

Get credentials from your team lead or TrenchBench WP admin settings.`
            : `
To fix (remote environment):
  Ensure GCP Secret Manager is injecting the CLICKHOUSE_* environment variables.`;

        console.error(`
╔══════════════════════════════════════════════════════════════════════════════╗
║  ❌ Missing ClickHouse credentials                                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

Missing environment variables:
${missing.map(v => `  - ${v}`).join("\n")}
${helpText}
`);
        process.exit(1);
    }

    console.log(`[config] Environment: ${config.environment}`);

    // Warn about optional credentials (don't exit)
    if (!config.twitterApiKey) {
        console.warn("[config] TWITTER_API_KEY not set - /twitter-proxy endpoint will not work");
    }
};





