# Context for TrenchBench API

Context and rules for Claude Code sessions working in this repository.

## Project Overview

TrenchBench API is a production-ready ClickHouse-backed HTTP service powering Community Tracker and TrenchBench custom queries. It provides REST endpoints for token analytics, trading data, wallet tracking, and discovery features.

**Deployment modes:**
- **Local**: Development with `bun dev`
- **Remote**: Cloud Run deployments (beta on `main` push, prod on `v*` tags)

Both modes use the same `CLICKHOUSE_*` credentials. Remote deployments inject credentials via GCP Secret Manager.

**Critical constraint:** Fetches PRODUCTION ClickHouse data. Treat all responses as sensitive.

## Architecture

### Tech Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| Runtime | Bun | Modern JS runtime with native TypeScript |
| Framework | Elysia v1.0.0 | Lightweight HTTP framework (Bun-native) |
| Database | ClickHouse Cloud | Production data via Queries API |
| Language | TypeScript 5.3+ | Strict mode enabled |
| Container | Docker (oven/bun:1-slim) | Multi-stage build for Cloud Run |
| CI/CD | GitHub Actions | WIF auth, Artifact Registry, Cloud Run deploy |
| Secrets | GCP Secret Manager | ClickHouse credentials injection |

### Services / Components

| Service | Purpose |
|---------|---------|
| `trenchbench-api` (Cloud Run) | Production API service |
| Artifact Registry | Container image storage |
| Secret Manager | Credential management |

### Key Directories

```
trenchbench-api/
├── src/
│   ├── server.ts              # Entry point, route registration
│   ├── config.ts              # Environment-aware config (local/beta/prod)
│   ├── clickhouse/
│   │   └── client.ts          # ClickHouse Cloud Queries API client
│   ├── endpoints/
│   │   ├── generic/           # Production-mirror endpoints (17 files)
│   │   ├── custom/            # User-defined local endpoints
│   │   └── _template.ts       # Endpoint template
│   └── extensions/            # Local-only augmentation layer
│       ├── types.ts           # Extension metadata types
│       ├── registry.ts        # Extension registry endpoint
│       ├── register.ts        # Extension route registration
│       └── catalog/           # Extension implementations
├── scripts/
│   └── gcp-setup.sh           # GCP infrastructure setup (WIF, SA, Secrets)
├── docs/
│   └── GCP-SETUP.md           # GCP configuration guide
├── .github/workflows/
│   ├── deploy.yml             # Beta deployment (main → bonkbotbeta)
│   └── deploy-prod.yml        # Prod deployment (v* → data-backend-prod)
├── .planning/                 # GSD project planning
├── Dockerfile                 # Multi-stage Bun build
├── .dockerignore              # Build exclusions
├── env.example                # Credentials template (3 modes)
└── README.md                  # Comprehensive documentation
```

## Capabilities

### Data Sources

| Source | Type | Access Pattern |
|--------|------|----------------|
| ClickHouse Cloud | Database | HTTP POST to Queries API with Basic Auth |

**Tables accessed:**
- `materializer_trades`, `materializer_trades_recent_1d` - Trade history
- `materializer_token_market_data_latest` - Token metadata and pricing
- `materializer_holder_mint_latest` - Holder statistics
- `discovery_trending_token_stats_ts` - Trending calculations
- Various `materializer_*` and `discovery_*` tables

### APIs / Interfaces

| Interface | Type | Purpose |
|-----------|------|---------|
| `/health` | REST GET | Health check |
| `/trades/:mint` | REST GET | Trade history for token |
| `/search/:mint` | REST GET | Token lookup by mint |
| `/search` | REST GET | Text-based token search |
| `/ohlcv/pool/:pool/:range` | REST GET | Pool candlestick data |
| `/ohlcv/token/:mint/:range` | REST GET | Token candlestick data |
| `/holders-stats/:mint` | REST GET | Top 100 holders |
| `/holder-stats/:mint/:address` | REST GET | Holder stats for wallet on token |
| `/discovery/trending` | REST GET | Trending tokens list |
| `/discovery/whale-moves` | REST GET | Whale activity (24h) |
| `/wallet-tracker/trades` | REST GET | Trades for tracked wallets |
| `/wallet-tracker/summary-all` | REST GET | Wallet summaries |
| `/wallet-tracker/summary-all-v2` | REST GET | Wallet summaries (trimmed token_image) |
| `/wallet-funding/:address` | REST GET | Wallet funding sources |
| `/multi-wallet-families/:mint` | REST GET | Multi-wallet family detection |
| `/market-data/:mint` | REST GET | Token market data (single) |
| `/market-data-batch` | REST GET | Token market data (batch) |
| `/custom/wallet-trades-snapshot` | REST POST | Bounded wallet trades (labs) |
| `/custom/holders-stats-batch` | REST POST | Batch holder lookup (labs) |
| `/ext/registry` | REST GET | Extension metadata |
| `/ext/search/:mint` | REST GET | Extended token lookup |
| `/twitter-proxy` | REST GET | Twitter community API proxy |
| `/community-tracker` | REST GET/POST | Community tracker persistence |

### Extension Points

- **Custom endpoints**: Copy `_template.ts` to `endpoints/custom/`, register in `server.ts`
- **Extensions system**: Add to `extensions/catalog/`, implement `ExtensionDefinition` interface (always enabled)

## Working in This Repo

### Standards & Conventions

- Clean routes without prefixes (e.g., `/trades/:mint`, `/discovery/trending`)
- Custom endpoints (local-only) use `POST` method and `/custom/*` prefix
- Generic endpoints mirror production API shapes exactly
- SQL queries use parameterized limits with `clamp()` for safety
- All responses follow `{ ok: boolean, ... }` pattern
- Environment detection via `APP_ENV` (local/beta/prod)

### Common Tasks

#### Local Development

```bash
bun install          # Install dependencies
cp env.example .env  # Create config (use TBKM credentials section)
bun dev              # Start with watch mode (localhost:8080)
```

#### Adding a New Endpoint

```bash
cp src/endpoints/_template.ts src/endpoints/generic/my_endpoint.ts
# Edit the file: rename function, change route, add SQL
# Register in src/server.ts: import and call register function
```

#### Docker Build (Local Test)

```bash
docker build -t trenchbench-api .
docker run -p 8080:8080 --env-file .env trenchbench-api
```

#### GCP Setup (First-Time)

```bash
# Preview commands
./scripts/gcp-setup.sh bonkbotbeta --dry-run

# Execute setup (requires GCP admin access)
./scripts/gcp-setup.sh bonkbotbeta

# See docs/GCP-SETUP.md for full guide
```

#### Finding Code

- Endpoint handlers: `src/endpoints/generic/*.ts`
- ClickHouse queries: SQL strings within each endpoint file
- Extension metadata: `src/extensions/types.ts`
- Config validation: `src/config.ts`
- Deployment workflows: `.github/workflows/*.yml`
- GCP setup: `scripts/gcp-setup.sh`, `docs/GCP-SETUP.md`

### Things to Avoid

- Committing `.env` files or fetched data
- Removing limit caps on queries (prevent expensive ClickHouse calls)
- Modifying generic endpoints to diverge from production API shapes
- Using `git add .` (always stage files individually)

## Related Documentation

- [README.md](README.md) - Comprehensive setup, endpoint docs
- [docs/GCP-SETUP.md](docs/GCP-SETUP.md) - GCP infrastructure configuration
- [src/endpoints/custom/README.md](src/endpoints/custom/README.md) - Custom endpoint guide
- [.planning/PROJECT.md](.planning/PROJECT.md) - Project goals and decisions

## Cross-System Context

### Upstream Dependencies

| System | What We Get |
|--------|-------------|
| ClickHouse Cloud | Production trading data, token metadata, holder stats |
| GCP Secret Manager | ClickHouse credentials (beta/prod) |
| GitHub Actions | CI/CD pipeline execution |

### Downstream Consumers

| System | What They Get |
|--------|---------------|
| web-terminal-frontend | REST API endpoints via Vite proxy (local dev) |
| Community Tracker | Token analytics, trending, whale moves |
| TrenchBench | Custom query endpoints |

### Deployment Architecture

```
GitHub (BonkBotTeam/trenchbench-api)
    │
    ├── push main ──► GitHub Actions ──► bonkbotbeta (Cloud Run)
    │                     │
    │                     ▼
    │              Workload Identity Federation
    │                     │
    │                     ▼
    │              Artifact Registry (us-central1)
    │
    └── push v* ───► GitHub Actions ──► data-backend-prod (Cloud Run)
                          │
                          ▼
                   Secret Manager (ClickHouse creds)
                          │
                          ▼
                   Cloud Run Service
                          │
                          ▼
                   ClickHouse Cloud
```

### Integration Pattern

- **Local dev**: Direct API access to `localhost:8080` with clean routes
- **Beta/Prod**: Direct Cloud Run URL access
- **Auth**: Workload Identity Federation (no service account keys)
- **Secrets**: Injected at runtime via Secret Manager references

---
*Repository: BonkBotTeam/trenchbench-api*
*Verified: 2026-01-13*
