     1→# Rotations v1.5.2
     2→
     3→A TradingView Pine Script indicator that tracks price rotations (directional swings) and visualizes market structure.
     4→
     5→**Source:** `Rotations1.5.2.pine.js`  
     6→**Credits:** Original by antek, with contributions from procrypt  
     7→**Pine Script Version:** v5
     8→
     9→---
    10→
    11→## Overview
    12→
    13→The Rotations indicator identifies when price establishes a new directional swing by tracking closes that break beyond the previous rotation's high or low. It provides:
    14→
    15→- Visual bar coloring based on current rotation state
    16→- Dynamic support/resistance levels from rotation pivots
    17→- Multi-timeframe rotation level overlay
    18→- False breakout detection (wicks beyond levels without closes)
    19→
    20→---
    21→
    22→## How It Works
    23→
    24→### Core Logic
    25→
    26→The indicator tracks three rotation states:
    27→
    28→| State | Value | Condition | Bar Color |
    29→|-------|-------|-----------|-----------|
    30→| Upward Rotation | `+1` | `close > rotationHigh AND close > high[1]` | Green (`#469C68`) |
    31→| Downward Rotation | `-1` | `close < rotationLow AND close < low[1]` | Red (`#B64524`) |
    32→| Invalidation | `0` | Price crosses opposite level without establishing new rotation | Gray (`#808080`) |
    33→
    34→### State Transition Flow
    35→
    36→```
    37→                    ┌─────────────────────────────────────┐
    38→                    │                                     │
    39→                    ▼                                     │
    40→    ┌───────────────────────────────┐                     │
    41→    │      UPWARD ROTATION (+1)     │                     │
    42→    │   close > rotationHigh AND    │                     │
    43→    │      close > high[1]          │                     │
    44→    └───────────────┬───────────────┘                     │
    45→                    │                                     │
    46→      close < rotationLow                    close > rotationHigh
    47→      (without new low)                      AND close > high[1]
    48→                    │                                     │
    49→                    ▼                                     │
    50→    ┌───────────────────────────────┐                     │
    51→    │      INVALIDATION (0)         │─────────────────────┘
    52→    │   No confirmed direction      │
    53→    └───────────────┬───────────────┘
    54→                    │
    55→      close < rotationLow AND
    56→         close < low[1]
    57→                    │
    58→                    ▼
    59→    ┌───────────────────────────────┐
    60→    │    DOWNWARD ROTATION (-1)     │
    61→    │   close < rotationLow AND     │
    62→    │      close < low[1]           │
    63→    └───────────────────────────────┘
    64→```
    65→
    66→### Key Behavior
    67→
    68→1. **New Rotation Established:** When conditions are met, the current bar's high and low become the new `rotationHigh` and `rotationLow`
    69→2. **Trailing Levels:** Rotation levels persist until a new rotation is established
    70→3. **Invalidation:** If price crosses the opposite level without meeting full rotation conditions, state becomes neutral (gray)
    71→
    72→---
    73→
    74→## Visual Features
    75→
    76→### Bar Coloring
    77→- **Green bars:** Currently in upward rotation
    78→- **Red bars:** Currently in downward rotation  
    79→- **Gray bars:** Rotation invalidated, no confirmed direction
    80→- **Translucent gray:** Candles before the configured start date
    81→
    82→### Rotation Level Plots
    83→
    84→| Element | Description | Color |
    85→|---------|-------------|-------|
    86→| Rotation High circles | Plotted at `rotationHigh` level | Green (orange on breakout) |
    87→| Rotation Low circles | Plotted at `rotationLow` level | Red (orange on breakout) |
    88→| Extended high line | Dashed line projecting 50 bars right | Green |
    89→| Extended low line | Dashed line projecting 50 bars right | Purple |
    90→| Price scale markers | Small marks on price axis | Green/Red |
    91→
    92→### Breakout Detection
    93→
    94→When price wicks beyond a rotation level but doesn't close beyond it, the level is highlighted in **orange**. This indicates:
    95→- Potential false breakout / liquidity grab
    96→- Level is being tested but holding
    97→- Caution for breakout traders
    98→
    99→---
   100→
   101→## Multi-Timeframe Mode
   102→
   103→### Configuration
   104→
   105→Enable via inputs:
   106→- **Enable Multi-Timeframe Levels:** Toggle MTF display
   107→- **Timeframe for Additional Levels:** Select higher timeframe (default: 240 = 4 hours)
   108→
   109→### How It Works
   110→
   111→The indicator fetches rotation data from the selected higher timeframe using `request.security()` and overlays those levels on your current chart. This allows you to:
   112→
   113→- Trade on a 15-minute chart while seeing 4-hour structure
   114→- Identify major support/resistance from higher timeframes
   115→- Align entries with higher timeframe direction
   116→
   117→### MTF Color Scheme
   118→
   119→| Element | Color |
   120→|---------|-------|
   121→| MTF Rotation High | Blue (yellow on breakout) |
   122→| MTF Rotation Low | Aqua (yellow on breakout) |
   123→| MTF Extended Lines | Blue / Aqua dashed |
   124→
   125→### Notes
   126→
   127→- MTF levels only display when chart timeframe differs from selected MTF
   128→- MTF uses `barmerge.gaps_off` for continuous level display
   129→
   130→---
   131→
   132→## Use Cases
   133→
   134→### 1. Trend Identification
   135→Quick visual confirmation of current market direction via bar colors. Green = bullish structure, Red = bearish structure, Gray = structure broken.
   136→
   137→### 2. Support/Resistance Levels
   138→Rotation high and low act as dynamic S/R levels based on recent price action, not arbitrary calculations.
   139→
   140→### 3. Trade Management
   141→- **Long positions:** Monitor rotation low as structural support
   142→- **Short positions:** Monitor rotation high as structural resistance
   143→- **Gray bars:** Warning that your directional bias may be invalidated
   144→
   145→### 4. Multi-Timeframe Analysis
   146→Use MTF levels to ensure trades align with higher timeframe structure. Don't go long if price is below 4H rotation high, for example.
   147→
   148→### 5. False Breakout Detection
   149→Orange-highlighted levels indicate price wicked through but failed to close beyond—potential traps or liquidity grabs.
   150→
   151→---
   152→
   153→## Inputs Reference
   154→
   155→| Input | Default | Description |
   156→|-------|---------|-------------|
   157→| Start Date | 2022-01-01 | Only calculate rotations after this date |
   158→| Enable Multi-Timeframe Levels | false | Toggle MTF overlay |
   159→| Timeframe for Additional Levels | 240 (4H) | Higher timeframe for MTF levels |
   160→| Show Price Labels | false | Display rotation level values as labels |
   161→
   162→---
   163→
   164→## Improvement Roadmap
   165→
   166→### Priority 1: Essential (High Impact)
   167→
   168→#### Alerts
   169→**Currently missing entirely.** Add alert conditions for:
   170→
   171→```pinescript
   172→// Rotation state changes
   173→alertcondition(currentRotation == 1 and currentRotation[1] != 1, "New Upward Rotation", 
   174→  "{{ticker}} established new upward rotation")
   175→alertcondition(currentRotation == -1 and currentRotation[1] != -1, "New Downward Rotation", 
   176→  "{{ticker}} established new downward rotation")
   177→alertcondition(currentRotation == 0 and currentRotation[1] != 0, "Rotation Invalidated", 
   178→  "{{ticker}} rotation structure invalidated")
   179→
   180→// Level approaches
   181→alertcondition(high > rotationHigh * 0.995 and close < rotationHigh, "Approaching Rotation High",
   182→  "{{ticker}} approaching rotation high")
   183→alertcondition(low < rotationLow * 1.005 and close > rotationLow, "Approaching Rotation Low",
   184→  "{{ticker}} approaching rotation low")
   185→
   186→// MTF alignment
   187→alertcondition(currentRotation == 1 and mtfCurrentRotation == 1, "MTF Aligned Long",
   188→  "{{ticker}} chart and MTF both in upward rotation")
   189→```
   190→
   191→#### ATR Minimum Move Filter
   192→Reduce noise in choppy markets by requiring minimum price movement:
   193→
   194→```pinescript
   195→// Add to inputs
   196→atrLength = input.int(14, "ATR Length", group="Filters")
   197→atrMultiplier = input.float(0.5, "Min ATR Multiple for Rotation", minval=0.1, maxval=2.0, step=0.1, group="Filters")
   198→
   199→// In calcRotation function, modify conditions:
   200→atrValue = ta.atr(atrLength)
   201→minMove = atrValue * atrMultiplier
   202→
   203→// Upward rotation requires meaningful move
   204→if close > rotationHigh and close > high[1] and (close - rotationLow) > minMove
   205→    newRotation := 1
   206→    // ... rest of logic
   207→
   208→// Downward rotation requires meaningful move  
   209→if close < rotationLow and close < low[1] and (rotationHigh - close) > minMove
   210→    newRotation := -1
   211→    // ... rest of logic
   212→```
   213→
   214→#### Volume Confirmation
   215→Filter out weak rotations lacking volume support:
   216→
   217→```pinescript
   218→// Add to inputs
   219→useVolumeFilter = input.bool(false, "Require Volume Confirmation", group="Filters")
   220→volumeLength = input.int(20, "Volume MA Length", group="Filters")
   221→volumeMultiplier = input.float(1.0, "Min Volume Multiple", minval=0.5, maxval=3.0, group="Filters")
   222→
   223→// Calculate volume threshold
   224→volumeMA = ta.sma(volume, volumeLength)
   225→volumeThreshold = volumeMA * volumeMultiplier
   226→hasVolume = volume > volumeThreshold
   227→
   228→// Modify rotation conditions
   229→validUpRotation = close > rotationHigh and close > high[1] and (not useVolumeFilter or hasVolume)
   230→validDownRotation = close < rotationLow and close < low[1] and (not useVolumeFilter or hasVolume)
   231→```
   232→
   233→---
   234→
   235→### Priority 2: Enhancement (Medium Impact)
   236→
   237→#### Risk Management Zones
   238→Auto-calculate stop loss and target levels:
   239→
   240→```pinescript
   241→// Add to inputs
   242→showRiskLevels = input.bool(false, "Show Risk Management Levels", group="Risk Management")
   243→stopBuffer = input.float(0.5, "Stop Loss Buffer (ATR)", minval=0.1, maxval=2.0, group="Risk Management")
   244→targetRatio = input.float(2.0, "Risk:Reward Ratio", minval=1.0, maxval=5.0, group="Risk Management")
   245→
   246→// Calculate levels
   247→atr = ta.atr(14)
   248→longStop = rotationLow - (atr * stopBuffer)
   249→longTarget = close + ((close - longStop) * targetRatio)
   250→shortStop = rotationHigh + (atr * stopBuffer)
   251→shortTarget = close - ((shortStop - close) * targetRatio)
   252→
   253→// Plot when in respective rotation
   254→plot(showRiskLevels and currentRotation == 1 ? longStop : na, "Long Stop", color.red, style=plot.style_linebr)
   255→plot(showRiskLevels and currentRotation == 1 ? longTarget : na, "Long Target", color.green, style=plot.style_linebr)
   256→```
   257→
   258→#### Confirmation Candles
   259→Reduce whipsaws by requiring multiple closes:
   260→
   261→```pinescript
   262→// Add to inputs
   263→confirmationBars = input.int(1, "Confirmation Bars", minval=1, maxval=5, group="Filters")
   264→
   265→// Track consecutive closes
   266→var int bullishCount = 0
   267→var int bearishCount = 0
   268→
   269→bullishCount := close > rotationHigh and close > high[1] ? bullishCount + 1 : 0
   270→bearishCount := close < rotationLow and close < low[1] ? bearishCount + 1 : 0
   271→
   272→// Only confirm rotation after N bars
   273→confirmedUp = bullishCount >= confirmationBars
   274→confirmedDown = bearishCount >= confirmationBars
   275→```
   276→
   277→#### Session/Time Filters
   278→Avoid low-liquidity periods:
   279→
   280→```pinescript
   281→// Add to inputs
   282→useSessionFilter = input.bool(false, "Filter by Session", group="Time Filters")
   283→sessionStart = input.session("0930-1600", "Active Session", group="Time Filters")
   284→
   285→// Check if in session
   286→inSession = time(timeframe.period, sessionStart)
   287→allowRotation = not useSessionFilter or inSession
   288→```
   289→
   290→---
   291→
   292→### Priority 3: Advanced (Nice to Have)
   293→
   294→#### Statistics Dashboard
   295→Display rotation metrics in a table:
   296→
   297→```pinescript
   298→// Track statistics
   299→var int totalRotations = 0
   300→var int successfulRotations = 0  // Reached opposite level
   301→var float avgRotationBars = 0
   302→
   303→// Create table
   304→var table statsTable = table.new(position.top_right, 2, 4)
   305→if barstate.islast
   306→    table.cell(statsTable, 0, 0, "Total Rotations", text_color=color.white)
   307→    table.cell(statsTable, 1, 0, str.tostring(totalRotations), text_color=color.white)
   308→    // ... additional stats
   309→```
   310→
   311→#### Confluence Scoring
   312→Visual indicator of setup quality:
   313→
   314→```pinescript
   315→// Calculate confluence score (0-100)
   316→score = 0
   317→score += currentRotation == mtfCurrentRotation ? 25 : 0  // MTF alignment
   318→score += hasVolume ? 25 : 0  // Volume confirmation
   319→score += (close - rotationLow) > atr ? 25 : 0  // Meaningful move
   320→score += trend_aligned ? 25 : 0  // Higher timeframe trend
   321→
   322→// Display score
   323→bgcolor(score >= 75 ? color.new(color.green, 90) : score >= 50 ? color.new(color.yellow, 90) : na)
   324→```
   325→
   326→#### Dynamic Zones
   327→Replace exact lines with ATR-based zones:
   328→
   329→```pinescript
   330→zoneWidth = input.float(0.2, "Zone Width (ATR)", group="Display")
   331→
   332→upperZoneHigh = rotationHigh + (atr * zoneWidth)
   333→upperZoneLow = rotationHigh - (atr * zoneWidth)
   334→lowerZoneHigh = rotationLow + (atr * zoneWidth)
   335→lowerZoneLow = rotationLow - (atr * zoneWidth)
   336→
   337→// Use fill() to create zone visualization
   338→p1 = plot(upperZoneHigh)
   339→p2 = plot(upperZoneLow)
   340→fill(p1, p2, color=color.new(color.green, 80))
   341→```
   342→
   343→---
   344→
   345→## Known Limitations
   346→
   347→1. **Repainting:** Like all indicators using current bar data, the rotation state can change until the bar closes
   348→2. **Choppy Markets:** Without filters, produces many false signals in ranging conditions
   349→3. **Gap Risk:** Large gaps can skip over rotation levels entirely
   350→4. **No Alerts:** Currently lacks any alert functionality (Priority 1 improvement)
   351→
   352→---
   353→
   354→## Version History
   355→
   356→- **v1.5.2** - Current version with MTF support
   357→- Previous versions not documented
   358→
   359→---
   360→
   361→## License
   362→
   363→Mozilla Public License 2.0
   364→
   365→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
