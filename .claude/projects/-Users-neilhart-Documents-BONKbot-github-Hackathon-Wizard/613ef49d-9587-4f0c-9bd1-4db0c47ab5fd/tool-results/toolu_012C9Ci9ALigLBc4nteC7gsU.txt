     1â†’/* eslint-disable lingui/no-unlocalized-strings */
     2â†’import { useState, useEffect, useCallback, useRef } from "react";
     3â†’import { FormattedNumber } from "@/components/formatted-number/formatted-number";
     4â†’import { Bot, AlertTriangle, TrendingUp, TrendingDown, Activity, Zap, Target, ShieldAlert, Clock, Eye, Flame, Wallet, Settings, RefreshCw, Power, Layers, CheckCircle2, Circle } from "lucide-react";
     5â†’import { cn } from "@/lib/utils";
     6â†’import { Switch } from "@/components/switch";
     7â†’import { Tooltip } from "@/components/tooltip";
     8â†’
     9â†’// Types matching the backend WebSocket events
    10â†’interface PositionData {
    11â†’  mint: string;
    12â†’  symbol: string;
    13â†’  action: "buy" | "sell";
    14â†’  entryPriceSol: number;
    15â†’  currentPriceSol: number;
    16â†’  positionSizeSol: number;
    17â†’  pnlPercent: number;
    18â†’  pnlSol: number;
    19â†’  entryTime: number;
    20â†’}
    21â†’
    22â†’interface SignalData {
    23â†’  timestamp: number;
    24â†’  mint: string;
    25â†’  symbol: string;
    26â†’  signalType: "magic_buy" | "magic_exit" | "dump_exit" | "rule_signal";
    27â†’  action: "buy" | "sell" | "close";
    28â†’  reason: string;
    29â†’  pnlPercent?: number;
    30â†’  entryType?: string;
    31â†’}
    32â†’
    33â†’interface MarketStatusData {
    34â†’  state: "NORMAL" | "CAUTION" | "DUMP";
    35â†’  solPriceChangePercent: number;
    36â†’  blockEntries: boolean;
    37â†’  exitAll: boolean;
    38â†’}
    39â†’
    40â†’interface StatsData {
    41â†’  totalTrades: number;
    42â†’  openTrades: number;
    43â†’  closedTrades: number;
    44â†’  wins: number;
    45â†’  losses: number;
    46â†’  winRate: number;
    47â†’  totalPnlSol: number;
    48â†’  totalPnlUsd: number;
    49â†’  avgPnlPercent: number;
    50â†’}
    51â†’
    52â†’interface ScanTickData {
    53â†’  timestamp: number;
    54â†’  scanNumber: number;
    55â†’  tokenCount: number;
    56â†’  openPositions: number;
    57â†’}
    58â†’
    59â†’interface WatchedToken {
    60â†’  mint: string;
    61â†’  symbol: string;
    62â†’  source: "watchlist" | "trending" | "whales";
    63â†’  priceSol?: number;
    64â†’  priceUsd?: number;
    65â†’  change1h?: number;
    66â†’  change24h?: number;
    67â†’  volume24h?: number;
    68â†’  mcap?: number;
    69â†’  hasPosition?: boolean;
    70â†’}
    71â†’
    72â†’interface TokenListData {
    73â†’  watchlist: WatchedToken[];
    74â†’  trending: WatchedToken[];
    75â†’  whales: WatchedToken[];
    76â†’}
    77â†’
    78â†’interface ConfigData {
    79â†’  autoSourcesEnabled: boolean;
    80â†’  trendingEnabled: boolean;
    81â†’  whalesEnabled: boolean;
    82â†’  marketFilterEnabled: boolean;
    83â†’  mode: "paper" | "live";
    84â†’  positionSizeSol: number;
    85â†’  pollIntervalMs: number;
    86â†’}
    87â†’
    88â†’interface StrategyInfo {
    89â†’  id: string;
    90â†’  name: string;
    91â†’  description: string;
    92â†’  mode: "all" | "any";
    93â†’  ruleCount: number;
    94â†’  summary: string;
    95â†’}
    96â†’
    97â†’interface StrategiesData {
    98â†’  available: StrategyInfo[];
    99â†’  active: string[];
   100â†’}
   101â†’
   102â†’type AutopilotCommand =
   103â†’  | { command: "toggle_sources"; enabled: boolean }
   104â†’  | { command: "toggle_trending"; enabled: boolean }
   105â†’  | { command: "toggle_whales"; enabled: boolean }
   106â†’  | { command: "toggle_filter"; enabled: boolean }
   107â†’  | { command: "set_mode"; mode: "paper" | "live" }
   108â†’  | { command: "set_position_size"; sizeSol: number }
   109â†’  | { command: "refresh_sources" }
   110â†’  | { command: "get_config" }
   111â†’  | { command: "get_strategies" }
   112â†’  | { command: "toggle_strategy"; strategyId: string; enabled: boolean };
   113â†’
   114â†’type AutopilotEvent =
   115â†’  | { type: "position_update"; positions: PositionData[] }
   116â†’  | { type: "signal"; signal: SignalData }
   117â†’  | { type: "market_status"; status: MarketStatusData }
   118â†’  | { type: "stats_update"; stats: StatsData }
   119â†’  | { type: "scan_tick"; tick: ScanTickData }
   120â†’  | { type: "token_list"; tokens: TokenListData }
   121â†’  | { type: "config"; config: ConfigData }
   122â†’  | { type: "strategies"; strategies: StrategiesData };
   123â†’
   124â†’// Determine WebSocket URL based on protocol (use proxy for HTTPS)
   125â†’const getAutopilotWsUrl = () => {
   126â†’  if (typeof window === "undefined") return "ws://localhost:8765";
   127â†’  // Use vite proxy when on HTTPS to avoid mixed content
   128â†’  if (window.location.protocol === "https:") {
   129â†’    return `wss://${window.location.host}/autopilot-ws`;
   130â†’  }
   131â†’  return "ws://localhost:8765";
   132â†’};
   133â†’
   134â†’// WebSocket hook for autopilot backend
   135â†’function useAutopilotWebSocket(wsUrl: string = getAutopilotWsUrl()) {
   136â†’  const [positions, setPositions] = useState<PositionData[]>([]);
   137â†’  const [signals, setSignals] = useState<SignalData[]>([]);
   138â†’  const [marketStatus, setMarketStatus] = useState<MarketStatusData>({
   139â†’    state: "NORMAL",
   140â†’    solPriceChangePercent: 0,
   141â†’    blockEntries: false,
   142â†’    exitAll: false,
   143â†’  });
   144â†’  const [stats, setStats] = useState<StatsData>({
   145â†’    totalTrades: 0,
   146â†’    openTrades: 0,
   147â†’    closedTrades: 0,
   148â†’    wins: 0,
   149â†’    losses: 0,
   150â†’    winRate: 0,
   151â†’    totalPnlSol: 0,
   152â†’    totalPnlUsd: 0,
   153â†’    avgPnlPercent: 0,
   154â†’  });
   155â†’  const [scanTick, setScanTick] = useState<ScanTickData | null>(null);
   156â†’  const [tokenList, setTokenList] = useState<TokenListData>({
   157â†’    watchlist: [],
   158â†’    trending: [],
   159â†’    whales: [],
   160â†’  });
   161â†’  const [config, setConfig] = useState<ConfigData>({
   162â†’    autoSourcesEnabled: true,
   163â†’    trendingEnabled: true,
   164â†’    whalesEnabled: true,
   165â†’    marketFilterEnabled: true,
   166â†’    mode: "paper",
   167â†’    positionSizeSol: 0.1,
   168â†’    pollIntervalMs: 30000,
   169â†’  });
   170â†’  const [strategies, setStrategies] = useState<StrategiesData>({
   171â†’    available: [],
   172â†’    active: [],
   173â†’  });
   174â†’  const [isConnected, setIsConnected] = useState(false);
   175â†’  const wsRef = useRef<WebSocket | null>(null);
   176â†’  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
   177â†’
   178â†’  const sendCommand = useCallback((command: AutopilotCommand) => {
   179â†’    if (wsRef.current?.readyState === WebSocket.OPEN) {
   180â†’      wsRef.current.send(JSON.stringify(command));
   181â†’    }
   182â†’  }, []);
   183â†’
   184â†’  const connect = useCallback(() => {
   185â†’    if (wsRef.current?.readyState === WebSocket.OPEN) return;
   186â†’
   187â†’    try {
   188â†’      const ws = new WebSocket(wsUrl);
   189â†’      wsRef.current = ws;
   190â†’
   191â†’      ws.onopen = () => {
   192â†’        setIsConnected(true);
   193â†’        console.log("[Autopilot] WebSocket connected");
   194â†’      };
   195â†’
   196â†’      ws.onclose = () => {
   197â†’        setIsConnected(false);
   198â†’        console.log("[Autopilot] WebSocket disconnected, reconnecting...");
   199â†’        // Reconnect after 3 seconds
   200â†’        reconnectTimeoutRef.current = setTimeout(connect, 3000);
   201â†’      };
   202â†’
   203â†’      ws.onerror = (err) => {
   204â†’        console.error("[Autopilot] WebSocket error:", err);
   205â†’      };
   206â†’
   207â†’      ws.onmessage = (event) => {
   208â†’        try {
   209â†’          const data = JSON.parse(event.data) as AutopilotEvent;
   210â†’
   211â†’          switch (data.type) {
   212â†’            case "position_update":
   213â†’              console.log("[Autopilot] Positions received:", data.positions.length, data.positions);
   214â†’              setPositions(data.positions);
   215â†’              break;
   216â†’            case "signal":
   217â†’              console.log("[Autopilot] Signal received:", data.signal);
   218â†’              setSignals((prev) => [data.signal, ...prev].slice(0, 50)); // Keep last 50 signals
   219â†’              break;
   220â†’            case "market_status":
   221â†’              console.log("[Autopilot] Market status:", data.status.state, data.status.solPriceChangePercent + "%");
   222â†’              setMarketStatus(data.status);
   223â†’              break;
   224â†’            case "stats_update":
   225â†’              console.log("[Autopilot] Stats update:", data.stats);
   226â†’              setStats(data.stats);
   227â†’              break;
   228â†’            case "scan_tick":
   229â†’              console.log("[Autopilot] Scan tick #" + data.tick.scanNumber, data.tick.tokenCount + " tokens");
   230â†’              setScanTick(data.tick);
   231â†’              break;
   232â†’            case "token_list":
   233â†’              console.log("[Autopilot] Token list:", data.tokens.watchlist.length + "W", data.tokens.trending.length + "T", data.tokens.whales.length + "$");
   234â†’              setTokenList(data.tokens);
   235â†’              break;
   236â†’            case "config":
   237â†’              console.log("[Autopilot] Config received:", data.config);
   238â†’              setConfig(data.config);
   239â†’              break;
   240â†’            case "strategies":
   241â†’              console.log("[Autopilot] Strategies received:", data.strategies.available.length, "available,", data.strategies.active.length, "active");
   242â†’              setStrategies(data.strategies);
   243â†’              break;
   244â†’          }
   245â†’        } catch (err) {
   246â†’          console.error("[Autopilot] Failed to parse message:", err);
   247â†’        }
   248â†’      };
   249â†’    } catch (err) {
   250â†’      console.error("[Autopilot] Failed to connect:", err);
   251â†’      reconnectTimeoutRef.current = setTimeout(connect, 3000);
   252â†’    }
   253â†’  }, [wsUrl]);
   254â†’
   255â†’  useEffect(() => {
   256â†’    connect();
   257â†’    return () => {
   258â†’      if (reconnectTimeoutRef.current) {
   259â†’        clearTimeout(reconnectTimeoutRef.current);
   260â†’      }
   261â†’      wsRef.current?.close();
   262â†’    };
   263â†’  }, [connect]);
   264â†’
   265â†’  return { positions, signals, marketStatus, stats, scanTick, tokenList, config, strategies, isConnected, sendCommand };
   266â†’}
   267â†’
   268â†’// Market Status Badge Component
   269â†’const MarketStatusBadge = ({ status }: { status: MarketStatusData }) => {
   270â†’  const stateConfig = {
   271â†’    NORMAL: { color: "bg-green-500/20 text-green-400 border-green-500/30", icon: Activity, label: "NORMAL" },
   272â†’    CAUTION: { color: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30", icon: AlertTriangle, label: "CAUTION" },
   273â†’    DUMP: { color: "bg-red-500/20 text-red-400 border-red-500/30", icon: ShieldAlert, label: "DUMP" },
   274â†’  };
   275â†’
   276â†’  const config = stateConfig[status.state];
   277â†’  const Icon = config.icon;
   278â†’
   279â†’  return (
   280â†’    <div className={cn("flex items-center gap-2 rounded-lg border px-3 py-1.5", config.color)}>
   281â†’      <Icon className="h-4 w-4" />
   282â†’      <span className="text-xs font-semibold">{config.label}</span>
   283â†’      <span className="text-xs opacity-75">
   284â†’        SOL {status.solPriceChangePercent >= 0 ? "+" : ""}
   285â†’        {status.solPriceChangePercent.toFixed(2)}%
   286â†’      </span>
   287â†’    </div>
   288â†’  );
   289â†’};
   290â†’
   291â†’// Position Card Component
   292â†’const PositionCard = ({ position }: { position: PositionData }) => {
   293â†’  const isProfit = position.pnlPercent >= 0;
   294â†’  const holdTime = Math.floor((Date.now() - position.entryTime) / 60000); // minutes
   295â†’
   296â†’  return (
   297â†’    <div className="border-border-primary bg-bg-tertiary/50 flex items-center justify-between rounded-lg border p-3">
   298â†’      <div className="flex items-center gap-3">
   299â†’        <div
   300â†’          className={cn(
   301â†’            "flex h-8 w-8 items-center justify-center rounded-lg text-xs font-bold",
   302â†’            isProfit ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"
   303â†’          )}
   304â†’        >
   305â†’          {isProfit ? <TrendingUp className="h-4 w-4" /> : <TrendingDown className="h-4 w-4" />}
   306â†’        </div>
   307â†’        <div>
   308â†’          <span className="text-text-primary text-sm font-medium">${position.symbol}</span>
   309â†’          <div className="text-text-secondary flex items-center gap-1 text-[10px]">
   310â†’            <Clock className="h-3 w-3" />
   311â†’            {holdTime}m
   312â†’          </div>
   313â†’        </div>
   314â†’      </div>
   315â†’      <div className="text-right">
   316â†’        <div className={cn("text-sm font-semibold", isProfit ? "text-green-400" : "text-red-400")}>
   317â†’          {isProfit ? "+" : ""}
   318â†’          {position.pnlPercent.toFixed(2)}%
   319â†’        </div>
   320â†’        <div className="text-text-secondary text-[10px]">
   321â†’          {position.positionSizeSol.toFixed(2)} SOL
   322â†’        </div>
   323â†’      </div>
   324â†’    </div>
   325â†’  );
   326â†’};
   327â†’
   328â†’// Signal Item Component
   329â†’const SignalItem = ({ signal }: { signal: SignalData }) => {
   330â†’  const signalConfig = {
   331â†’    magic_buy: { color: "text-cyan-400", icon: Target, label: "BUY" },
   332â†’    magic_exit: { color: "text-purple-400", icon: Zap, label: "EXIT" },
   333â†’    dump_exit: { color: "text-red-400", icon: ShieldAlert, label: "DUMP" },
   334â†’    rule_signal: { color: "text-blue-400", icon: Activity, label: "SIGNAL" },
   335â†’  };
   336â†’
   337â†’  const config = signalConfig[signal.signalType];
   338â†’  const Icon = config.icon;
   339â†’  const time = new Date(signal.timestamp).toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
   340â†’
   341â†’  return (
   342â†’    <div className="border-border-primary/50 flex items-center gap-2 border-b py-2 last:border-0">
   343â†’      <Icon className={cn("h-3.5 w-3.5", config.color)} />
   344â†’      <span className="text-text-secondary text-[10px]">{time}</span>
   345â†’      <span className={cn("text-xs font-medium", config.color)}>{config.label}</span>
   346â†’      <span className="text-text-primary text-xs">${signal.symbol}</span>
   347â†’      {signal.pnlPercent !== undefined && (
   348â†’        <span className={cn("text-xs", signal.pnlPercent >= 0 ? "text-green-400" : "text-red-400")}>
   349â†’          {signal.pnlPercent >= 0 ? "+" : ""}
   350â†’          {signal.pnlPercent.toFixed(1)}%
   351â†’        </span>
   352â†’      )}
   353â†’    </div>
   354â†’  );
   355â†’};
   356â†’
   357â†’// Token Row Component
   358â†’const TokenRow = ({ token }: { token: WatchedToken }) => {
   359â†’  const change = token.change1h ?? 0;
   360â†’  const isPositive = change >= 0;
   361â†’
   362â†’  return (
   363â†’    <div className={cn(
   364â†’      "flex items-center justify-between rounded px-2 py-1.5 text-xs",
   365â†’      token.hasPosition ? "bg-cyan-500/10 border border-cyan-500/20" : "bg-bg-tertiary/30"
   366â†’    )}>
   367â†’      <div className="flex items-center gap-2">
   368â†’        <span className="text-text-primary font-medium">${token.symbol}</span>
   369â†’        {token.hasPosition && (
   370â†’          <span className="text-[8px] text-cyan-400 font-semibold">OPEN</span>
   371â†’        )}
   372â†’      </div>
   373â†’      <div className="flex items-center gap-3">
   374â†’        {token.priceUsd !== undefined && (
   375â†’          <span className="text-text-secondary">
   376â†’            ${token.priceUsd < 0.01 ? token.priceUsd.toExponential(2) : token.priceUsd.toFixed(4)}
   377â†’          </span>
   378â†’        )}
   379â†’        <span className={cn("font-medium", isPositive ? "text-green-400" : "text-red-400")}>
   380â†’          {isPositive ? "+" : ""}{change.toFixed(1)}%
   381â†’        </span>
   382â†’      </div>
   383â†’    </div>
   384â†’  );
   385â†’};
   386â†’
   387â†’// Token List Section Component
   388â†’const TokenListSection = ({
   389â†’  title,
   390â†’  icon: Icon,
   391â†’  tokens,
   392â†’  iconColor
   393â†’}: {
   394â†’  title: string;
   395â†’  icon: React.ElementType;
   396â†’  tokens: WatchedToken[];
   397â†’  iconColor: string;
   398â†’}) => {
   399â†’  if (tokens.length === 0) return null;
   400â†’
   401â†’  return (
   402â†’    <div className="flex-shrink-0">
   403â†’      <div className="text-text-secondary mb-1.5 flex items-center gap-2 text-xs font-medium">
   404â†’        <Icon className={cn("h-3.5 w-3.5", iconColor)} />
   405â†’        {title} ({tokens.length})
   406â†’      </div>
   407â†’      <div className="max-h-32 space-y-1 overflow-auto">
   408â†’        {tokens.map((token) => (
   409â†’          <TokenRow key={token.mint} token={token} />
   410â†’        ))}
   411â†’      </div>
   412â†’    </div>
   413â†’  );
   414â†’};
   415â†’
   416â†’// Controls Panel Component
   417â†’const ControlsPanel = ({
   418â†’  config,
   419â†’  sendCommand,
   420â†’  isConnected,
   421â†’}: {
   422â†’  config: ConfigData;
   423â†’  sendCommand: (cmd: AutopilotCommand) => void;
   424â†’  isConnected: boolean;
   425â†’}) => {
   426â†’  const [showControls, setShowControls] = useState(false);
   427â†’
   428â†’  return (
   429â†’    <div className="border-border-primary bg-bg-tertiary/30 rounded-lg border">
   430â†’      {/* Header - always visible */}
   431â†’      <button
   432â†’        onClick={() => setShowControls(!showControls)}
   433â†’        className="flex w-full items-center justify-between px-3 py-2 text-xs"
   434â†’        disabled={!isConnected}
   435â†’      >
   436â†’        <div className="flex items-center gap-2">
   437â†’          <Settings className="h-3.5 w-3.5 text-text-secondary" />
   438â†’          <span className="text-text-secondary font-medium">Controls</span>
   439â†’        </div>
   440â†’        <div className="flex items-center gap-2">
   441â†’          <span className={cn(
   442â†’            "rounded px-1.5 py-0.5 text-[10px] font-semibold",
   443â†’            config.mode === "paper" ? "bg-yellow-500/20 text-yellow-400" : "bg-green-500/20 text-green-400"
   444â†’          )}>
   445â†’            {config.mode.toUpperCase()}
   446â†’          </span>
   447â†’          <span className="text-text-tertiary">{showControls ? "â–²" : "â–¼"}</span>
   448â†’        </div>
   449â†’      </button>
   450â†’
   451â†’      {/* Expandable controls */}
   452â†’      {showControls && (
   453â†’        <div className="border-t border-border-primary/50 px-3 py-2 space-y-3">
   454â†’          {/* Mode Toggle - Disabled until LOIS integration */}
   455â†’          <Tooltip
   456â†’            content="Live trading integration coming soon. Invite only ðŸ”’"
   457â†’            side="left"
   458â†’            triggerClassName="w-full"
   459â†’          >
   460â†’            <div className="flex w-full items-center justify-between opacity-50 cursor-not-allowed">
   461â†’              <div className="flex items-center gap-2">
   462â†’                <Power className="h-3.5 w-3.5 text-text-secondary" />
   463â†’                <span className="text-xs text-text-secondary">Live Trading</span>
   464â†’              </div>
   465â†’              <Switch
   466â†’                size="sm"
   467â†’                checked={false}
   468â†’                disabled
   469â†’              />
   470â†’            </div>
   471â†’          </Tooltip>
   472â†’
   473â†’          {/* Auto Sources Toggle */}
   474â†’          <div className="flex items-center justify-between">
   475â†’            <div className="flex items-center gap-2">
   476â†’              <Eye className="h-3.5 w-3.5 text-blue-400" />
   477â†’              <span className="text-xs text-text-secondary">Auto Sources</span>
   478â†’            </div>
   479â†’            <Switch
   480â†’              size="sm"
   481â†’              checked={config.autoSourcesEnabled}
   482â†’              onCheckedChange={(checked) => sendCommand({ command: "toggle_sources", enabled: checked })}
   483â†’            />
   484â†’          </div>
   485â†’
   486â†’          {/* Trending Toggle */}
   487â†’          {config.autoSourcesEnabled && (
   488â†’            <div className="flex items-center justify-between pl-5">
   489â†’              <div className="flex items-center gap-2">
   490â†’                <Flame className="h-3 w-3 text-orange-400" />
   491â†’                <span className="text-[11px] text-text-tertiary">Trending</span>
   492â†’              </div>
   493â†’              <Switch
   494â†’                size="sm"
   495â†’                checked={config.trendingEnabled}
   496â†’                onCheckedChange={(checked) => sendCommand({ command: "toggle_trending", enabled: checked })}
   497â†’              />
   498â†’            </div>
   499â†’          )}
   500â†’
   501â†’          {/* Whales Toggle */}
   502â†’          {config.autoSourcesEnabled && (
   503â†’            <div className="flex items-center justify-between pl-5">
   504â†’              <div className="flex items-center gap-2">
   505â†’                <Wallet className="h-3 w-3 text-green-400" />
   506â†’                <span className="text-[11px] text-text-tertiary">Whale Moves</span>
   507â†’              </div>
   508â†’              <Switch
   509â†’                size="sm"
   510â†’                checked={config.whalesEnabled}
   511â†’                onCheckedChange={(checked) => sendCommand({ command: "toggle_whales", enabled: checked })}
   512â†’              />
   513â†’            </div>
   514â†’          )}
   515â†’
   516â†’          {/* Market Filter Toggle */}
   517â†’          <div className="flex items-center justify-between">
   518â†’            <div className="flex items-center gap-2">
   519â†’              <ShieldAlert className="h-3.5 w-3.5 text-purple-400" />
   520â†’              <span className="text-xs text-text-secondary">Market Filter</span>
   521â†’            </div>
   522â†’            <Switch
   523â†’              size="sm"
   524â†’              checked={config.marketFilterEnabled}
   525â†’              onCheckedChange={(checked) => sendCommand({ command: "toggle_filter", enabled: checked })}
   526â†’            />
   527â†’          </div>
   528â†’
   529â†’          {/* Refresh Sources Button */}
   530â†’          <button
   531â†’            onClick={() => sendCommand({ command: "refresh_sources" })}
   532â†’            className="flex w-full items-center justify-center gap-2 rounded bg-bg-tertiary/50 px-3 py-1.5 text-xs text-text-secondary hover:bg-bg-tertiary transition-colors"
   533â†’          >
   534â†’            <RefreshCw className="h-3 w-3" />
   535â†’            Refresh Sources
   536â†’          </button>
   537â†’
   538â†’          {/* Position Size Display */}
   539â†’          <div className="flex items-center justify-between text-[10px] text-text-tertiary pt-1 border-t border-border-primary/30">
   540â†’            <span>Position Size</span>
   541â†’            <span>{config.positionSizeSol} SOL</span>
   542â†’          </div>
   543â†’        </div>
   544â†’      )}
   545â†’    </div>
   546â†’  );
   547â†’};
   548â†’
   549â†’// Strategies Panel Component
   550â†’const StrategiesPanel = ({
   551â†’  strategies,
   552â†’  sendCommand,
   553â†’  isConnected,
   554â†’}: {
   555â†’  strategies: StrategiesData;
   556â†’  sendCommand: (cmd: AutopilotCommand) => void;
   557â†’  isConnected: boolean;
   558â†’}) => {
   559â†’  const [showStrategies, setShowStrategies] = useState(false);
   560â†’  const activeSet = new Set(strategies.active);
   561â†’
   562â†’  return (
   563â†’    <div className="border-border-primary bg-bg-tertiary/30 rounded-lg border">
   564â†’      {/* Header - always visible */}
   565â†’      <button
   566â†’        onClick={() => setShowStrategies(!showStrategies)}
   567â†’        className="flex w-full items-center justify-between px-3 py-2 text-xs"
   568â†’        disabled={!isConnected}
   569â†’      >
   570â†’        <div className="flex items-center gap-2">
   571â†’          <Layers className="h-3.5 w-3.5 text-text-secondary" />
   572â†’          <span className="text-text-secondary font-medium">Strategies</span>
   573â†’        </div>
   574â†’        <div className="flex items-center gap-2">
   575â†’          <span className={cn(
   576â†’            "rounded px-1.5 py-0.5 text-[10px] font-semibold",
   577â†’            strategies.active.length > 0 ? "bg-green-500/20 text-green-400" : "bg-gray-500/20 text-gray-400"
   578â†’          )}>
   579â†’            {strategies.active.length} ACTIVE
   580â†’          </span>
   581â†’          <span className="text-text-tertiary">{showStrategies ? "â–²" : "â–¼"}</span>
   582â†’        </div>
   583â†’      </button>
   584â†’
   585â†’      {/* Expandable strategies list */}
   586â†’      {showStrategies && (
   587â†’        <div className="border-t border-border-primary/50 px-3 py-2 space-y-2">
   588â†’          {strategies.available.length === 0 ? (
   589â†’            <div className="text-text-tertiary text-xs text-center py-2">
   590â†’              No strategies available
   591â†’            </div>
   592â†’          ) : (
   593â†’            strategies.available.map((strategy) => {
   594â†’              const isActive = activeSet.has(strategy.id);
   595â†’              return (
   596â†’                <button
   597â†’                  key={strategy.id}
   598â†’                  onClick={() => sendCommand({ command: "toggle_strategy", strategyId: strategy.id, enabled: !isActive })}
   599â†’                  className={cn(
   600â†’                    "w-full flex items-start gap-2 rounded px-2 py-2 text-left transition-colors",
   601â†’                    isActive
   602â†’                      ? "bg-green-500/10 border border-green-500/30 hover:bg-green-500/20"
   603â†’                      : "bg-bg-tertiary/50 border border-transparent hover:bg-bg-tertiary"
   604â†’                  )}
   605â†’                >
   606â†’                  <div className="flex-shrink-0 mt-0.5">
   607â†’                    {isActive ? (
   608â†’                      <CheckCircle2 className="h-4 w-4 text-green-400" />
   609â†’                    ) : (
   610â†’                      <Circle className="h-4 w-4 text-text-tertiary" />
   611â†’                    )}
   612â†’                  </div>
   613â†’                  <div className="flex-1 min-w-0">
   614â†’                    <div className="flex items-center gap-2">
   615â†’                      <span className={cn(
   616â†’                        "text-xs font-medium",
   617â†’                        isActive ? "text-green-400" : "text-text-primary"
   618â†’                      )}>
   619â†’                        {strategy.name}
   620â†’                      </span>
   621â†’                      <span className={cn(
   622â†’                        "text-[9px] px-1 py-0.5 rounded",
   623â†’                        strategy.mode === "all"
   624â†’                          ? "bg-blue-500/20 text-blue-400"
   625â†’                          : "bg-purple-500/20 text-purple-400"
   626â†’                      )}>
   627â†’                        {strategy.mode.toUpperCase()}
   628â†’                      </span>
   629â†’                    </div>
   630â†’                    <div className="text-[10px] text-text-tertiary truncate">
   631â†’                      {strategy.summary}
   632â†’                    </div>
   633â†’                  </div>
   634â†’                </button>
   635â†’              );
   636â†’            })
   637â†’          )}
   638â†’        </div>
   639â†’      )}
   640â†’    </div>
   641â†’  );
   642â†’};
   643â†’
   644â†’// Stats Panel Component
   645â†’const StatsPanel = ({ stats }: { stats: StatsData }) => {
   646â†’  const isProfit = stats.totalPnlSol >= 0;
   647â†’
   648â†’  return (
   649â†’    <div className="border-border-primary bg-bg-tertiary/30 grid grid-cols-4 gap-2 rounded-lg border p-3">
   650â†’      <div className="text-center">
   651â†’        <div className="text-text-primary text-lg font-bold">{stats.closedTrades}</div>
   652â†’        <div className="text-text-secondary text-[10px]">Trades</div>
   653â†’      </div>
   654â†’      <div className="text-center">
   655â†’        <div className={cn("text-lg font-bold", stats.winRate >= 0.5 ? "text-green-400" : "text-red-400")}>
   656â†’          {(stats.winRate * 100).toFixed(0)}%
   657â†’        </div>
   658â†’        <div className="text-text-secondary text-[10px]">Win Rate</div>
   659â†’      </div>
   660â†’      <div className="text-center">
   661â†’        <div className="text-text-primary text-lg font-bold">
   662â†’          {stats.wins}W/{stats.losses}L
   663â†’        </div>
   664â†’        <div className="text-text-secondary text-[10px]">Record</div>
   665â†’      </div>
   666â†’      <div className="text-center">
   667â†’        <div className={cn("text-lg font-bold", isProfit ? "text-green-400" : "text-red-400")}>
   668â†’          {isProfit ? "+" : ""}
   669â†’          <FormattedNumber value={stats.totalPnlSol} decimals={2} />
   670â†’        </div>
   671â†’        <div className="text-text-secondary text-[10px]">P&L (SOL)</div>
   672â†’      </div>
   673â†’    </div>
   674â†’  );
   675â†’};
   676â†’
   677â†’// Main Autopilot Widget Component
   678â†’export const AutopilotWidget = () => {
   679â†’  const { positions, signals, marketStatus, stats, scanTick, tokenList, config, strategies, isConnected, sendCommand } = useAutopilotWebSocket();
   680â†’
   681â†’  const totalTokens = tokenList.watchlist.length + tokenList.trending.length + tokenList.whales.length;
   682â†’
   683â†’  return (
   684â†’    <div className="flex h-full flex-col gap-3 overflow-hidden">
   685â†’      {/* Header - Market Status */}
   686â†’      <div className="flex items-center justify-between">
   687â†’        <div className="flex items-center gap-2">
   688â†’          <Bot className={cn("h-5 w-5", isConnected ? "text-green-400" : "text-red-400")} />
   689â†’          <span className="text-text-primary text-sm font-semibold">Token Autopilot</span>
   690â†’          {scanTick && (
   691â†’            <span className="text-text-secondary text-[10px]">
   692â†’              #{scanTick.scanNumber} | {totalTokens} tokens
   693â†’            </span>
   694â†’          )}
   695â†’        </div>
   696â†’        <MarketStatusBadge status={marketStatus} />
   697â†’      </div>
   698â†’
   699â†’      {/* Connection Status (shown when disconnected) */}
   700â†’      {!isConnected && (
   701â†’        <div className="bg-yellow-500/10 border-yellow-500/30 flex items-center gap-2 rounded-lg border px-3 py-2">
   702â†’          <AlertTriangle className="h-4 w-4 text-yellow-400" />
   703â†’          <span className="text-xs text-yellow-400">Connecting to autopilot backend...</span>
   704â†’        </div>
   705â†’      )}
   706â†’
   707â†’      {/* Controls Panel */}
   708â†’      <ControlsPanel config={config} sendCommand={sendCommand} isConnected={isConnected} />
   709â†’
   710â†’      {/* Strategies Panel */}
   711â†’      <StrategiesPanel strategies={strategies} sendCommand={sendCommand} isConnected={isConnected} />
   712â†’
   713â†’      {/* Stats Panel */}
   714â†’      <StatsPanel stats={stats} />
   715â†’
   716â†’      {/* Open Positions */}
   717â†’      {positions.length > 0 && (
   718â†’        <div className="flex-shrink-0">
   719â†’          <div className="text-text-secondary mb-2 flex items-center gap-2 text-xs font-medium">
   720â†’            <Target className="h-3.5 w-3.5" />
   721â†’            Open Positions ({positions.length})
   722â†’          </div>
   723â†’          <div className="max-h-40 space-y-2 overflow-auto">
   724â†’            {positions.map((pos) => (
   725â†’              <PositionCard key={pos.mint} position={pos} />
   726â†’            ))}
   727â†’          </div>
   728â†’        </div>
   729â†’      )}
   730â†’
   731â†’      {/* Watched Token Lists - Main scrollable area */}
   732â†’      <div className="flex min-h-0 flex-1 flex-col gap-3 overflow-auto">
   733â†’        {/* Watchlist */}
   734â†’        <TokenListSection
   735â†’          title="Watchlist"
   736â†’          icon={Eye}
   737â†’          tokens={tokenList.watchlist}
   738â†’          iconColor="text-blue-400"
   739â†’        />
   740â†’
   741â†’        {/* Trending */}
   742â†’        <TokenListSection
   743â†’          title="Trending"
   744â†’          icon={Flame}
   745â†’          tokens={tokenList.trending}
   746â†’          iconColor="text-orange-400"
   747â†’        />
   748â†’
   749â†’        {/* Whale Moves */}
   750â†’        <TokenListSection
   751â†’          title="Whale Moves"
   752â†’          icon={Wallet}
   753â†’          tokens={tokenList.whales}
   754â†’          iconColor="text-green-400"
   755â†’        />
   756â†’
   757â†’        {/* Empty state if no tokens */}
   758â†’        {totalTokens === 0 && isConnected && (
   759â†’          <div className="text-text-secondary border-border-primary/50 rounded-lg border border-dashed p-4 text-center text-xs">
   760â†’            No tokens being watched. Enable auto-sources or add to watchlist.
   761â†’          </div>
   762â†’        )}
   763â†’      </div>
   764â†’
   765â†’      {/* Signal Feed - Collapsible at bottom */}
   766â†’      {signals.length > 0 && (
   767â†’        <div className="flex-shrink-0 border-t border-border-primary/30 pt-2">
   768â†’          <div className="text-text-secondary mb-1.5 flex items-center gap-2 text-xs font-medium">
   769â†’            <Zap className="h-3.5 w-3.5" />
   770â†’            Recent Signals
   771â†’          </div>
   772â†’          <div className="max-h-24 overflow-auto">
   773â†’            <div className="space-y-0">
   774â†’              {signals.slice(0, 5).map((signal, idx) => (
   775â†’                <SignalItem key={`${signal.timestamp}-${idx}`} signal={signal} />
   776â†’              ))}
   777â†’            </div>
   778â†’          </div>
   779â†’        </div>
   780â†’      )}
   781â†’    </div>
   782â†’  );
   783â†’};
   784â†’
   785â†’export default AutopilotWidget;
   786â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
