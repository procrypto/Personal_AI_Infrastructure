     1â†’# Hook System
     2â†’
     3â†’**Event-Driven Automation Infrastructure**
     4â†’
     5â†’**Location:** `${PAI_DIR}/Hooks/`
     6â†’**Configuration:** `${PAI_DIR}/settings.json`
     7â†’**Status:** Active - All hooks running in production
     8â†’
     9â†’---
    10â†’
    11â†’## Overview
    12â†’
    13â†’The PAI hook system is an event-driven automation infrastructure built on Claude Code's native hook support. Hooks are executable scripts (TypeScript/Python) that run automatically in response to specific events during Claude Code sessions.
    14â†’
    15â†’**Core Capabilities:**
    16â†’- **Session Management** - Auto-load context, capture summaries, manage state
    17â†’- **Voice Notifications** - Text-to-speech announcements for task completions
    18â†’- **History Capture** - Automatic work/learning documentation to `${PAI_DIR}/History/`
    19â†’- **Multi-Agent Support** - Agent-specific hooks with voice routing
    20â†’- **Observability** - Real-time event streaming to dashboard
    21â†’- **Tab Titles** - Dynamic terminal tab updates with task context
    22â†’
    23â†’**Key Principle:** Hooks run asynchronously and fail gracefully. They enhance the user experience but never block Claude Code's core functionality.
    24â†’
    25â†’---
    26â†’
    27â†’## Available Hook Types
    28â†’
    29â†’Claude Code supports the following hook events (from `${PAI_DIR}/Hooks/lib/observability.ts`):
    30â†’
    31â†’### 1. **SessionStart**
    32â†’**When:** Claude Code session begins (new conversation)
    33â†’**Use Cases:**
    34â†’- Load PAI context from `skills/CORE/SKILL.md`
    35â†’- Initialize session state
    36â†’- Capture session metadata
    37â†’
    38â†’**Current Hooks:**
    39â†’```typescript
    40â†’{
    41â†’  "SessionStart": [
    42â†’    {
    43â†’      "hooks": [
    44â†’        {
    45â†’          "type": "command",
    46â†’          "command": "${PAI_DIR}/Hooks/load-core-context.ts"
    47â†’        },
    48â†’        {
    49â†’          "type": "command",
    50â†’          "command": "${PAI_DIR}/Hooks/initialize-pai-session.ts"
    51â†’        },
    52â†’        {
    53â†’          "type": "command",
    54â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type SessionStart"
    55â†’        }
    56â†’      ]
    57â†’    }
    58â†’  ]
    59â†’}
    60â†’```
    61â†’
    62â†’**What They Do:**
    63â†’- `load-core-context.ts` - Reads `skills/CORE/SKILL.md` and injects PAI context as `<system-reminder>` at session start
    64â†’- `initialize-pai-session.ts` - Sets up session state and environment
    65â†’- `capture-all-events.ts` - Logs event to `${PAI_DIR}/History/raw-outputs/YYYY-MM/YYYY-MM-DD_all-events.jsonl`
    66â†’
    67â†’---
    68â†’
    69â†’### 2. **SessionEnd**
    70â†’**When:** Claude Code session terminates (conversation ends)
    71â†’**Use Cases:**
    72â†’- Generate session summaries
    73â†’- Save session metadata
    74â†’- Cleanup temporary state
    75â†’
    76â†’**Current Hooks:**
    77â†’```typescript
    78â†’{
    79â†’  "SessionEnd": [
    80â†’    {
    81â†’      "hooks": [
    82â†’        {
    83â†’          "type": "command",
    84â†’          "command": "${PAI_DIR}/Hooks/capture-session-summary.ts"
    85â†’        },
    86â†’        {
    87â†’          "type": "command",
    88â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type SessionEnd"
    89â†’        }
    90â†’      ]
    91â†’    }
    92â†’  ]
    93â†’}
    94â†’```
    95â†’
    96â†’**What They Do:**
    97â†’- `capture-session-summary.ts` - Analyzes session activity and creates summary document in `${PAI_DIR}/History/sessions/YYYY-MM/`
    98â†’- Captures: files changed, commands executed, tools used, session focus, duration
    99â†’
   100â†’---
   101â†’
   102â†’### 3. **UserPromptSubmit**
   103â†’**When:** User submits a new prompt to Claude
   104â†’**Use Cases:**
   105â†’- Update UI indicators
   106â†’- Pre-process user input
   107â†’- Capture prompts for analysis
   108â†’
   109â†’**Current Hooks:**
   110â†’```typescript
   111â†’{
   112â†’  "UserPromptSubmit": [
   113â†’    {
   114â†’      "hooks": [
   115â†’        {
   116â†’          "type": "command",
   117â†’          "command": "${PAI_DIR}/Hooks/update-tab-titles.ts"
   118â†’        },
   119â†’        {
   120â†’          "type": "command",
   121â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type UserPromptSubmit"
   122â†’        }
   123â†’      ]
   124â†’    }
   125â†’  ]
   126â†’}
   127â†’```
   128â†’
   129â†’**What They Do:**
   130â†’- `update-tab-titles.ts` - Updates Kitty terminal tab title with task summary
   131â†’- Launches background Haiku summarization for better tab titles
   132â†’- Sets `â™»ï¸` emoji prefix to indicate processing
   133â†’
   134â†’---
   135â†’
   136â†’### 4. **Stop**
   137â†’**When:** Main agent (Kai) completes a response
   138â†’**Use Cases:**
   139â†’- Voice notifications for task completion
   140â†’- Capture work summaries and learnings
   141â†’- Update terminal tab with completion status
   142â†’
   143â†’**Current Hooks:**
   144â†’```typescript
   145â†’{
   146â†’  "Stop": [
   147â†’    {
   148â†’      "hooks": [
   149â†’        {
   150â†’          "type": "command",
   151â†’          "command": "${PAI_DIR}/Hooks/stop-hook.ts"
   152â†’        },
   153â†’        {
   154â†’          "type": "command",
   155â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type Stop"
   156â†’        }
   157â†’      ]
   158â†’    }
   159â†’  ]
   160â†’}
   161â†’```
   162â†’
   163â†’**What They Do:**
   164â†’- `stop-hook.ts` - THE CRITICAL HOOK for main agent completions
   165â†’  - Extracts `ðŸŽ¯ COMPLETED:` line from response
   166â†’  - Sends to voice server with PAI's voice ID (`s3TPKV1kjDlVtZbl4Ksh`)
   167â†’  - Captures work summaries to `${PAI_DIR}/History/sessions/YYYY-MM/` or learnings to `${PAI_DIR}/History/learnings/YYYY-MM/`
   168â†’  - Updates Kitty tab with `âœ…` prefix
   169â†’  - Sends event to observability dashboard
   170â†’
   171â†’**Learning Detection:** Automatically identifies learning moments (2+ indicators: problem/issue/bug, fixed/solved, troubleshoot/debug, lesson/takeaway)
   172â†’
   173â†’---
   174â†’
   175â†’### 5. **SubagentStop**
   176â†’**When:** Subagent (Task tool) completes execution
   177â†’**Use Cases:**
   178â†’- Agent-specific voice notifications
   179â†’- Capture agent outputs
   180â†’- Track multi-agent workflows
   181â†’
   182â†’**Current Hooks:**
   183â†’```typescript
   184â†’{
   185â†’  "SubagentStop": [
   186â†’    {
   187â†’      "hooks": [
   188â†’        {
   189â†’          "type": "command",
   190â†’          "command": "${PAI_DIR}/Hooks/subagent-stop-hook.ts"
   191â†’        },
   192â†’        {
   193â†’          "type": "command",
   194â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type SubagentStop"
   195â†’        }
   196â†’      ]
   197â†’    }
   198â†’  ]
   199â†’}
   200â†’```
   201â†’
   202â†’**What They Do:**
   203â†’- `subagent-stop-hook.ts` - Agent-specific completion handling
   204â†’  - Waits for Task tool result in transcript
   205â†’  - Extracts `[AGENT:type]` tag and completion message
   206â†’  - Routes to agent-specific voice (via agent's own voice notification in response)
   207â†’  - Captures agent output to appropriate history category
   208â†’  - Sends to observability dashboard
   209â†’
   210â†’**Agent-Specific Routing:**
   211â†’- `[AGENT:engineer]` â†’ Engineer voice ID
   212â†’- `[AGENT:researcher]` â†’ Researcher voice ID
   213â†’- `[AGENT:pentester]` â†’ Pentester voice ID
   214â†’- etc.
   215â†’
   216â†’---
   217â†’
   218â†’### 6. **PreToolUse**
   219â†’**When:** Before Claude executes any tool
   220â†’**Use Cases:**
   221â†’- Tool usage analytics
   222â†’- Pre-execution validation
   223â†’- Performance monitoring
   224â†’
   225â†’**Current Hooks:**
   226â†’```typescript
   227â†’{
   228â†’  "PreToolUse": [
   229â†’    {
   230â†’      "matcher": "*",
   231â†’      "hooks": [
   232â†’        {
   233â†’          "type": "command",
   234â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type PreToolUse"
   235â†’        }
   236â†’      ]
   237â†’    }
   238â†’  ]
   239â†’}
   240â†’```
   241â†’
   242â†’**What They Do:**
   243â†’- Captures tool name, input parameters, timestamp
   244â†’- Logs to daily events file for analysis
   245â†’
   246â†’---
   247â†’
   248â†’### 7. **PostToolUse**
   249â†’**When:** After Claude executes any tool
   250â†’**Use Cases:**
   251â†’- Capture tool outputs
   252â†’- Error tracking
   253â†’- Performance metrics
   254â†’
   255â†’**Current Hooks:**
   256â†’```typescript
   257â†’{
   258â†’  "PostToolUse": [
   259â†’    {
   260â†’      "matcher": "*",
   261â†’      "hooks": [
   262â†’        {
   263â†’          "type": "command",
   264â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type PostToolUse"
   265â†’        }
   266â†’      ]
   267â†’    }
   268â†’  ]
   269â†’}
   270â†’```
   271â†’
   272â†’**What They Do:**
   273â†’- Captures tool output, execution time, success/failure
   274â†’- Logs to `${PAI_DIR}/History/raw-outputs/YYYY-MM/YYYY-MM-DD_all-events.jsonl`
   275â†’- Powers observability dashboard
   276â†’
   277â†’---
   278â†’
   279â†’### 8. **PreCompact**
   280â†’**When:** Before Claude compacts context (long conversations)
   281â†’**Use Cases:**
   282â†’- Preserve important context
   283â†’- Log compaction events
   284â†’- Pre-compaction cleanup
   285â†’
   286â†’**Current Hooks:**
   287â†’```typescript
   288â†’{
   289â†’  "PreCompact": [
   290â†’    {
   291â†’      "matcher": "",
   292â†’      "hooks": [
   293â†’        {
   294â†’          "type": "command",
   295â†’          "command": "${PAI_DIR}/Hooks/context-compression-hook.ts"
   296â†’        },
   297â†’        {
   298â†’          "type": "command",
   299â†’          "command": "${PAI_DIR}/Hooks/capture-all-events.ts --event-type PreCompact"
   300â†’        }
   301â†’      ]
   302â†’    }
   303â†’  ]
   304â†’}
   305â†’```
   306â†’
   307â†’**What They Do:**
   308â†’- `context-compression-hook.ts` - Handles context preservation before compaction
   309â†’- Captures metadata about compaction events
   310â†’
   311â†’---
   312â†’
   313â†’## Configuration
   314â†’
   315â†’### Location
   316â†’**File:** `${PAI_DIR}/settings.json`
   317â†’**Section:** `"hooks": { ... }`
   318â†’
   319â†’### Environment Variables
   320â†’Hooks have access to all environment variables from `${PAI_DIR}/settings.json` `"env"` section:
   321â†’
   322â†’```json
   323â†’{
   324â†’  "env": {
   325â†’    "PAI_DIR": "/Users/daniel/.claude",
   326â†’    "DA": "Kai",
   327â†’    "MCP_API_KEY": "...",
   328â†’    "CLAUDE_CODE_MAX_OUTPUT_TOKENS": "64000"
   329â†’  }
   330â†’}
   331â†’```
   332â†’
   333â†’**Key Variables:**
   334â†’- `PAI_DIR` - PAI installation directory (always `/Users/daniel/.claude`)
   335â†’- `DA` - Digital Assistant name ("Kai")
   336â†’- Hook scripts reference `${PAI_DIR}` in command paths
   337â†’
   338â†’### Hook Configuration Structure
   339â†’
   340â†’```json
   341â†’{
   342â†’  "hooks": {
   343â†’    "HookEventName": [
   344â†’      {
   345â†’        "matcher": "pattern",  // Optional: filter which tools/events trigger hook
   346â†’        "hooks": [
   347â†’          {
   348â†’            "type": "command",
   349â†’            "command": "${PAI_DIR}/Hooks/my-hook.ts --arg value"
   350â†’          }
   351â†’        ]
   352â†’      }
   353â†’    ]
   354â†’  }
   355â†’}
   356â†’```
   357â†’
   358â†’**Fields:**
   359â†’- `HookEventName` - One of: SessionStart, SessionEnd, UserPromptSubmit, Stop, SubagentStop, PreToolUse, PostToolUse, PreCompact
   360â†’- `matcher` - Pattern to match (use `"*"` for all tools, or specific tool names)
   361â†’- `type` - Always `"command"` (executes external script)
   362â†’- `command` - Path to executable hook script (TypeScript/Python/Bash)
   363â†’
   364â†’### Hook Input (stdin)
   365â†’All hooks receive JSON data on stdin:
   366â†’
   367â†’```typescript
   368â†’{
   369â†’  session_id: string;         // Unique session identifier
   370â†’  transcript_path: string;    // Path to JSONL transcript
   371â†’  hook_event_name: string;    // Event that triggered hook
   372â†’  prompt?: string;            // User prompt (UserPromptSubmit only)
   373â†’  tool_name?: string;         // Tool name (PreToolUse/PostToolUse)
   374â†’  tool_input?: any;           // Tool parameters (PreToolUse)
   375â†’  tool_output?: any;          // Tool result (PostToolUse)
   376â†’  // ... event-specific fields
   377â†’}
   378â†’```
   379â†’
   380â†’---
   381â†’
   382â†’## Common Patterns
   383â†’
   384â†’### 1. Voice Notifications
   385â†’
   386â†’**Pattern:** Extract completion message â†’ Send to voice server
   387â†’
   388â†’```typescript
   389â†’// stop-hook.ts pattern
   390â†’const completionMessage = extractKaiCompletion(lastMessage);
   391â†’
   392â†’const payload = {
   393â†’  title: 'PAI',
   394â†’  message: completionMessage,
   395â†’  voice_enabled: true,
   396â†’  voice_id: 's3TPKV1kjDlVtZbl4Ksh'  // PAI's ElevenLabs voice
   397â†’};
   398â†’
   399â†’await fetch('http://localhost:8888/notify', {
   400â†’  method: 'POST',
   401â†’  headers: { 'Content-Type': 'application/json' },
   402â†’  body: JSON.stringify(payload)
   403â†’});
   404â†’```
   405â†’
   406â†’**Agent-Specific Voices:**
   407â†’- Main agent (PAI): `s3TPKV1kjDlVtZbl4Ksh`
   408â†’- Engineer: `fATgBRI8wg5KkDFg8vBd`
   409â†’- Researcher: `AXdMgz6evoL7OPd7eU12`
   410â†’- Pentester: `xvHLFjaUEpx4BOf7EiDd`
   411â†’- Intern: `d3MFdIuCfbAIwiu7jC4a`
   412â†’
   413â†’See `skills/CORE/SKILL.md` for complete voice ID mapping.
   414â†’
   415â†’---
   416â†’
   417â†’### 2. History Capture (UOCS Pattern)
   418â†’
   419â†’**Pattern:** Parse structured response â†’ Save to appropriate history directory
   420â†’
   421â†’**File Naming Convention:**
   422â†’```
   423â†’YYYY-MM-DD-HHMMSS_TYPE_description.md
   424â†’```
   425â†’
   426â†’**Types:**
   427â†’- `WORK` - General task completions
   428â†’- `LEARNING` - Problem-solving learnings
   429â†’- `SESSION` - Session summaries
   430â†’- `RESEARCH` - Research findings (from agents)
   431â†’- `FEATURE` - Feature implementations (from agents)
   432â†’- `DECISION` - Architectural decisions (from agents)
   433â†’
   434â†’**Example from stop-hook.ts:**
   435â†’```typescript
   436â†’const structured = extractStructuredSections(lastMessage);
   437â†’const isLearning = isLearningCapture(text, structured);
   438â†’const captureType = isLearning ? 'LEARNING' : 'WORK';
   439â†’
   440â†’const targetDir = isLearning
   441â†’  ? join(baseDir, 'history', 'learnings', yearMonth)
   442â†’  : join(baseDir, 'history', 'sessions', yearMonth);
   443â†’
   444â†’const filename = generateFilename(description, captureType);
   445â†’writeFileSync(join(targetDir, filename), content);
   446â†’```
   447â†’
   448â†’**Structured Sections Parsed:**
   449â†’- `ðŸ“‹ SUMMARY:` - Brief overview
   450â†’- `ðŸ” ANALYSIS:` - Key findings
   451â†’- `âš¡ ACTIONS:` - Steps taken
   452â†’- `âœ… RESULTS:` - Outcomes
   453â†’- `ðŸ“Š STATUS:` - Current state
   454â†’- `âž¡ï¸ NEXT:` - Follow-up actions
   455â†’- `ðŸŽ¯ COMPLETED:` - **Voice notification line**
   456â†’
   457â†’---
   458â†’
   459â†’### 3. Agent Type Detection
   460â†’
   461â†’**Pattern:** Identify which agent is executing â†’ Route appropriately
   462â†’
   463â†’```typescript
   464â†’// From capture-all-events.ts
   465â†’let agentName = getAgentForSession(sessionId);
   466â†’
   467â†’// Detect from Task tool
   468â†’if (hookData.tool_name === 'Task' && hookData.tool_input?.subagent_type) {
   469â†’  agentName = hookData.tool_input.subagent_type;
   470â†’  setAgentForSession(sessionId, agentName);
   471â†’}
   472â†’
   473â†’// Detect from CLAUDE_CODE_AGENT env variable
   474â†’else if (process.env.CLAUDE_CODE_AGENT) {
   475â†’  agentName = process.env.CLAUDE_CODE_AGENT;
   476â†’}
   477â†’
   478â†’// Detect from path (subagents run in /Agents/name/)
   479â†’else if (hookData.cwd && hookData.cwd.includes('/Agents/')) {
   480â†’  const agentMatch = hookData.cwd.match(/\/agents\/([^\/]+)/);
   481â†’  if (agentMatch) agentName = agentMatch[1];
   482â†’}
   483â†’```
   484â†’
   485â†’**Session Mapping:** `${PAI_DIR}/agent-sessions.json`
   486â†’```json
   487â†’{
   488â†’  "session-id-abc123": "engineer",
   489â†’  "session-id-def456": "researcher"
   490â†’}
   491â†’```
   492â†’
   493â†’---
   494â†’
   495â†’### 4. Observability Integration
   496â†’
   497â†’**Pattern:** Send event to dashboard â†’ Fail silently if offline
   498â†’
   499â†’```typescript
   500â†’import { sendEventToObservability, getCurrentTimestamp, getSourceApp } from './lib/observability';
   501â†’
   502â†’await sendEventToObservability({
   503â†’  source_app: getSourceApp(),           // 'PAI' or agent name
   504â†’  session_id: hookInput.session_id,
   505â†’  hook_event_type: 'Stop',
   506â†’  timestamp: getCurrentTimestamp(),
   507â†’  transcript_path: hookInput.transcript_path,
   508â†’  summary: completionMessage,
   509â†’  // ... additional fields
   510â†’}).catch(() => {
   511â†’  // Silently fail - dashboard may not be running
   512â†’});
   513â†’```
   514â†’
   515â†’**Dashboard URLs:**
   516â†’- Server: `http://localhost:4000`
   517â†’- Client: `http://localhost:5173`
   518â†’
   519â†’---
   520â†’
   521â†’### 5. Async Non-Blocking Execution
   522â†’
   523â†’**Pattern:** Hook executes quickly â†’ Launch background processes for slow operations
   524â†’
   525â†’```typescript
   526â†’// update-tab-titles.ts pattern
   527â†’// Set immediate tab title (fast)
   528â†’execSync(`printf '\\033]0;${titleWithEmoji}\\007' >&2`);
   529â†’
   530â†’// Launch background process for Haiku summary (slow)
   531â†’Bun.spawn(['bun', `${paiDir}/Hooks/update-tab-title.ts`, prompt], {
   532â†’  stdout: 'ignore',
   533â†’  stderr: 'ignore',
   534â†’  stdin: 'ignore'
   535â†’});
   536â†’
   537â†’process.exit(0);  // Exit immediately
   538â†’```
   539â†’
   540â†’**Key Principle:** Hooks must never block Claude Code. Always exit quickly, use background processes for slow work.
   541â†’
   542â†’---
   543â†’
   544â†’### 6. Graceful Failure
   545â†’
   546â†’**Pattern:** Wrap everything in try/catch â†’ Log errors â†’ Exit successfully
   547â†’
   548â†’```typescript
   549â†’async function main() {
   550â†’  try {
   551â†’    // Hook logic here
   552â†’  } catch (error) {
   553â†’    // Log but don't fail
   554â†’    console.error('Hook error:', error);
   555â†’  }
   556â†’
   557â†’  process.exit(0);  // Always exit 0
   558â†’}
   559â†’```
   560â†’
   561â†’**Why:** If hooks crash, Claude Code may freeze. Always exit cleanly.
   562â†’
   563â†’---
   564â†’
   565â†’## Creating Custom Hooks
   566â†’
   567â†’### Step 1: Choose Hook Event
   568â†’Decide which event should trigger your hook (SessionStart, Stop, PostToolUse, etc.)
   569â†’
   570â†’### Step 2: Create Hook Script
   571â†’**Location:** `${PAI_DIR}/Hooks/my-custom-hook.ts`
   572â†’
   573â†’**Template:**
   574â†’```typescript
   575â†’#!/usr/bin/env bun
   576â†’
   577â†’interface HookInput {
   578â†’  session_id: string;
   579â†’  transcript_path: string;
   580â†’  hook_event_name: string;
   581â†’  // ... event-specific fields
   582â†’}
   583â†’
   584â†’async function main() {
   585â†’  try {
   586â†’    // Read stdin
   587â†’    const input = await Bun.stdin.text();
   588â†’    const data: HookInput = JSON.parse(input);
   589â†’
   590â†’    // Your hook logic here
   591â†’    console.log(`Hook triggered: ${data.hook_event_name}`);
   592â†’
   593â†’    // Example: Read transcript
   594â†’    const fs = require('fs');
   595â†’    const transcript = fs.readFileSync(data.transcript_path, 'utf-8');
   596â†’
   597â†’    // Do something with the data
   598â†’
   599â†’  } catch (error) {
   600â†’    // Log but don't fail
   601â†’    console.error('Hook error:', error);
   602â†’  }
   603â†’
   604â†’  process.exit(0);  // Always exit 0
   605â†’}
   606â†’
   607â†’main();
   608â†’```
   609â†’
   610â†’### Step 3: Make Executable
   611â†’```bash
   612â†’chmod +x ${PAI_DIR}/Hooks/my-custom-hook.ts
   613â†’```
   614â†’
   615â†’### Step 4: Add to settings.json
   616â†’```json
   617â†’{
   618â†’  "hooks": {
   619â†’    "Stop": [
   620â†’      {
   621â†’        "hooks": [
   622â†’          {
   623â†’            "type": "command",
   624â†’            "command": "${PAI_DIR}/Hooks/my-custom-hook.ts"
   625â†’          }
   626â†’        ]
   627â†’      }
   628â†’    ]
   629â†’  }
   630â†’}
   631â†’```
   632â†’
   633â†’### Step 5: Test
   634â†’```bash
   635â†’# Test hook directly
   636â†’echo '{"session_id":"test","transcript_path":"/tmp/test.jsonl","hook_event_name":"Stop"}' | bun ${PAI_DIR}/Hooks/my-custom-hook.ts
   637â†’```
   638â†’
   639â†’### Step 6: Restart Claude Code
   640â†’Hooks are loaded at startup. Restart to apply changes.
   641â†’
   642â†’---
   643â†’
   644â†’## Hook Development Best Practices
   645â†’
   646â†’### 1. **Fast Execution**
   647â†’- Hooks should complete in < 500ms
   648â†’- Use background processes for slow work (Haiku API calls, file processing)
   649â†’- Exit immediately after launching background work
   650â†’
   651â†’### 2. **Graceful Failure**
   652â†’- Always wrap in try/catch
   653â†’- Log errors to stderr (available in hook debug logs)
   654â†’- Always `process.exit(0)` - never throw or exit(1)
   655â†’
   656â†’### 3. **Non-Blocking**
   657â†’- Never wait for external services (unless they respond quickly)
   658â†’- Use `.catch(() => {})` for async operations
   659â†’- Fail silently if optional services are offline
   660â†’
   661â†’### 4. **Stdin Reading**
   662â†’- Use timeout when reading stdin (Claude Code may not send data immediately)
   663â†’- Handle empty/invalid input gracefully
   664â†’
   665â†’```typescript
   666â†’const decoder = new TextDecoder();
   667â†’const reader = Bun.stdin.stream().getReader();
   668â†’
   669â†’const timeoutPromise = new Promise<void>((resolve) => {
   670â†’  setTimeout(() => resolve(), 500);  // 500ms timeout
   671â†’});
   672â†’
   673â†’await Promise.race([readPromise, timeoutPromise]);
   674â†’```
   675â†’
   676â†’### 5. **File I/O**
   677â†’- Check `existsSync()` before reading files
   678â†’- Create directories with `{ recursive: true }`
   679â†’- Use PST timestamps for consistency
   680â†’
   681â†’### 6. **Environment Access**
   682â†’- All `settings.json` env vars available via `process.env`
   683â†’- Use `${PAI_DIR}` in settings.json for portability
   684â†’- Access in code via `process.env.PAI_DIR`
   685â†’
   686â†’### 7. **Observability**
   687â†’- Send events to dashboard for visibility
   688â†’- Include all relevant metadata (session_id, tool_name, etc.)
   689â†’- Use `.catch(() => {})` - dashboard may be offline
   690â†’
   691â†’---
   692â†’
   693â†’## Troubleshooting
   694â†’
   695â†’### Hook Not Running
   696â†’
   697â†’**Check:**
   698â†’1. Is hook script executable? `chmod +x ${PAI_DIR}/Hooks/my-hook.ts`
   699â†’2. Is path correct in settings.json? Use `${PAI_DIR}/Hooks/...`
   700â†’3. Is settings.json valid JSON? `jq . ${PAI_DIR}/settings.json`
   701â†’4. Did you restart Claude Code after editing settings.json?
   702â†’
   703â†’**Debug:**
   704â†’```bash
   705â†’# Test hook directly
   706â†’echo '{"session_id":"test","transcript_path":"/tmp/test.jsonl","hook_event_name":"Stop"}' | bun ${PAI_DIR}/Hooks/my-hook.ts
   707â†’
   708â†’# Check hook logs (stderr output)
   709â†’tail -f ${PAI_DIR}/Hooks/debug.log  # If you add logging
   710â†’```
   711â†’
   712â†’---
   713â†’
   714â†’### Hook Hangs/Freezes Claude Code
   715â†’
   716â†’**Cause:** Hook not exiting (infinite loop, waiting for input, blocking operation)
   717â†’
   718â†’**Fix:**
   719â†’1. Add timeouts to all blocking operations
   720â†’2. Ensure `process.exit(0)` is always reached
   721â†’3. Use background processes for long operations
   722â†’4. Check stdin reading has timeout
   723â†’
   724â†’**Prevention:**
   725â†’```typescript
   726â†’// Always use timeout
   727â†’setTimeout(() => {
   728â†’  console.error('Hook timeout - exiting');
   729â†’  process.exit(0);
   730â†’}, 5000);  // 5 second max
   731â†’```
   732â†’
   733â†’---
   734â†’
   735â†’### Voice Notifications Not Working
   736â†’
   737â†’**Check:**
   738â†’1. Is voice server running? `curl http://localhost:8888/health`
   739â†’2. Is voice_id correct? See `skills/CORE/SKILL.md` for mappings
   740â†’3. Is message format correct? `{"message":"...", "voice_id":"...", "title":"..."}`
   741â†’4. Is ElevenLabs API key in `${PAI_DIR}/.env`?
   742â†’
   743â†’**Debug:**
   744â†’```bash
   745â†’# Test voice server directly
   746â†’curl -X POST http://localhost:8888/notify \
   747â†’  -H "Content-Type: application/json" \
   748â†’  -d '{"message":"Test message","voice_id":"s3TPKV1kjDlVtZbl4Ksh","title":"Test"}'
   749â†’```
   750â†’
   751â†’**Common Issues:**
   752â†’- Wrong voice_id â†’ Silent failure (invalid ID)
   753â†’- Voice server offline â†’ Hook continues (graceful failure)
   754â†’- No `ðŸŽ¯ COMPLETED:` line â†’ No voice notification extracted
   755â†’
   756â†’---
   757â†’
   758â†’### History Not Capturing
   759â†’
   760â†’**Check:**
   761â†’1. Does `${PAI_DIR}/History/` directory exist?
   762â†’2. Are structured sections present in response? (`ðŸ“‹ SUMMARY:`, `ðŸŽ¯ COMPLETED:`, etc.)
   763â†’3. Is hook actually running? Check `${PAI_DIR}/History/raw-outputs/` for events
   764â†’4. File permissions? `ls -la ${PAI_DIR}/History/sessions/`
   765â†’
   766â†’**Debug:**
   767â†’```bash
   768â†’# Check recent captures
   769â†’ls -lt ${PAI_DIR}/History/sessions/$(date +%Y-%m)/ | head -10
   770â†’ls -lt ${PAI_DIR}/History/learnings/$(date +%Y-%m)/ | head -10
   771â†’
   772â†’# Check raw events
   773â†’tail ${PAI_DIR}/History/raw-outputs/$(date +%Y-%m)/$(date +%Y-%m-%d)_all-events.jsonl
   774â†’```
   775â†’
   776â†’**Common Issues:**
   777â†’- Missing structured format â†’ No parsing
   778â†’- No `ðŸŽ¯ COMPLETED:` line â†’ Capture may fail
   779â†’- Learning detection too strict â†’ Adjust `isLearningCapture()` logic
   780â†’
   781â†’---
   782â†’
   783â†’### Stop Event Not Firing (CRITICAL KNOWN ISSUE)
   784â†’
   785â†’**Symptom:** Stop hook configured and working, but Stop events not firing consistently
   786â†’
   787â†’**Evidence:**
   788â†’```bash
   789â†’# Check if Stop events fired today
   790â†’grep '"event_type":"Stop"' ${PAI_DIR}/History/raw-outputs/$(date +%Y-%m)/$(date +%Y-%m-%d)_all-events.jsonl
   791â†’# Result: 0 matches (no Stop events)
   792â†’
   793â†’# But other hooks ARE working
   794â†’grep '"event_type":"PostToolUse"' ${PAI_DIR}/History/raw-outputs/$(date +%Y-%m)/$(date +%Y-%m-%d)_all-events.jsonl
   795â†’# Result: 80+ matches (PostToolUse working fine)
   796â†’```
   797â†’
   798â†’**Impact:**
   799â†’- Automatic work summaries NOT captured to history (despite Stop hook logic being correct)
   800â†’- Learning moments NOT auto-detected
   801â†’- Voice notifications from main agent responses NOT sent
   802â†’- Manual verification and capture REQUIRED
   803â†’
   804â†’**Root Cause:**
   805â†’- Claude Code event trigger issue (external to hook system)
   806â†’- Stop event not being emitted when main agent completes responses
   807â†’- Hook configuration is correct, hook script works, event just never fires
   808â†’- Other event types (PostToolUse, SessionEnd, UserPromptSubmit) work fine
   809â†’
   810â†’**Workaround (MANDATORY):**
   811â†’
   812â†’1. **Added CAPTURE field to response format** (see `${PAI_DIR}/Skills/CORE/SKILL.md`)
   813â†’   - MANDATORY field in every response
   814â†’   - Forces verification before completing responses
   815â†’   - Must document: "Auto-captured" / "Manually saved" / "N/A"
   816â†’
   817â†’2. **Added MANDATORY VERIFICATION GATE** to file organization section
   818â†’   - Before completing valuable work, MUST run verification commands
   819â†’   - Check if auto-capture happened (ls -lt history directories)
   820â†’   - If not, manually save to appropriate history location
   821â†’
   822â†’3. **Verification Commands:**
   823â†’   ```bash
   824â†’   # Check if auto-captured (should happen, but often doesn't due to Stop event bug)
   825â†’   ls -lt ${PAI_DIR}/History/sessions/$(date +%Y-%m)/ | head -5
   826â†’   ls -lt ${PAI_DIR}/History/learnings/$(date +%Y-%m)/ | head -5
   827â†’
   828â†’   # If 0 results or doesn't match current work â†’ Manual capture required
   829â†’   ```
   830â†’
   831â†’**Status:** UNRESOLVED (Claude Code issue, not hook configuration)
   832â†’**Mitigation:** Structural enforcement via response format (cannot complete valuable work without verification)
   833â†’**Tracking:** Documented in `${PAI_DIR}/Skills/CORE/SKILL.md` (History Capture System section)
   834â†’
   835â†’**Long-term Fix:**
   836â†’- Report to Anthropic (Claude Code team) as Stop event reliability issue
   837â†’- Monitor future Claude Code updates for fix
   838â†’- Keep workaround in place until Stop events fire reliably
   839â†’
   840â†’---
   841â†’
   842â†’### Agent Detection Failing
   843â†’
   844â†’**Check:**
   845â†’1. Is `${PAI_DIR}/agent-sessions.json` writable?
   846â†’2. Is `[AGENT:type]` tag in `ðŸŽ¯ COMPLETED:` line?
   847â†’3. Is agent running from correct directory? (`/Agents/name/`)
   848â†’
   849â†’**Debug:**
   850â†’```bash
   851â†’# Check session mappings
   852â†’cat ${PAI_DIR}/agent-sessions.json | jq .
   853â†’
   854â†’# Check subagent-stop debug log
   855â†’tail -f ${PAI_DIR}/Hooks/subagent-stop-debug.log
   856â†’```
   857â†’
   858â†’**Fix:**
   859â†’- Ensure agents include `[AGENT:type]` in completion line
   860â†’- Verify Task tool passes `subagent_type` parameter
   861â†’- Check cwd includes `/Agents/` in path
   862â†’
   863â†’---
   864â†’
   865â†’### Observability Dashboard Not Receiving Events
   866â†’
   867â†’**Check:**
   868â†’1. Is dashboard server running? `curl http://localhost:4000/health`
   869â†’2. Are hooks sending events? Check `sendEventToObservability()` calls
   870â†’3. Network issues? `netstat -an | grep 4000`
   871â†’
   872â†’**Debug:**
   873â†’```bash
   874â†’# Start dashboard server
   875â†’cd ${PAI_DIR}/Skills/system/observability/dashboard/apps/server
   876â†’bun run dev
   877â†’
   878â†’# Check server logs
   879â†’# Events should appear in real-time
   880â†’```
   881â†’
   882â†’**Note:** Hooks fail silently if dashboard offline (by design). Not critical for operation.
   883â†’
   884â†’---
   885â†’
   886â†’### Context Loading Issues (SessionStart)
   887â†’
   888â†’**Check:**
   889â†’1. Does `${PAI_DIR}/Skills/CORE/SKILL.md` exist?
   890â†’2. Is `load-core-context.ts` executable?
   891â†’3. Is `PAI_DIR` env variable set correctly?
   892â†’
   893â†’**Debug:**
   894â†’```bash
   895â†’# Test context loading directly
   896â†’bun ${PAI_DIR}/Hooks/load-core-context.ts
   897â†’
   898â†’# Should output <system-reminder> with SKILL.md content
   899â†’```
   900â†’
   901â†’**Common Issues:**
   902â†’- Subagent sessions loading main context â†’ Fixed (subagent detection in hook)
   903â†’- File not found â†’ Check `PAI_DIR` environment variable
   904â†’- Permission denied â†’ `chmod +x ${PAI_DIR}/Hooks/load-core-context.ts`
   905â†’
   906â†’---
   907â†’
   908â†’## Advanced Topics
   909â†’
   910â†’### Multi-Hook Execution Order
   911â†’
   912â†’Hooks in same event execute **sequentially** in order defined in settings.json:
   913â†’
   914â†’```json
   915â†’{
   916â†’  "Stop": [
   917â†’    {
   918â†’      "hooks": [
   919â†’        { "command": "${PAI_DIR}/Hooks/stop-hook.ts" },      // Runs first
   920â†’        { "command": "${PAI_DIR}/Hooks/capture-all-events.ts" }  // Runs second
   921â†’      ]
   922â†’    }
   923â†’  ]
   924â†’}
   925â†’```
   926â†’
   927â†’**Note:** If first hook hangs, second won't run. Keep hooks fast!
   928â†’
   929â†’---
   930â†’
   931â†’### Matcher Patterns
   932â†’
   933â†’`"matcher"` field filters which events trigger hook:
   934â†’
   935â†’```json
   936â†’{
   937â†’  "PostToolUse": [
   938â†’    {
   939â†’      "matcher": "Bash",  // Only Bash tool executions
   940â†’      "hooks": [...]
   941â†’    },
   942â†’    {
   943â†’      "matcher": "*",     // All tool executions
   944â†’      "hooks": [...]
   945â†’    }
   946â†’  ]
   947â†’}
   948â†’```
   949â†’
   950â†’**Patterns:**
   951â†’- `"*"` - All events
   952â†’- `"Bash"` - Specific tool name
   953â†’- `""` - Empty (all events, same as `*`)
   954â†’
   955â†’---
   956â†’
   957â†’### Hook Data Payloads by Event Type
   958â†’
   959â†’**SessionStart:**
   960â†’```typescript
   961â†’{
   962â†’  session_id: string;
   963â†’  transcript_path: string;
   964â†’  hook_event_name: "SessionStart";
   965â†’  cwd: string;
   966â†’}
   967â†’```
   968â†’
   969â†’**UserPromptSubmit:**
   970â†’```typescript
   971â†’{
   972â†’  session_id: string;
   973â†’  transcript_path: string;
   974â†’  hook_event_name: "UserPromptSubmit";
   975â†’  prompt: string;  // The user's prompt text
   976â†’}
   977â†’```
   978â†’
   979â†’**PreToolUse:**
   980â†’```typescript
   981â†’{
   982â†’  session_id: string;
   983â†’  transcript_path: string;
   984â†’  hook_event_name: "PreToolUse";
   985â†’  tool_name: string;
   986â†’  tool_input: any;  // Tool parameters
   987â†’}
   988â†’```
   989â†’
   990â†’**PostToolUse:**
   991â†’```typescript
   992â†’{
   993â†’  session_id: string;
   994â†’  transcript_path: string;
   995â†’  hook_event_name: "PostToolUse";
   996â†’  tool_name: string;
   997â†’  tool_input: any;
   998â†’  tool_output: any;  // Tool result
   999â†’  error?: string;    // If tool failed
  1000â†’}
  1001â†’```
  1002â†’
  1003â†’**Stop:**
  1004â†’```typescript
  1005â†’{
  1006â†’  session_id: string;
  1007â†’  transcript_path: string;
  1008â†’  hook_event_name: "Stop";
  1009â†’}
  1010â†’```
  1011â†’
  1012â†’**SubagentStop:**
  1013â†’```typescript
  1014â†’{
  1015â†’  session_id: string;
  1016â†’  transcript_path: string;
  1017â†’  hook_event_name: "SubagentStop";
  1018â†’}
  1019â†’```
  1020â†’
  1021â†’**SessionEnd:**
  1022â†’```typescript
  1023â†’{
  1024â†’  conversation_id: string;  // Note: different field name
  1025â†’  timestamp: string;
  1026â†’}
  1027â†’```
  1028â†’
  1029â†’---
  1030â†’
  1031â†’## Related Documentation
  1032â†’
  1033â†’- **Voice System:** `${PAI_DIR}/voice-server/USAGE.md`
  1034â†’- **Agent Architecture:** `${PAI_DIR}/Skills/CORE/agent-protocols.md`
  1035â†’- **History/UOCS:** `${PAI_DIR}/Skills/CORE/history-system.md`
  1036â†’- **Observability Dashboard:** `${PAI_DIR}/Skills/Observability/`
  1037â†’
  1038â†’---
  1039â†’
  1040â†’## Quick Reference Card
  1041â†’
  1042â†’```
  1043â†’HOOK LIFECYCLE:
  1044â†’1. Event occurs (SessionStart, Stop, etc.)
  1045â†’2. Claude Code writes hook data to stdin
  1046â†’3. Hook script executes
  1047â†’4. Hook reads stdin (with timeout)
  1048â†’5. Hook performs actions (voice, capture, etc.)
  1049â†’6. Hook exits 0 (always succeeds)
  1050â†’7. Claude Code continues
  1051â†’
  1052â†’KEY FILES:
  1053â†’${PAI_DIR}/settings.json           Hook configuration
  1054â†’${PAI_DIR}/Hooks/                  Hook scripts
  1055â†’${PAI_DIR}/Hooks/lib/observability.ts   Helper library
  1056â†’${PAI_DIR}/History/raw-outputs/    Event logs (JSONL)
  1057â†’${PAI_DIR}/History/sessions/       Work summaries
  1058â†’${PAI_DIR}/History/learnings/      Learning captures
  1059â†’${PAI_DIR}/agent-sessions.json     Sessionâ†’Agent mapping
  1060â†’
  1061â†’CRITICAL HOOKS:
  1062â†’stop-hook.ts          Voice + history capture (main agent)
  1063â†’subagent-stop-hook.ts Voice + history capture (subagents)
  1064â†’load-core-context.ts  PAI context loading
  1065â†’capture-all-events.ts Universal event logger
  1066â†’
  1067â†’VOICE SERVER:
  1068â†’URL: http://localhost:8888/notify
  1069â†’Payload: {"message":"...", "voice_id":"...", "title":"..."}
  1070â†’Main Voice: s3TPKV1kjDlVtZbl4Ksh (PAI)
  1071â†’
  1072â†’OBSERVABILITY:
  1073â†’Server: http://localhost:4000
  1074â†’Client: http://localhost:5173
  1075â†’Events: All hooks send to /events endpoint
  1076â†’```
  1077â†’
  1078â†’---
  1079â†’
  1080â†’**Last Updated:** 2025-11-01
  1081â†’**Status:** Production - All hooks active and tested
  1082â†’**Maintainer:** Daniel Miessler (maintainer@example.com)
  1083â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
