     1â†’<purpose>
     2â†’Execute a phase prompt (PLAN.md) and create the outcome summary (SUMMARY.md).
     3â†’</purpose>
     4â†’
     5â†’<required_reading>
     6â†’Read STATE.md before any operation to load project context.
     7â†’</required_reading>
     8â†’
     9â†’<process>
    10â†’
    11â†’<step name="load_project_state" priority="first">
    12â†’Before any operation, read project state:
    13â†’
    14â†’```bash
    15â†’cat .planning/STATE.md 2>/dev/null
    16â†’```
    17â†’
    18â†’**If file exists:** Parse and internalize:
    19â†’
    20â†’- Current position (phase, plan, status)
    21â†’- Accumulated decisions (constraints on this execution)
    22â†’- Deferred issues (context for deviations)
    23â†’- Blockers/concerns (things to watch for)
    24â†’- Brief alignment status
    25â†’
    26â†’**If file missing but .planning/ exists:**
    27â†’
    28â†’```
    29â†’STATE.md missing but planning artifacts exist.
    30â†’Options:
    31â†’1. Reconstruct from existing artifacts
    32â†’2. Continue without project state (may lose accumulated context)
    33â†’```
    34â†’
    35â†’**If .planning/ doesn't exist:** Error - project not initialized.
    36â†’
    37â†’This ensures every execution has full project context.
    38â†’</step>
    39â†’
    40â†’<step name="identify_plan">
    41â†’Find the next plan to execute:
    42â†’- Check roadmap for "In progress" phase
    43â†’- Find plans in that phase directory
    44â†’- Identify first plan without corresponding SUMMARY
    45â†’
    46â†’```bash
    47â†’cat .planning/ROADMAP.md
    48â†’# Look for phase with "In progress" status
    49â†’# Then find plans in that phase
    50â†’ls .planning/phases/XX-name/*-PLAN.md 2>/dev/null | sort
    51â†’ls .planning/phases/XX-name/*-SUMMARY.md 2>/dev/null | sort
    52â†’```
    53â†’
    54â†’**Logic:**
    55â†’
    56â†’- If `01-01-PLAN.md` exists but `01-01-SUMMARY.md` doesn't â†’ execute 01-01
    57â†’- If `01-01-SUMMARY.md` exists but `01-02-SUMMARY.md` doesn't â†’ execute 01-02
    58â†’- Pattern: Find first PLAN file without matching SUMMARY file
    59â†’
    60â†’**Decimal phase handling:**
    61â†’
    62â†’Phase directories can be integer or decimal format:
    63â†’
    64â†’- Integer: `.planning/phases/01-foundation/01-01-PLAN.md`
    65â†’- Decimal: `.planning/phases/01.1-hotfix/01.1-01-PLAN.md`
    66â†’
    67â†’Parse phase number from path (handles both formats):
    68â†’
    69â†’```bash
    70â†’# Extract phase number (handles XX or XX.Y format)
    71â†’PHASE=$(echo "$PLAN_PATH" | grep -oE '[0-9]+(\.[0-9]+)?-[0-9]+')
    72â†’```
    73â†’
    74â†’SUMMARY naming follows same pattern:
    75â†’
    76â†’- Integer: `01-01-SUMMARY.md`
    77â†’- Decimal: `01.1-01-SUMMARY.md`
    78â†’
    79â†’Confirm with user if ambiguous.
    80â†’
    81â†’<config-check>
    82â†’```bash
    83â†’cat .planning/config.json 2>/dev/null
    84â†’```
    85â†’</config-check>
    86â†’
    87â†’<if mode="yolo">
    88â†’```
    89â†’âš¡ Auto-approved: Execute {phase}-{plan}-PLAN.md
    90â†’[Plan X of Y for Phase Z]
    91â†’
    92â†’Starting execution...
    93â†’```
    94â†’
    95â†’Proceed directly to parse_segments step.
    96â†’</if>
    97â†’
    98â†’<if mode="interactive" OR="custom with gates.execute_next_plan true">
    99â†’Present:
   100â†’
   101â†’```
   102â†’Found plan to execute: {phase}-{plan}-PLAN.md
   103â†’[Plan X of Y for Phase Z]
   104â†’
   105â†’Proceed with execution?
   106â†’```
   107â†’
   108â†’Wait for confirmation before proceeding.
   109â†’</if>
   110â†’</step>
   111â†’
   112â†’<step name="record_start_time">
   113â†’Record execution start time for performance tracking:
   114â†’
   115â†’```bash
   116â†’PLAN_START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
   117â†’PLAN_START_EPOCH=$(date +%s)
   118â†’```
   119â†’
   120â†’Store in shell variables for duration calculation at completion.
   121â†’</step>
   122â†’
   123â†’<step name="parse_segments">
   124â†’**Intelligent segmentation: Parse plan into execution segments.**
   125â†’
   126â†’Plans are divided into segments by checkpoints. Each segment is routed to optimal execution context (subagent or main).
   127â†’
   128â†’**1. Check for checkpoints:**
   129â†’
   130â†’```bash
   131â†’# Find all checkpoints and their types
   132â†’grep -n "type=\"checkpoint" .planning/phases/XX-name/{phase}-{plan}-PLAN.md
   133â†’```
   134â†’
   135â†’**2. Analyze execution strategy:**
   136â†’
   137â†’**If NO checkpoints found:**
   138â†’
   139â†’- **Fully autonomous plan** - spawn single subagent for entire plan
   140â†’- Subagent gets fresh 200k context, executes all tasks, creates SUMMARY, commits
   141â†’- Main context: Just orchestration (~5% usage)
   142â†’
   143â†’**If checkpoints found, parse into segments:**
   144â†’
   145â†’Segment = tasks between checkpoints (or startâ†’first checkpoint, or last checkpointâ†’end)
   146â†’
   147â†’**For each segment, determine routing:**
   148â†’
   149â†’```
   150â†’Segment routing rules:
   151â†’
   152â†’IF segment has no prior checkpoint:
   153â†’  â†’ SUBAGENT (first segment, nothing to depend on)
   154â†’
   155â†’IF segment follows checkpoint:human-verify:
   156â†’  â†’ SUBAGENT (verification is just confirmation, doesn't affect next work)
   157â†’
   158â†’IF segment follows checkpoint:decision OR checkpoint:human-action:
   159â†’  â†’ MAIN CONTEXT (next tasks need the decision/result)
   160â†’```
   161â†’
   162â†’**3. Execution pattern:**
   163â†’
   164â†’**Pattern A: Fully autonomous (no checkpoints)**
   165â†’
   166â†’```
   167â†’Spawn subagent â†’ execute all tasks â†’ SUMMARY â†’ commit â†’ report back
   168â†’```
   169â†’
   170â†’**Pattern B: Segmented with verify-only checkpoints**
   171â†’
   172â†’```
   173â†’Segment 1 (tasks 1-3): Spawn subagent â†’ execute â†’ report back
   174â†’Checkpoint 4 (human-verify): Main context â†’ you verify â†’ continue
   175â†’Segment 2 (tasks 5-6): Spawn NEW subagent â†’ execute â†’ report back
   176â†’Checkpoint 7 (human-verify): Main context â†’ you verify â†’ continue
   177â†’Aggregate results â†’ SUMMARY â†’ commit
   178â†’```
   179â†’
   180â†’**Pattern C: Decision-dependent (must stay in main)**
   181â†’
   182â†’```
   183â†’Checkpoint 1 (decision): Main context â†’ you decide â†’ continue in main
   184â†’Tasks 2-5: Main context (need decision from checkpoint 1)
   185â†’No segmentation benefit - execute entirely in main
   186â†’```
   187â†’
   188â†’**4. Why this works:**
   189â†’
   190â†’**Segmentation benefits:**
   191â†’
   192â†’- Fresh context for each autonomous segment (0% start every time)
   193â†’- Main context only for checkpoints (~10-20% total)
   194â†’- Can handle 10+ task plans if properly segmented
   195â†’- Quality impossible to degrade in autonomous segments
   196â†’
   197â†’**When segmentation provides no benefit:**
   198â†’
   199â†’- Checkpoint is decision/human-action and following tasks depend on outcome
   200â†’- Better to execute sequentially in main than break flow
   201â†’
   202â†’**5. Implementation:**
   203â†’
   204â†’**For fully autonomous plans:**
   205â†’
   206â†’```
   207â†’Use Task tool with subagent_type="general-purpose":
   208â†’
   209â†’Prompt: "Execute plan at .planning/phases/{phase}-{plan}-PLAN.md
   210â†’
   211â†’This is an autonomous plan (no checkpoints). Execute all tasks, create SUMMARY.md in phase directory, commit with message following plan's commit guidance.
   212â†’
   213â†’Follow all deviation rules and authentication gate protocols from the plan.
   214â†’
   215â†’When complete, report: plan name, tasks completed, SUMMARY path, commit hash."
   216â†’```
   217â†’
   218â†’**For segmented plans (has verify-only checkpoints):**
   219â†’
   220â†’```
   221â†’Execute segment-by-segment:
   222â†’
   223â†’For each autonomous segment:
   224â†’  Spawn subagent with prompt: "Execute tasks [X-Y] from plan at .planning/phases/{phase}-{plan}-PLAN.md. Read the plan for full context and deviation rules. Do NOT create SUMMARY or commit - just execute these tasks and report results."
   225â†’
   226â†’  Wait for subagent completion
   227â†’
   228â†’For each checkpoint:
   229â†’  Execute in main context
   230â†’  Wait for user interaction
   231â†’  Continue to next segment
   232â†’
   233â†’After all segments complete:
   234â†’  Aggregate all results
   235â†’  Create SUMMARY.md
   236â†’  Commit with all changes
   237â†’```
   238â†’
   239â†’**For decision-dependent plans:**
   240â†’
   241â†’```
   242â†’Execute in main context (standard flow below)
   243â†’No subagent routing
   244â†’Quality maintained through small scope (2-3 tasks per plan)
   245â†’```
   246â†’
   247â†’See step name="segment_execution" for detailed segment execution loop.
   248â†’</step>
   249â†’
   250â†’<step name="segment_execution">
   251â†’**Detailed segment execution loop for segmented plans.**
   252â†’
   253â†’**This step applies ONLY to segmented plans (Pattern B: has checkpoints, but they're verify-only).**
   254â†’
   255â†’For Pattern A (fully autonomous) and Pattern C (decision-dependent), skip this step.
   256â†’
   257â†’**Execution flow:**
   258â†’
   259â†’````
   260â†’1. Parse plan to identify segments:
   261â†’   - Read plan file
   262â†’   - Find checkpoint locations: grep -n "type=\"checkpoint" PLAN.md
   263â†’   - Identify checkpoint types: grep "type=\"checkpoint" PLAN.md | grep -o 'checkpoint:[^"]*'
   264â†’   - Build segment map:
   265â†’     * Segment 1: Start â†’ first checkpoint (tasks 1-X)
   266â†’     * Checkpoint 1: Type and location
   267â†’     * Segment 2: After checkpoint 1 â†’ next checkpoint (tasks X+1 to Y)
   268â†’     * Checkpoint 2: Type and location
   269â†’     * ... continue for all segments
   270â†’
   271â†’2. For each segment in order:
   272â†’
   273â†’   A. Determine routing (apply rules from parse_segments):
   274â†’      - No prior checkpoint? â†’ Subagent
   275â†’      - Prior checkpoint was human-verify? â†’ Subagent
   276â†’      - Prior checkpoint was decision/human-action? â†’ Main context
   277â†’
   278â†’   B. If routing = Subagent:
   279â†’      ```
   280â†’      Spawn Task tool with subagent_type="general-purpose":
   281â†’
   282â†’      Prompt: "Execute tasks [task numbers/names] from plan at [plan path].
   283â†’
   284â†’      **Context:**
   285â†’      - Read the full plan for objective, context files, and deviation rules
   286â†’      - You are executing a SEGMENT of this plan (not the full plan)
   287â†’      - Other segments will be executed separately
   288â†’
   289â†’      **Your responsibilities:**
   290â†’      - Execute only the tasks assigned to you
   291â†’      - Follow all deviation rules and authentication gate protocols
   292â†’      - Track deviations for later Summary
   293â†’      - DO NOT create SUMMARY.md (will be created after all segments complete)
   294â†’      - DO NOT commit (will be done after all segments complete)
   295â†’
   296â†’      **Report back:**
   297â†’      - Tasks completed
   298â†’      - Files created/modified
   299â†’      - Deviations encountered
   300â†’      - Any issues or blockers"
   301â†’
   302â†’      Wait for subagent to complete
   303â†’      Capture results (files changed, deviations, etc.)
   304â†’      ```
   305â†’
   306â†’   C. If routing = Main context:
   307â†’      Execute tasks in main using standard execution flow (step name="execute")
   308â†’      Track results locally
   309â†’
   310â†’   D. After segment completes (whether subagent or main):
   311â†’      Continue to next checkpoint/segment
   312â†’
   313â†’3. After ALL segments complete:
   314â†’
   315â†’   A. Aggregate results from all segments:
   316â†’      - Collect files created/modified from all segments
   317â†’      - Collect deviations from all segments
   318â†’      - Collect decisions from all checkpoints
   319â†’      - Merge into complete picture
   320â†’
   321â†’   B. Create SUMMARY.md:
   322â†’      - Use aggregated results
   323â†’      - Document all work from all segments
   324â†’      - Include deviations from all segments
   325â†’      - Note which segments were subagented
   326â†’
   327â†’   C. Commit:
   328â†’      - Stage all files from all segments
   329â†’      - Stage SUMMARY.md
   330â†’      - Commit with message following plan guidance
   331â†’      - Include note about segmented execution if relevant
   332â†’
   333â†’   D. Report completion
   334â†’
   335â†’**Example execution trace:**
   336â†’
   337â†’````
   338â†’
   339â†’Plan: 01-02-PLAN.md (8 tasks, 2 verify checkpoints)
   340â†’
   341â†’Parsing segments...
   342â†’
   343â†’- Segment 1: Tasks 1-3 (autonomous)
   344â†’- Checkpoint 4: human-verify
   345â†’- Segment 2: Tasks 5-6 (autonomous)
   346â†’- Checkpoint 7: human-verify
   347â†’- Segment 3: Task 8 (autonomous)
   348â†’
   349â†’Routing analysis:
   350â†’
   351â†’- Segment 1: No prior checkpoint â†’ SUBAGENT âœ“
   352â†’- Checkpoint 4: Verify only â†’ MAIN (required)
   353â†’- Segment 2: After verify â†’ SUBAGENT âœ“
   354â†’- Checkpoint 7: Verify only â†’ MAIN (required)
   355â†’- Segment 3: After verify â†’ SUBAGENT âœ“
   356â†’
   357â†’Execution:
   358â†’[1] Spawning subagent for tasks 1-3...
   359â†’â†’ Subagent completes: 3 files modified, 0 deviations
   360â†’[2] Executing checkpoint 4 (human-verify)...
   361â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   362â†’CHECKPOINT: Verification Required
   363â†’Task 4 of 8: Verify database schema
   364â†’I built: User and Session tables with relations
   365â†’How to verify: Check src/db/schema.ts for correct types
   366â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   367â†’User: "approved"
   368â†’[3] Spawning subagent for tasks 5-6...
   369â†’â†’ Subagent completes: 2 files modified, 1 deviation (added error handling)
   370â†’[4] Executing checkpoint 7 (human-verify)...
   371â†’User: "approved"
   372â†’[5] Spawning subagent for task 8...
   373â†’â†’ Subagent completes: 1 file modified, 0 deviations
   374â†’
   375â†’Aggregating results...
   376â†’
   377â†’- Total files: 6 modified
   378â†’- Total deviations: 1
   379â†’- Segmented execution: 3 subagents, 2 checkpoints
   380â†’
   381â†’Creating SUMMARY.md...
   382â†’Committing...
   383â†’âœ“ Complete
   384â†’
   385â†’````
   386â†’
   387â†’**Benefits of this pattern:**
   388â†’- Main context usage: ~20% (just orchestration + checkpoints)
   389â†’- Subagent 1: Fresh 0-30% (tasks 1-3)
   390â†’- Subagent 2: Fresh 0-30% (tasks 5-6)
   391â†’- Subagent 3: Fresh 0-20% (task 8)
   392â†’- All autonomous work: Peak quality
   393â†’- Can handle large plans with many tasks if properly segmented
   394â†’
   395â†’**When NOT to use segmentation:**
   396â†’- Plan has decision/human-action checkpoints that affect following tasks
   397â†’- Following tasks depend on checkpoint outcome
   398â†’- Better to execute in main sequentially in those cases
   399â†’</step>
   400â†’
   401â†’<step name="load_prompt">
   402â†’Read the plan prompt:
   403â†’```bash
   404â†’cat .planning/phases/XX-name/{phase}-{plan}-PLAN.md
   405â†’````
   406â†’
   407â†’This IS the execution instructions. Follow it exactly.
   408â†’
   409â†’**If plan references CONTEXT.md:**
   410â†’The CONTEXT.md file provides the user's vision for this phase â€” how they imagine it working, what's essential, and what's out of scope. Honor this context throughout execution.
   411â†’</step>
   412â†’
   413â†’<step name="previous_phase_check">
   414â†’Before executing, check if previous phase had issues:
   415â†’
   416â†’```bash
   417â†’# Find previous phase summary
   418â†’ls .planning/phases/*/SUMMARY.md 2>/dev/null | sort -r | head -2 | tail -1
   419â†’```
   420â†’
   421â†’If previous phase SUMMARY.md has "Issues Encountered" != "None" or "Next Phase Readiness" mentions blockers:
   422â†’
   423â†’Use AskUserQuestion:
   424â†’
   425â†’- header: "Previous Issues"
   426â†’- question: "Previous phase had unresolved items: [summary]. How to proceed?"
   427â†’- options:
   428â†’  - "Proceed anyway" - Issues won't block this phase
   429â†’  - "Address first" - Let's resolve before continuing
   430â†’  - "Review previous" - Show me the full summary
   431â†’    </step>
   432â†’
   433â†’<step name="execute">
   434â†’Execute each task in the prompt. **Deviations are normal** - handle them automatically using embedded rules below.
   435â†’
   436â†’1. Read the @context files listed in the prompt
   437â†’
   438â†’2. For each task:
   439â†’
   440â†’   **If `type="auto"`:**
   441â†’
   442â†’   **Before executing:** Check if task has `tdd="true"` attribute:
   443â†’   - If yes: Follow TDD execution flow (see `<tdd_execution>`) - RED â†’ GREEN â†’ REFACTOR cycle with atomic commits per stage
   444â†’   - If no: Standard implementation
   445â†’
   446â†’   - Work toward task completion
   447â†’   - **If CLI/API returns authentication error:** Handle as authentication gate (see below)
   448â†’   - **When you discover additional work not in plan:** Apply deviation rules (see below) automatically
   449â†’   - Continue implementing, applying rules as needed
   450â†’   - Run the verification
   451â†’   - Confirm done criteria met
   452â†’   - **Commit the task** (see `<task_commit>` below)
   453â†’   - Track task completion and commit hash for Summary documentation
   454â†’   - Continue to next task
   455â†’
   456â†’   **If `type="checkpoint:*"`:**
   457â†’
   458â†’   - STOP immediately (do not continue to next task)
   459â†’   - Execute checkpoint_protocol (see below)
   460â†’   - Wait for user response
   461â†’   - Verify if possible (check files, env vars, etc.)
   462â†’   - Only after user confirmation: continue to next task
   463â†’
   464â†’3. Run overall verification checks from `<verification>` section
   465â†’4. Confirm all success criteria from `<success_criteria>` section met
   466â†’5. Document all deviations in Summary (automatic - see deviation_documentation below)
   467â†’   </step>
   468â†’
   469â†’<authentication_gates>
   470â†’
   471â†’## Handling Authentication Errors During Execution
   472â†’
   473â†’**When you encounter authentication errors during `type="auto"` task execution:**
   474â†’
   475â†’This is NOT a failure. Authentication gates are expected and normal. Handle them dynamically:
   476â†’
   477â†’**Authentication error indicators:**
   478â†’
   479â†’- CLI returns: "Error: Not authenticated", "Not logged in", "Unauthorized", "401", "403"
   480â†’- API returns: "Authentication required", "Invalid API key", "Missing credentials"
   481â†’- Command fails with: "Please run {tool} login" or "Set {ENV_VAR} environment variable"
   482â†’
   483â†’**Authentication gate protocol:**
   484â†’
   485â†’1. **Recognize it's an auth gate** - Not a bug, just needs credentials
   486â†’2. **STOP current task execution** - Don't retry repeatedly
   487â†’3. **Create dynamic checkpoint:human-action** - Present it to user immediately
   488â†’4. **Provide exact authentication steps** - CLI commands, where to get keys
   489â†’5. **Wait for user to authenticate** - Let them complete auth flow
   490â†’6. **Verify authentication works** - Test that credentials are valid
   491â†’7. **Retry the original task** - Resume automation where you left off
   492â†’8. **Continue normally** - Don't treat this as an error in Summary
   493â†’
   494â†’**Example: Vercel deployment hits auth error**
   495â†’
   496â†’```
   497â†’Task 3: Deploy to Vercel
   498â†’Running: vercel --yes
   499â†’
   500â†’Error: Not authenticated. Please run 'vercel login'
   501â†’
   502â†’[Create checkpoint dynamically]
   503â†’
   504â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   505â†’CHECKPOINT: Authentication Required
   506â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   507â†’
   508â†’Task 3 of 8: Authenticate Vercel CLI
   509â†’
   510â†’I tried to deploy but got authentication error.
   511â†’
   512â†’What you need to do:
   513â†’Run: vercel login
   514â†’
   515â†’This will open your browser - complete the authentication flow.
   516â†’
   517â†’I'll verify after: vercel whoami returns your account
   518â†’
   519â†’Type "done" when authenticated
   520â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   521â†’
   522â†’[Wait for user response]
   523â†’
   524â†’[User types "done"]
   525â†’
   526â†’Verifying authentication...
   527â†’Running: vercel whoami
   528â†’âœ“ Authenticated as: user@example.com
   529â†’
   530â†’Retrying deployment...
   531â†’Running: vercel --yes
   532â†’âœ“ Deployed to: https://myapp-abc123.vercel.app
   533â†’
   534â†’Task 3 complete. Continuing to task 4...
   535â†’```
   536â†’
   537â†’**In Summary documentation:**
   538â†’
   539â†’Document authentication gates as normal flow, not deviations:
   540â†’
   541â†’```markdown
   542â†’## Authentication Gates
   543â†’
   544â†’During execution, I encountered authentication requirements:
   545â†’
   546â†’1. Task 3: Vercel CLI required authentication
   547â†’   - Paused for `vercel login`
   548â†’   - Resumed after authentication
   549â†’   - Deployed successfully
   550â†’
   551â†’These are normal gates, not errors.
   552â†’```
   553â†’
   554â†’**Key principles:**
   555â†’
   556â†’- Authentication gates are NOT failures or bugs
   557â†’- They're expected interaction points during first-time setup
   558â†’- Handle them gracefully and continue automation after unblocked
   559â†’- Don't mark tasks as "failed" or "incomplete" due to auth gates
   560â†’- Document them as normal flow, separate from deviations
   561â†’  </authentication_gates>
   562â†’
   563â†’<deviation_rules>
   564â†’
   565â†’## Automatic Deviation Handling
   566â†’
   567â†’**While executing tasks, you WILL discover work not in the plan.** This is normal.
   568â†’
   569â†’Apply these rules automatically. Track all deviations for Summary documentation.
   570â†’
   571â†’---
   572â†’
   573â†’**RULE 1: Auto-fix bugs**
   574â†’
   575â†’**Trigger:** Code doesn't work as intended (broken behavior, incorrect output, errors)
   576â†’
   577â†’**Action:** Fix immediately, track for Summary
   578â†’
   579â†’**Examples:**
   580â†’
   581â†’- Wrong SQL query returning incorrect data
   582â†’- Logic errors (inverted condition, off-by-one, infinite loop)
   583â†’- Type errors, null pointer exceptions, undefined references
   584â†’- Broken validation (accepts invalid input, rejects valid input)
   585â†’- Security vulnerabilities (SQL injection, XSS, CSRF, insecure auth)
   586â†’- Race conditions, deadlocks
   587â†’- Memory leaks, resource leaks
   588â†’
   589â†’**Process:**
   590â†’
   591â†’1. Fix the bug inline
   592â†’2. Add/update tests to prevent regression
   593â†’3. Verify fix works
   594â†’4. Continue task
   595â†’5. Track in deviations list: `[Rule 1 - Bug] [description]`
   596â†’
   597â†’**No user permission needed.** Bugs must be fixed for correct operation.
   598â†’
   599â†’---
   600â†’
   601â†’**RULE 2: Auto-add missing critical functionality**
   602â†’
   603â†’**Trigger:** Code is missing essential features for correctness, security, or basic operation
   604â†’
   605â†’**Action:** Add immediately, track for Summary
   606â†’
   607â†’**Examples:**
   608â†’
   609â†’- Missing error handling (no try/catch, unhandled promise rejections)
   610â†’- No input validation (accepts malicious data, type coercion issues)
   611â†’- Missing null/undefined checks (crashes on edge cases)
   612â†’- No authentication on protected routes
   613â†’- Missing authorization checks (users can access others' data)
   614â†’- No CSRF protection, missing CORS configuration
   615â†’- No rate limiting on public APIs
   616â†’- Missing required database indexes (causes timeouts)
   617â†’- No logging for errors (can't debug production)
   618â†’
   619â†’**Process:**
   620â†’
   621â†’1. Add the missing functionality inline
   622â†’2. Add tests for the new functionality
   623â†’3. Verify it works
   624â†’4. Continue task
   625â†’5. Track in deviations list: `[Rule 2 - Missing Critical] [description]`
   626â†’
   627â†’**Critical = required for correct/secure/performant operation**
   628â†’**No user permission needed.** These are not "features" - they're requirements for basic correctness.
   629â†’
   630â†’---
   631â†’
   632â†’**RULE 3: Auto-fix blocking issues**
   633â†’
   634â†’**Trigger:** Something prevents you from completing current task
   635â†’
   636â†’**Action:** Fix immediately to unblock, track for Summary
   637â†’
   638â†’**Examples:**
   639â†’
   640â†’- Missing dependency (package not installed, import fails)
   641â†’- Wrong types blocking compilation
   642â†’- Broken import paths (file moved, wrong relative path)
   643â†’- Missing environment variable (app won't start)
   644â†’- Database connection config error
   645â†’- Build configuration error (webpack, tsconfig, etc.)
   646â†’- Missing file referenced in code
   647â†’- Circular dependency blocking module resolution
   648â†’
   649â†’**Process:**
   650â†’
   651â†’1. Fix the blocking issue
   652â†’2. Verify task can now proceed
   653â†’3. Continue task
   654â†’4. Track in deviations list: `[Rule 3 - Blocking] [description]`
   655â†’
   656â†’**No user permission needed.** Can't complete task without fixing blocker.
   657â†’
   658â†’---
   659â†’
   660â†’**RULE 4: Ask about architectural changes**
   661â†’
   662â†’**Trigger:** Fix/addition requires significant structural modification
   663â†’
   664â†’**Action:** STOP, present to user, wait for decision
   665â†’
   666â†’**Examples:**
   667â†’
   668â†’- Adding new database table (not just column)
   669â†’- Major schema changes (changing primary key, splitting tables)
   670â†’- Introducing new service layer or architectural pattern
   671â†’- Switching libraries/frameworks (React â†’ Vue, REST â†’ GraphQL)
   672â†’- Changing authentication approach (sessions â†’ JWT)
   673â†’- Adding new infrastructure (message queue, cache layer, CDN)
   674â†’- Changing API contracts (breaking changes to endpoints)
   675â†’- Adding new deployment environment
   676â†’
   677â†’**Process:**
   678â†’
   679â†’1. STOP current task
   680â†’2. Present clearly:
   681â†’
   682â†’```
   683â†’âš ï¸ Architectural Decision Needed
   684â†’
   685â†’Current task: [task name]
   686â†’Discovery: [what you found that prompted this]
   687â†’Proposed change: [architectural modification]
   688â†’Why needed: [rationale]
   689â†’Impact: [what this affects - APIs, deployment, dependencies, etc.]
   690â†’Alternatives: [other approaches, or "none apparent"]
   691â†’
   692â†’Proceed with proposed change? (yes / different approach / defer)
   693â†’```
   694â†’
   695â†’3. WAIT for user response
   696â†’4. If approved: implement, track as `[Rule 4 - Architectural] [description]`
   697â†’5. If different approach: discuss and implement
   698â†’6. If deferred: log to ISSUES.md, continue without change
   699â†’
   700â†’**User decision required.** These changes affect system design.
   701â†’
   702â†’---
   703â†’
   704â†’**RULE 5: Log non-critical enhancements**
   705â†’
   706â†’**Trigger:** Improvement that would enhance code but isn't essential now
   707â†’
   708â†’**Action:** Add to .planning/ISSUES.md automatically, continue task
   709â†’
   710â†’**Examples:**
   711â†’
   712â†’- Performance optimization (works correctly, just slower than ideal)
   713â†’- Code refactoring (works, but could be cleaner/DRY-er)
   714â†’- Better naming (works, but variables could be clearer)
   715â†’- Organizational improvements (works, but file structure could be better)
   716â†’- Nice-to-have UX improvements (works, but could be smoother)
   717â†’- Additional test coverage beyond basics (basics exist, could be more thorough)
   718â†’- Documentation improvements (code works, docs could be better)
   719â†’- Accessibility enhancements beyond minimum
   720â†’
   721â†’**Process:**
   722â†’
   723â†’1. Create .planning/ISSUES.md if doesn't exist (use `~/.claude/get-shit-done/templates/issues.md`)
   724â†’2. Add entry with ISS-XXX number (auto-increment)
   725â†’3. Brief notification: `ğŸ“‹ Logged enhancement: [brief] (ISS-XXX)`
   726â†’4. Continue task without implementing
   727â†’
   728â†’**No user permission needed.** Logging for future consideration.
   729â†’
   730â†’---
   731â†’
   732â†’**RULE PRIORITY (when multiple could apply):**
   733â†’
   734â†’1. **If Rule 4 applies** â†’ STOP and ask (architectural decision)
   735â†’2. **If Rules 1-3 apply** â†’ Fix automatically, track for Summary
   736â†’3. **If Rule 5 applies** â†’ Log to ISSUES.md, continue
   737â†’4. **If genuinely unsure which rule** â†’ Apply Rule 4 (ask user)
   738â†’
   739â†’**Edge case guidance:**
   740â†’
   741â†’- "This validation is missing" â†’ Rule 2 (critical for security)
   742â†’- "This validation could be better" â†’ Rule 5 (enhancement)
   743â†’- "This crashes on null" â†’ Rule 1 (bug)
   744â†’- "This could be faster" â†’ Rule 5 (enhancement) UNLESS actually timing out â†’ Rule 2 (critical)
   745â†’- "Need to add table" â†’ Rule 4 (architectural)
   746â†’- "Need to add column" â†’ Rule 1 or 2 (depends: fixing bug or adding critical field)
   747â†’
   748â†’**When in doubt:** Ask yourself "Does this affect correctness, security, or ability to complete task?"
   749â†’
   750â†’- YES â†’ Rules 1-3 (fix automatically)
   751â†’- NO â†’ Rule 5 (log it)
   752â†’- MAYBE â†’ Rule 4 (ask user)
   753â†’
   754â†’</deviation_rules>
   755â†’
   756â†’<deviation_documentation>
   757â†’
   758â†’## Documenting Deviations in Summary
   759â†’
   760â†’After all tasks complete, Summary MUST include deviations section.
   761â†’
   762â†’**If no deviations:**
   763â†’
   764â†’```markdown
   765â†’## Deviations from Plan
   766â†’
   767â†’None - plan executed exactly as written.
   768â†’```
   769â†’
   770â†’**If deviations occurred:**
   771â†’
   772â†’```markdown
   773â†’## Deviations from Plan
   774â†’
   775â†’### Auto-fixed Issues
   776â†’
   777â†’**1. [Rule 1 - Bug] Fixed case-sensitive email uniqueness constraint**
   778â†’
   779â†’- **Found during:** Task 4 (Follow/unfollow API implementation)
   780â†’- **Issue:** User.email unique constraint was case-sensitive - Test@example.com and test@example.com were both allowed, causing duplicate accounts
   781â†’- **Fix:** Changed to `CREATE UNIQUE INDEX users_email_unique ON users (LOWER(email))`
   782â†’- **Files modified:** src/models/User.ts, migrations/003_fix_email_unique.sql
   783â†’- **Verification:** Unique constraint test passes - duplicate emails properly rejected
   784â†’- **Commit:** abc123f
   785â†’
   786â†’**2. [Rule 2 - Missing Critical] Added JWT expiry validation to auth middleware**
   787â†’
   788â†’- **Found during:** Task 3 (Protected route implementation)
   789â†’- **Issue:** Auth middleware wasn't checking token expiry - expired tokens were being accepted
   790â†’- **Fix:** Added exp claim validation in middleware, reject with 401 if expired
   791â†’- **Files modified:** src/middleware/auth.ts, src/middleware/auth.test.ts
   792â†’- **Verification:** Expired token test passes - properly rejects with 401
   793â†’- **Commit:** def456g
   794â†’
   795â†’### Deferred Enhancements
   796â†’
   797â†’Logged to .planning/ISSUES.md for future consideration:
   798â†’
   799â†’- ISS-001: Refactor UserService into smaller modules (discovered in Task 3)
   800â†’- ISS-002: Add connection pooling for Redis (discovered in Task 6)
   801â†’
   802â†’---
   803â†’
   804â†’**Total deviations:** 4 auto-fixed (1 bug, 1 missing critical, 1 blocking, 1 architectural with approval), 3 deferred
   805â†’**Impact on plan:** All auto-fixes necessary for correctness/security/performance. No scope creep.
   806â†’```
   807â†’
   808â†’**This provides complete transparency:**
   809â†’
   810â†’- Every deviation documented
   811â†’- Why it was needed
   812â†’- What rule applied
   813â†’- What was done
   814â†’- User can see exactly what happened beyond the plan
   815â†’
   816â†’</deviation_documentation>
   817â†’
   818â†’<tdd_plan_execution>
   819â†’## TDD Plan Execution
   820â†’
   821â†’When executing a plan with `type: tdd` in frontmatter, follow the RED-GREEN-REFACTOR cycle for the single feature defined in the plan.
   822â†’
   823â†’**1. Check test infrastructure (if first TDD plan):**
   824â†’If no test framework configured:
   825â†’- Detect project type from package.json/requirements.txt/etc.
   826â†’- Install minimal test framework (Jest, pytest, Go testing, etc.)
   827â†’- Create test config file
   828â†’- Verify: run empty test suite
   829â†’- This is part of the RED phase, not a separate task
   830â†’
   831â†’**2. RED - Write failing test:**
   832â†’- Read `<behavior>` element for test specification
   833â†’- Create test file if doesn't exist (follow project conventions)
   834â†’- Write test(s) that describe expected behavior
   835â†’- Run tests - MUST fail (if passes, test is wrong or feature exists)
   836â†’- Commit: `test({phase}-{plan}): add failing test for [feature]`
   837â†’
   838â†’**3. GREEN - Implement to pass:**
   839â†’- Read `<implementation>` element for guidance
   840â†’- Write minimal code to make test pass
   841â†’- Run tests - MUST pass
   842â†’- Commit: `feat({phase}-{plan}): implement [feature]`
   843â†’
   844â†’**4. REFACTOR (if needed):**
   845â†’- Clean up code if obvious improvements
   846â†’- Run tests - MUST still pass
   847â†’- Commit only if changes made: `refactor({phase}-{plan}): clean up [feature]`
   848â†’
   849â†’**Commit pattern for TDD plans:**
   850â†’Each TDD plan produces 2-3 atomic commits:
   851â†’1. `test({phase}-{plan}): add failing test for X`
   852â†’2. `feat({phase}-{plan}): implement X`
   853â†’3. `refactor({phase}-{plan}): clean up X` (optional)
   854â†’
   855â†’**Error handling:**
   856â†’- If test doesn't fail in RED phase: Test is wrong or feature already exists. Investigate before proceeding.
   857â†’- If test doesn't pass in GREEN phase: Debug implementation, keep iterating until green.
   858â†’- If tests fail in REFACTOR phase: Undo refactor, commit was premature.
   859â†’
   860â†’**Verification:**
   861â†’After TDD plan completion, ensure:
   862â†’- All tests pass
   863â†’- Test coverage for the new behavior exists
   864â†’- No unrelated tests broken
   865â†’
   866â†’**Why TDD uses dedicated plans:** TDD requires 2-3 execution cycles (RED â†’ GREEN â†’ REFACTOR), each with file reads, test runs, and potential debugging. This consumes 40-50% of context for a single feature. Dedicated plans ensure full quality throughout the cycle.
   867â†’
   868â†’**Comparison:**
   869â†’- Standard plans: Multiple tasks, 1 commit per task, 2-4 commits total
   870â†’- TDD plans: Single feature, 2-3 commits for RED/GREEN/REFACTOR cycle
   871â†’
   872â†’See `~/.claude/get-shit-done/references/tdd.md` for TDD plan structure.
   873â†’</tdd_plan_execution>
   874â†’
   875â†’<task_commit>
   876â†’## Task Commit Protocol
   877â†’
   878â†’After each task completes (verification passed, done criteria met), commit immediately:
   879â†’
   880â†’**1. Identify modified files:**
   881â†’
   882â†’Track files changed during this specific task (not the entire plan):
   883â†’
   884â†’```bash
   885â†’git status --short
   886â†’```
   887â†’
   888â†’**2. Stage only task-related files:**
   889â†’
   890â†’Stage each file individually (NEVER use `git add .` or `git add -A`):
   891â†’
   892â†’```bash
   893â†’# Example - adjust to actual files modified by this task
   894â†’git add src/api/auth.ts
   895â†’git add src/types/user.ts
   896â†’```
   897â†’
   898â†’**3. Determine commit type:**
   899â†’
   900â†’| Type | When to Use | Example |
   901â†’|------|-------------|---------|
   902â†’| `feat` | New feature, endpoint, component, functionality | feat(08-02): create user registration endpoint |
   903â†’| `fix` | Bug fix, error correction | fix(08-02): correct email validation regex |
   904â†’| `test` | Test-only changes (TDD RED phase) | test(08-02): add failing test for password hashing |
   905â†’| `refactor` | Code cleanup, no behavior change (TDD REFACTOR phase) | refactor(08-02): extract validation to helper |
   906â†’| `perf` | Performance improvement | perf(08-02): add database index for user lookups |
   907â†’| `docs` | Documentation changes | docs(08-02): add API endpoint documentation |
   908â†’| `style` | Formatting, linting fixes | style(08-02): format auth module |
   909â†’| `chore` | Config, tooling, dependencies | chore(08-02): add bcrypt dependency |
   910â†’
   911â†’**4. Craft commit message:**
   912â†’
   913â†’Format: `{type}({phase}-{plan}): {task-name-or-description}`
   914â†’
   915â†’```bash
   916â†’git commit -m "{type}({phase}-{plan}): {concise task description}
   917â†’
   918â†’- {key change 1}
   919â†’- {key change 2}
   920â†’- {key change 3}
   921â†’"
   922â†’```
   923â†’
   924â†’**Examples:**
   925â†’
   926â†’```bash
   927â†’# Standard plan task
   928â†’git commit -m "feat(08-02): create user registration endpoint
   929â†’
   930â†’- POST /auth/register validates email and password
   931â†’- Checks for duplicate users
   932â†’- Returns JWT token on success
   933â†’"
   934â†’
   935â†’# Another standard task
   936â†’git commit -m "fix(08-02): correct email validation regex
   937â†’
   938â†’- Fixed regex to accept plus-addressing
   939â†’- Added tests for edge cases
   940â†’"
   941â†’```
   942â†’
   943â†’**Note:** TDD plans have their own commit pattern (test/feat/refactor for RED/GREEN/REFACTOR phases). See `<tdd_plan_execution>` section above.
   944â†’
   945â†’**5. Record commit hash:**
   946â†’
   947â†’After committing, capture hash for SUMMARY.md:
   948â†’
   949â†’```bash
   950â†’TASK_COMMIT=$(git rev-parse --short HEAD)
   951â†’echo "Task ${TASK_NUM} committed: ${TASK_COMMIT}"
   952â†’```
   953â†’
   954â†’Store in array or list for SUMMARY generation:
   955â†’```bash
   956â†’TASK_COMMITS+=("Task ${TASK_NUM}: ${TASK_COMMIT}")
   957â†’```
   958â†’
   959â†’**Atomic commit benefits:**
   960â†’- Each task independently revertable
   961â†’- Git bisect finds exact failing task
   962â†’- Git blame traces line to specific task context
   963â†’- Clear history for Claude in future sessions
   964â†’- Better observability for AI-automated workflow
   965â†’
   966â†’</task_commit>
   967â†’
   968â†’<step name="checkpoint_protocol">
   969â†’When encountering `type="checkpoint:*"`:
   970â†’
   971â†’**Critical: Claude automates everything with CLI/API before checkpoints.** Checkpoints are for verification and decisions, not manual work.
   972â†’
   973â†’**Display checkpoint clearly:**
   974â†’
   975â†’```
   976â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   977â†’CHECKPOINT: [Type]
   978â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   979â†’
   980â†’Task [X] of [Y]: [Action/What-Built/Decision]
   981â†’
   982â†’[Display task-specific content based on type]
   983â†’
   984â†’[Resume signal instruction]
   985â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   986â†’```
   987â†’
   988â†’**For checkpoint:human-verify (90% of checkpoints):**
   989â†’
   990â†’```
   991â†’I automated: [what was automated - deployed, built, configured]
   992â†’
   993â†’How to verify:
   994â†’1. [Step 1 - exact command/URL]
   995â†’2. [Step 2 - what to check]
   996â†’3. [Step 3 - expected behavior]
   997â†’
   998â†’[Resume signal - e.g., "Type 'approved' or describe issues"]
   999â†’```
  1000â†’
  1001â†’**For checkpoint:decision (9% of checkpoints):**
  1002â†’
  1003â†’```
  1004â†’Decision needed: [decision]
  1005â†’
  1006â†’Context: [why this matters]
  1007â†’
  1008â†’Options:
  1009â†’1. [option-id]: [name]
  1010â†’   Pros: [pros]
  1011â†’   Cons: [cons]
  1012â†’
  1013â†’2. [option-id]: [name]
  1014â†’   Pros: [pros]
  1015â†’   Cons: [cons]
  1016â†’
  1017â†’[Resume signal - e.g., "Select: option-id"]
  1018â†’```
  1019â†’
  1020â†’**For checkpoint:human-action (1% - rare, only for truly unavoidable manual steps):**
  1021â†’
  1022â†’```
  1023â†’I automated: [what Claude already did via CLI/API]
  1024â†’
  1025â†’Need your help with: [the ONE thing with no CLI/API - email link, 2FA code]
  1026â†’
  1027â†’Instructions:
  1028â†’[Single unavoidable step]
  1029â†’
  1030â†’I'll verify after: [verification]
  1031â†’
  1032â†’[Resume signal - e.g., "Type 'done' when complete"]
  1033â†’```
  1034â†’
  1035â†’**After displaying:** WAIT for user response. Do NOT hallucinate completion. Do NOT continue to next task.
  1036â†’
  1037â†’**After user responds:**
  1038â†’
  1039â†’- Run verification if specified (file exists, env var set, tests pass, etc.)
  1040â†’- If verification passes or N/A: continue to next task
  1041â†’- If verification fails: inform user, wait for resolution
  1042â†’
  1043â†’See ~/.claude/get-shit-done/references/checkpoints.md for complete checkpoint guidance.
  1044â†’</step>
  1045â†’
  1046â†’<step name="verification_failure_gate">
  1047â†’If any task verification fails:
  1048â†’
  1049â†’STOP. Do not continue to next task.
  1050â†’
  1051â†’Present inline:
  1052â†’"Verification failed for Task [X]: [task name]
  1053â†’
  1054â†’Expected: [verification criteria]
  1055â†’Actual: [what happened]
  1056â†’
  1057â†’How to proceed?
  1058â†’
  1059â†’1. Retry - Try the task again
  1060â†’2. Skip - Mark as incomplete, continue
  1061â†’3. Stop - Pause execution, investigate"
  1062â†’
  1063â†’Wait for user decision.
  1064â†’
  1065â†’If user chose "Skip", note it in SUMMARY.md under "Issues Encountered".
  1066â†’</step>
  1067â†’
  1068â†’<step name="record_completion_time">
  1069â†’Record execution end time and calculate duration:
  1070â†’
  1071â†’```bash
  1072â†’PLAN_END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  1073â†’PLAN_END_EPOCH=$(date +%s)
  1074â†’
  1075â†’DURATION_SEC=$(( PLAN_END_EPOCH - PLAN_START_EPOCH ))
  1076â†’DURATION_MIN=$(( DURATION_SEC / 60 ))
  1077â†’
  1078â†’if [[ $DURATION_MIN -ge 60 ]]; then
  1079â†’  HRS=$(( DURATION_MIN / 60 ))
  1080â†’  MIN=$(( DURATION_MIN % 60 ))
  1081â†’  DURATION="${HRS}h ${MIN}m"
  1082â†’else
  1083â†’  DURATION="${DURATION_MIN} min"
  1084â†’fi
  1085â†’```
  1086â†’
  1087â†’Pass timing data to SUMMARY.md creation.
  1088â†’</step>
  1089â†’
  1090â†’<step name="quality_gate">
  1091â†’**PAI Judge Integration: Evaluate output quality before SUMMARY creation.**
  1092â†’
  1093â†’Reference: `~/.claude/Skills/CORE/workflows/GSDQualityGate.md`
  1094â†’
  1095â†’**This gate combines GSD deviation rules (already applied during execution) with PAI judge evaluation.**
  1096â†’
  1097â†’**1. Quick assessment:**
  1098â†’- Did all tasks complete successfully?
  1099â†’- Were deviations handled appropriately (auto-fix vs ask)?
  1100â†’- Do commits exist for each task?
  1101â†’
  1102â†’**2. Output quality check (FM2, FM4, FM7):**
  1103â†’
  1104â†’- **FM2 (Assertion without demonstration):** Are accomplishments backed by evidence (commits, tests)?
  1105â†’- **FM4 (Confidence-calibration):** Are uncertain outcomes stated with appropriate hedging?
  1106â†’- **FM7 (Confidence games):** Any claims that can't be traced to primary source?
  1107â†’
  1108â†’**3. Verdict:**
  1109â†’
  1110â†’**PASS:** Continue to create_summary
  1111â†’- Implementation matches plan intent
  1112â†’- Evidence trail complete (commits for each task)
  1113â†’- No unsubstantiated claims
  1114â†’
  1115â†’**REVISE:** Re-execute specific failing tasks (max 2 cycles)
  1116â†’- Specific weaknesses identified
  1117â†’- Return to execute step for targeted fixes
  1118â†’- Then re-evaluate
  1119â†’
  1120â†’**REJECT:** Escalate to user (equivalent to architectural deviation)
  1121â†’- Fundamental approach issue discovered
  1122â†’- Present to user:
  1123â†’  ```
  1124â†’  âš ï¸ Quality Gate: Plan Requires Rework
  1125â†’
  1126â†’  Issue: [what failed the check]
  1127â†’  Why: [fundamental problem with approach]
  1128â†’
  1129â†’  Options:
  1130â†’  1. Reformulate plan with different approach
  1131â†’  2. Override gate and accept as-is
  1132â†’  3. Pause and investigate
  1133â†’  ```
  1134â†’- Wait for user decision
  1135â†’
  1136â†’**4. Gate bypass conditions:**
  1137â†’- config.json mode is "yolo" AND plan has `skip-quality-gate: true` in frontmatter
  1138â†’- User previously said "skip judge" or "no gate" this session
  1139â†’- Plan is purely mechanical (config changes, dependency updates)
  1140â†’
  1141â†’**5. Document gate result:**
  1142â†’Store verdict for SUMMARY.md:
  1143â†’```
  1144â†’QUALITY_VERDICT="PASS"  # or "PASS after revision" or "Overridden by user"
  1145â†’```
  1146â†’
  1147â†’</step>
  1148â†’
  1149â†’<step name="create_summary">
  1150â†’Create `{phase}-{plan}-SUMMARY.md` as specified in the prompt's `<output>` section.
  1151â†’Use ~/.claude/get-shit-done/templates/summary.md for structure.
  1152â†’
  1153â†’**File location:** `.planning/phases/XX-name/{phase}-{plan}-SUMMARY.md`
  1154â†’
  1155â†’**Frontmatter population:**
  1156â†’
  1157â†’Before writing summary content, populate frontmatter fields from execution context:
  1158â†’
  1159â†’1. **Basic identification:**
  1160â†’   - phase: From PLAN.md frontmatter
  1161â†’   - plan: From PLAN.md frontmatter
  1162â†’   - subsystem: Categorize based on phase focus (auth, payments, ui, api, database, infra, testing, etc.)
  1163â†’   - tags: Extract tech keywords (libraries, frameworks, tools used)
  1164â†’
  1165â†’2. **Dependency graph:**
  1166â†’   - requires: List prior phases this built upon (check PLAN.md context section for referenced prior summaries)
  1167â†’   - provides: Extract from accomplishments - what was delivered
  1168â†’   - affects: Infer from phase description/goal what future phases might need this
  1169â†’
  1170â†’3. **Tech tracking:**
  1171â†’   - tech-stack.added: New libraries from package.json changes or requirements
  1172â†’   - tech-stack.patterns: Architectural patterns established (from decisions/accomplishments)
  1173â†’
  1174â†’4. **File tracking:**
  1175â†’   - key-files.created: From "Files Created/Modified" section
  1176â†’   - key-files.modified: From "Files Created/Modified" section
  1177â†’
  1178â†’5. **Decisions:**
  1179â†’   - key-decisions: Extract from "Decisions Made" section
  1180â†’
  1181â†’6. **Issues:**
  1182â†’   - issues-created: Check if ISSUES.md was updated during execution
  1183â†’
  1184â†’7. **Metrics:**
  1185â†’   - duration: From $DURATION variable
  1186â†’   - completed: From $PLAN_END_TIME (date only, format YYYY-MM-DD)
  1187â†’
  1188â†’Note: If subsystem/affects are unclear, use best judgment based on phase name and accomplishments. Can be refined later.
  1189â†’
  1190â†’**Title format:** `# Phase [X] Plan [Y]: [Name] Summary`
  1191â†’
  1192â†’The one-liner must be SUBSTANTIVE:
  1193â†’
  1194â†’- Good: "JWT auth with refresh rotation using jose library"
  1195â†’- Bad: "Authentication implemented"
  1196â†’
  1197â†’**Include performance data:**
  1198â†’
  1199â†’- Duration: `$DURATION`
  1200â†’- Started: `$PLAN_START_TIME`
  1201â†’- Completed: `$PLAN_END_TIME`
  1202â†’- Tasks completed: (count from execution)
  1203â†’- Files modified: (count from execution)
  1204â†’
  1205â†’**Next Step section:**
  1206â†’
  1207â†’- If more plans exist in this phase: "Ready for {phase}-{next-plan}-PLAN.md"
  1208â†’- If this is the last plan: "Phase complete, ready for transition"
  1209â†’  </step>
  1210â†’
  1211â†’<step name="update_current_position">
  1212â†’Update Current Position section in STATE.md to reflect plan completion.
  1213â†’
  1214â†’**Format:**
  1215â†’
  1216â†’```markdown
  1217â†’Phase: [current] of [total] ([phase name])
  1218â†’Plan: [just completed] of [total in phase]
  1219â†’Status: [In progress / Phase complete]
  1220â†’Last activity: [today] - Completed {phase}-{plan}-PLAN.md
  1221â†’
  1222â†’Progress: [progress bar]
  1223â†’```
  1224â†’
  1225â†’**Calculate progress bar:**
  1226â†’
  1227â†’- Count total plans across all phases (from ROADMAP.md or ROADMAP.md)
  1228â†’- Count completed plans (count SUMMARY.md files that exist)
  1229â†’- Progress = (completed / total) Ã— 100%
  1230â†’- Render: â–‘ for incomplete, â–ˆ for complete
  1231â†’
  1232â†’**Example - completing 02-01-PLAN.md (plan 5 of 10 total):**
  1233â†’
  1234â†’Before:
  1235â†’
  1236â†’```markdown
  1237â†’## Current Position
  1238â†’
  1239â†’Phase: 2 of 4 (Authentication)
  1240â†’Plan: Not started
  1241â†’Status: Ready to execute
  1242â†’Last activity: 2025-01-18 - Phase 1 complete
  1243â†’
  1244â†’Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 40%
  1245â†’```
  1246â†’
  1247â†’After:
  1248â†’
  1249â†’```markdown
  1250â†’## Current Position
  1251â†’
  1252â†’Phase: 2 of 4 (Authentication)
  1253â†’Plan: 1 of 2 in current phase
  1254â†’Status: In progress
  1255â†’Last activity: 2025-01-19 - Completed 02-01-PLAN.md
  1256â†’
  1257â†’Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 50%
  1258â†’```
  1259â†’
  1260â†’**Step complete when:**
  1261â†’
  1262â†’- [ ] Phase number shows current phase (X of total)
  1263â†’- [ ] Plan number shows plans complete in current phase (N of total-in-phase)
  1264â†’- [ ] Status reflects current state (In progress / Phase complete)
  1265â†’- [ ] Last activity shows today's date and the plan just completed
  1266â†’- [ ] Progress bar calculated correctly from total completed plans
  1267â†’      </step>
  1268â†’
  1269â†’<step name="extract_decisions_and_issues">
  1270â†’Extract decisions, issues, and concerns from SUMMARY.md into STATE.md accumulated context.
  1271â†’
  1272â†’**Decisions Made:**
  1273â†’
  1274â†’- Read SUMMARY.md "## Decisions Made" section
  1275â†’- If content exists (not "None"):
  1276â†’  - Add each decision to STATE.md Decisions table
  1277â†’  - Format: `| [phase number] | [decision summary] | [rationale] |`
  1278â†’
  1279â†’**Deferred Issues:**
  1280â†’
  1281â†’- Read SUMMARY.md to check if new issues were logged to ISSUES.md
  1282â†’- If new ISS-XXX entries created:
  1283â†’  - Update STATE.md "Deferred Issues" section
  1284â†’
  1285â†’**Blockers/Concerns:**
  1286â†’
  1287â†’- Read SUMMARY.md "## Next Phase Readiness" section
  1288â†’- If contains blockers or concerns:
  1289â†’  - Add to STATE.md "Blockers/Concerns Carried Forward"
  1290â†’    </step>
  1291â†’
  1292â†’<step name="update_session_continuity">
  1293â†’Update Session Continuity section in STATE.md to enable resumption in future sessions.
  1294â†’
  1295â†’**Format:**
  1296â†’
  1297â†’```markdown
  1298â†’Last session: [current date and time]
  1299â†’Stopped at: Completed {phase}-{plan}-PLAN.md
  1300â†’Resume file: [path to .continue-here if exists, else "None"]
  1301â†’```
  1302â†’
  1303â†’**Size constraint note:** Keep STATE.md under 150 lines total.
  1304â†’</step>
  1305â†’
  1306â†’<step name="issues_review_gate">
  1307â†’Before proceeding, check SUMMARY.md content.
  1308â†’
  1309â†’If "Issues Encountered" is NOT "None":
  1310â†’
  1311â†’<if mode="yolo">
  1312â†’```
  1313â†’âš¡ Auto-approved: Issues acknowledgment
  1314â†’âš ï¸ Note: Issues were encountered during execution:
  1315â†’- [Issue 1]
  1316â†’- [Issue 2]
  1317â†’(Logged - continuing in yolo mode)
  1318â†’```
  1319â†’
  1320â†’Continue without waiting.
  1321â†’</if>
  1322â†’
  1323â†’<if mode="interactive" OR="custom with gates.issues_review true">
  1324â†’Present issues and wait for acknowledgment before proceeding.
  1325â†’</if>
  1326â†’</step>
  1327â†’
  1328â†’<step name="update_roadmap">
  1329â†’Update the roadmap file:
  1330â†’
  1331â†’```bash
  1332â†’ROADMAP_FILE=".planning/ROADMAP.md"
  1333â†’```
  1334â†’
  1335â†’**If more plans remain in this phase:**
  1336â†’
  1337â†’- Update plan count: "2/3 plans complete"
  1338â†’- Keep phase status as "In progress"
  1339â†’
  1340â†’**If this was the last plan in the phase:**
  1341â†’
  1342â†’- Mark phase complete: status â†’ "Complete"
  1343â†’- Add completion date
  1344â†’  </step>
  1345â†’
  1346â†’<step name="git_commit_metadata">
  1347â†’Commit execution metadata (SUMMARY + STATE + ROADMAP):
  1348â†’
  1349â†’**Note:** All task code has already been committed during execution (one commit per task).
  1350â†’PLAN.md was already committed during plan-phase. This final commit captures execution results only.
  1351â†’
  1352â†’**1. Stage execution artifacts:**
  1353â†’
  1354â†’```bash
  1355â†’git add .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1356â†’git add .planning/STATE.md
  1357â†’```
  1358â†’
  1359â†’**2. Stage roadmap file:**
  1360â†’
  1361â†’```bash
  1362â†’git add .planning/ROADMAP.md
  1363â†’```
  1364â†’
  1365â†’**3. Verify staging:**
  1366â†’
  1367â†’```bash
  1368â†’git status
  1369â†’# Should show only execution artifacts (SUMMARY, STATE, ROADMAP), no code files
  1370â†’```
  1371â†’
  1372â†’**4. Commit metadata:**
  1373â†’
  1374â†’```bash
  1375â†’git commit -m "$(cat <<'EOF'
  1376â†’docs({phase}-{plan}): complete [plan-name] plan
  1377â†’
  1378â†’Tasks completed: [N]/[N]
  1379â†’- [Task 1 name]
  1380â†’- [Task 2 name]
  1381â†’- [Task 3 name]
  1382â†’
  1383â†’SUMMARY: .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1384â†’EOF
  1385â†’)"
  1386â†’```
  1387â†’
  1388â†’**Example:**
  1389â†’
  1390â†’```bash
  1391â†’git commit -m "$(cat <<'EOF'
  1392â†’docs(08-02): complete user registration plan
  1393â†’
  1394â†’Tasks completed: 3/3
  1395â†’- User registration endpoint
  1396â†’- Password hashing with bcrypt
  1397â†’- Email confirmation flow
  1398â†’
  1399â†’SUMMARY: .planning/phases/08-user-auth/08-02-registration-SUMMARY.md
  1400â†’EOF
  1401â†’)"
  1402â†’```
  1403â†’
  1404â†’**Git log after plan execution:**
  1405â†’
  1406â†’```
  1407â†’abc123f docs(08-02): complete user registration plan
  1408â†’def456g feat(08-02): add email confirmation flow
  1409â†’hij789k feat(08-02): implement password hashing with bcrypt
  1410â†’lmn012o feat(08-02): create user registration endpoint
  1411â†’```
  1412â†’
  1413â†’Each task has its own commit, followed by one metadata commit documenting plan completion.
  1414â†’
  1415â†’For commit message conventions, see ~/.claude/get-shit-done/references/git-integration.md
  1416â†’</step>
  1417â†’
  1418â†’<step name="update_codebase_map">
  1419â†’**If .planning/codebase/ exists:**
  1420â†’
  1421â†’Check what changed across all task commits in this plan:
  1422â†’
  1423â†’```bash
  1424â†’# Find first task commit (right after previous plan's docs commit)
  1425â†’FIRST_TASK=$(git log --oneline --grep="feat({phase}-{plan}):" --grep="fix({phase}-{plan}):" --grep="test({phase}-{plan}):" --reverse | head -1 | cut -d' ' -f1)
  1426â†’
  1427â†’# Get all changes from first task through now
  1428â†’git diff --name-only ${FIRST_TASK}^..HEAD 2>/dev/null
  1429â†’```
  1430â†’
  1431â†’**Update only if structural changes occurred:**
  1432â†’
  1433â†’| Change Detected | Update Action |
  1434â†’|-----------------|---------------|
  1435â†’| New directory in src/ | STRUCTURE.md: Add to directory layout |
  1436â†’| package.json deps changed | STACK.md: Add/remove from dependencies list |
  1437â†’| New file pattern (e.g., first .test.ts) | CONVENTIONS.md: Note new pattern |
  1438â†’| New external API client | INTEGRATIONS.md: Add service entry with file path |
  1439â†’| Config file added/changed | STACK.md: Update configuration section |
  1440â†’| File renamed/moved | Update paths in relevant docs |
  1441â†’
  1442â†’**Skip update if only:**
  1443â†’- Code changes within existing files
  1444â†’- Bug fixes
  1445â†’- Content changes (no structural impact)
  1446â†’
  1447â†’**Update format:**
  1448â†’Make single targeted edits - add a bullet point, update a path, or remove a stale entry. Don't rewrite sections.
  1449â†’
  1450â†’```bash
  1451â†’git add .planning/codebase/*.md
  1452â†’git commit --amend --no-edit  # Include in metadata commit
  1453â†’```
  1454â†’
  1455â†’**If .planning/codebase/ doesn't exist:**
  1456â†’Skip this step.
  1457â†’</step>
  1458â†’
  1459â†’<step name="check_phase_issues">
  1460â†’**Check if issues were created during this phase:**
  1461â†’
  1462â†’```bash
  1463â†’# Check if ISSUES.md exists and has issues from current phase
  1464â†’if [ -f .planning/ISSUES.md ]; then
  1465â†’  grep -E "Phase ${PHASE}.*Task" .planning/ISSUES.md | grep -v "^#" || echo "NO_ISSUES_THIS_PHASE"
  1466â†’fi
  1467â†’```
  1468â†’
  1469â†’**If issues were created during this phase:**
  1470â†’
  1471â†’```
  1472â†’ğŸ“‹ Issues logged during this phase:
  1473â†’- ISS-XXX: [brief description]
  1474â†’- ISS-YYY: [brief description]
  1475â†’
  1476â†’Review these now?
  1477â†’```
  1478â†’
  1479â†’Use AskUserQuestion:
  1480â†’- header: "Phase Issues"
  1481â†’- question: "[N] issues were logged during this phase. Review now?"
  1482â†’- options:
  1483â†’  - "Review issues" - Analyze with /gsd:consider-issues
  1484â†’  - "Continue" - Address later, proceed to next work
  1485â†’
  1486â†’**If "Review issues" selected:**
  1487â†’- Invoke: `SlashCommand("/gsd:consider-issues")`
  1488â†’- After consider-issues completes, return to offer_next
  1489â†’
  1490â†’**If "Continue" selected or no issues found:**
  1491â†’- Proceed to offer_next step
  1492â†’
  1493â†’**In YOLO mode:**
  1494â†’- Note issues were logged but don't prompt: `ğŸ“‹ [N] issues logged this phase (review later with /gsd:consider-issues)`
  1495â†’- Continue to offer_next automatically
  1496â†’</step>
  1497â†’
  1498â†’<step name="offer_next">
  1499â†’**First, determine if more plans exist in this phase:**
  1500â†’
  1501â†’```bash
  1502â†’# Get current phase directory from the plan we just executed
  1503â†’PHASE_DIR=$(dirname "$PLAN_PATH")
  1504â†’
  1505â†’# Count PLAN files vs SUMMARY files
  1506â†’PLAN_COUNT=$(ls "$PHASE_DIR"/*-PLAN.md 2>/dev/null | wc -l | tr -d ' ')
  1507â†’SUMMARY_COUNT=$(ls "$PHASE_DIR"/*-SUMMARY.md 2>/dev/null | wc -l | tr -d ' ')
  1508â†’
  1509â†’echo "Plans: $PLAN_COUNT, Summaries: $SUMMARY_COUNT"
  1510â†’
  1511â†’if [[ $SUMMARY_COUNT -lt $PLAN_COUNT ]]; then
  1512â†’  echo "MORE_PLANS_EXIST"
  1513â†’else
  1514â†’  echo "PHASE_COMPLETE"
  1515â†’fi
  1516â†’```
  1517â†’
  1518â†’**If MORE_PLANS_EXIST (more plans in this phase):**
  1519â†’
  1520â†’<if mode="yolo">
  1521â†’```
  1522â†’Plan {phase}-{plan} complete.
  1523â†’Summary: .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1524â†’
  1525â†’[X] of [Y] plans complete for Phase Z.
  1526â†’
  1527â†’âš¡ Auto-continuing: Execute next plan ({phase}-{next-plan})
  1528â†’```
  1529â†’
  1530â†’Loop back to identify_plan step automatically.
  1531â†’</if>
  1532â†’
  1533â†’<if mode="interactive" OR="custom with gates.execute_next_plan true">
  1534â†’```
  1535â†’Plan {phase}-{plan} complete.
  1536â†’Summary: .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1537â†’
  1538â†’[X] of [Y] plans complete for Phase Z.
  1539â†’
  1540â†’---
  1541â†’
  1542â†’## â–¶ Next Up
  1543â†’
  1544â†’**{phase}-{next-plan}: [Plan Name]** â€” [objective from next PLAN.md]
  1545â†’
  1546â†’`/gsd:execute-plan .planning/phases/XX-name/{phase}-{next-plan}-PLAN.md`
  1547â†’
  1548â†’<sub>`/clear` first â†’ fresh context window</sub>
  1549â†’
  1550â†’---
  1551â†’
  1552â†’**Also available:**
  1553â†’- Review what was built before continuing
  1554â†’
  1555â†’---
  1556â†’```
  1557â†’
  1558â†’Wait for user to clear and run next command.
  1559â†’</if>
  1560â†’
  1561â†’**If phase complete (last plan done):**
  1562â†’
  1563â†’First, check if this is also the last phase in the milestone (milestone complete):
  1564â†’
  1565â†’```bash
  1566â†’# Count total phases in ROADMAP.md
  1567â†’TOTAL_PHASES=$(grep -c "^### Phase [0-9]" .planning/ROADMAP.md)
  1568â†’
  1569â†’# Get current phase number from the just-completed plan
  1570â†’CURRENT_PHASE=$(echo "{phase}" | grep -oE '^[0-9]+')
  1571â†’
  1572â†’# Check if current phase == total phases
  1573â†’if [[ "$CURRENT_PHASE" -eq "$TOTAL_PHASES" ]]; then
  1574â†’  # Milestone complete
  1575â†’  MILESTONE_COMPLETE=true
  1576â†’fi
  1577â†’```
  1578â†’
  1579â†’**If milestone complete (final phase of roadmap done):**
  1580â†’
  1581â†’```
  1582â†’ğŸ‰ MILESTONE COMPLETE!
  1583â†’
  1584â†’Plan {phase}-{plan} complete.
  1585â†’Summary: .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1586â†’
  1587â†’Phase [Z]: [Name] COMPLETE - all [Y] plans finished.
  1588â†’
  1589â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1590â†’All [N] phases complete!
  1591â†’This milestone is 100% done.
  1592â†’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1593â†’
  1594â†’---
  1595â†’
  1596â†’## â–¶ Next Up
  1597â†’
  1598â†’**Complete Milestone** â€” archive and prepare for next
  1599â†’
  1600â†’`/gsd:complete-milestone`
  1601â†’
  1602â†’<sub>`/clear` first â†’ fresh context window</sub>
  1603â†’
  1604â†’---
  1605â†’
  1606â†’**Also available:**
  1607â†’- `/gsd:add-phase <description>` â€” add another phase
  1608â†’- Review accomplishments before archiving
  1609â†’
  1610â†’---
  1611â†’```
  1612â†’
  1613â†’**If phase complete but more phases remain:**
  1614â†’
  1615â†’```
  1616â†’Plan {phase}-{plan} complete.
  1617â†’Summary: .planning/phases/XX-name/{phase}-{plan}-SUMMARY.md
  1618â†’
  1619â†’## âœ“ Phase [Z] Complete
  1620â†’
  1621â†’All [Y] plans finished.
  1622â†’
  1623â†’---
  1624â†’
  1625â†’## â–¶ Next Up
  1626â†’
  1627â†’**Phase [X+1]: [Name]** â€” [Goal from ROADMAP.md]
  1628â†’
  1629â†’`/gsd:plan-phase [X+1]`
  1630â†’
  1631â†’<sub>`/clear` first â†’ fresh context window</sub>
  1632â†’
  1633â†’---
  1634â†’
  1635â†’**Also available:**
  1636â†’- `/gsd:discuss-phase [X+1]` â€” gather context first
  1637â†’- `/gsd:research-phase [X+1]` â€” investigate unknowns
  1638â†’- Review phase accomplishments before continuing
  1639â†’
  1640â†’---
  1641â†’```
  1642â†’
  1643â†’</step>
  1644â†’
  1645â†’</process>
  1646â†’
  1647â†’<success_criteria>
  1648â†’
  1649â†’- All tasks from PLAN.md completed
  1650â†’- All verifications pass
  1651â†’- SUMMARY.md created with substantive content
  1652â†’- STATE.md updated (position, decisions, issues, session)
  1653â†’- ROADMAP.md updated
  1654â†’- If codebase map exists: map updated with execution changes (or skipped if no significant changes)
  1655â†’  </success_criteria>
  1656â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
